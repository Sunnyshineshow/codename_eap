<div class="md-range-event" mbsc-form>
  <div class="md-header" style="padding:8px 0px 14px 0px;margin:0px;background-color:#206eb8;">
    <div class="mbsc-header-txt mbsc-align-center">
      <div class="mbsc-align-center" style="margin-top:8px;">
        <p style="padding:0px 5px;margin:0px;font-weight:400;font-size: 1.5rem;line-height: 2rem;color:white;">โครงการอยู่บ้าน ปอดปลอดภัย</p>
      </div>
    </div>
  </div>
</div>
<div id="warn_select_patient"  style="display: none;"  class="mbsc-align-center mbsc-btn-group-justified">


    <button  mbsc-button type="button" class="mbsc-btn-outline btn_hover" onclick="check_otherpatient()"
      style="color:white !important; border:none !important ; border-radius:5px;padding:0px 50px;font-size:16px;font-weight:400;background-color:#206eb8;border-radius:5px;">
      <div class="mbsc-form-grid">
        <div class="mbsc-grid">
          <div class="mbsc-row">
            <div class="mbsc-col-12">
              <p style="padding:0px;margin:0px;" id="text_edit_inbtn" >กรุณาเลือกผู้ป่วยที่ลงทะเบียนไว้</p>
            </div>
          </div>
        </div>
      </div>
    </button>

</div>

<div id = "page_content" style="display: none;">
  <div>

    <div mbsc-form >

          <div class="mbsc-align-center" style="margin-top:20px;">
            <p style="margin-top:3px;margin-bottom:8px;">รายงาน ติดตาม อาการเบื้องต้น</p>
            <p style="margin-top:3px;margin-bottom:8px;color:red;" id="other_patient_name" ></p>
          </div>

          <div style="padding:0px 15px 0px 15px;margin: 25px 0px 20px 0px;">
            <hr style="background-color: #58595B;opacity:0.5;">
          </div>

            <div id="title_address" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;">

                <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">1.</span>

                <span style="font-size:14px;font-weight:400;color:#0b9fd5;">  อาการเบื้องต้น (Initial Symptoms)</span>
            </div>
            <div style="padding:0px;margin:0px;">
              <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
                <label>
                                ถ้ามีอาการ (if any)
                                <select mbsc-dropdown name="Category" id="input_nametitle" multiple data-input-style="box" data-label-style="stacked">
                                    <option value="มีไข้">มีไข้</option>
                                    <option value="ไอ">ไอ</option>
                                    <option value="ไม่สามารถรับรสได้" >ไม่สามารถรับรสได้</option>
                                    <option value="ไม่สามารถรับกลิ่นได้" >ไม่สามารถรับกลิ่นได้</option>
                                    <option value="ตาแดง">ตาแดง</option>
                                    <option value="ถ่ายเหลว">ถ่ายเหลว</option>
                                    <option value="เจ็บคอ">เจ็บคอ</option>
                                    <option value="มีน้ำมูก">มีน้ำมูก</option>
                                    <option value="ปวดศรึษะ">ปวดศรึษะ</option>
                                    <option value="ผื่น">ผื่น</option>
                                </select>
                            </label>
              </div>
            </div>
            <!-- <div mbsc-form>
                <div class="mbsc-form-group">
                    <div class="mbsc-form-group-title"></div>

                </div> -->
            </div>

              <div mbsc-form>

            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;">
              <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">2.</span>
              <span style="font-size:14px;font-weight:400;color:#0b9fd5;"> อาการที่ต้องตรวจประเมิน</span>
            </div>

            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;margin-bottom:12px;">
              <p style="padding:0px;margin:0px;font-weight:400;font-size:14px;margin-top:12px;">1. การหายใจ <span style="color:red"> *</span></p>
            </div>

            <div mbsc-card style="display:none;margin-top:0px;margin-bottom:0px;border-radius:0px;">
              <div class="mbsc-card-content" style="padding-top:0px;margin-top:0px;border-radius:0px;">
                <div style="padding:0px;margin:0px;">
                  <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
                    <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                      <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                        <input id="normal_breathe" mbsc-checkbox type="radio" name="breathe_status">
                      </div>
                      <div class="mbsc-col-9">
                        <label for="normal_breathe"><span style="font-size:14px;font-weight:400;"> หายใจปกติ</span></label>
                      </div>
                    </div>
                    <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                      <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                        <input id="heavy_breathe" mbsc-checkbox type="radio" name="breathe_status">
                      </div>
                      <div class="mbsc-col-9">
                        <label for="heavy_breathe"><span style="font-size:14px;font-weight:400;"> เหนื่อยหอบ</span></label>
                      </div>
                    </div>
                    <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                      <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                        <input id="hard_breathe" mbsc-checkbox type="radio" name="breathe_status">
                      </div>
                      <div class="mbsc-col-9">
                        <label for="hard_breathe"><span style="font-size:14px;font-weight:400;"> หายใจลำบาก</span></label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;">
              <p style="padding:0px;margin:0px;font-weight:400;font-size:14px;margin-top:12px;">2. ระดับออกซิเจนในเลือดในสภาวะปกติ (%) (SpO2 Room Air)<span style="color:red"> *</span></p>
            </div>

            <div style="padding:0px;margin:0px;">
              <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
                <div class="mbsc-row" style="padding:0px;margin:0px;">
                  <div class="mbsc-col-12" style="padding:0px;margin:0px;">
                    <div id="spO2" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                      <div id="input_spO2" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                        <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;">
                          <div id="inputbox_spO2">
                            <label>
                              <input style="border:1 solid gray;" class="mbsc-align-left" mbsc-input id="spO2_input" type="text" inputmode="numeric" name="spO2" placeholder=""
                                oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="10" style="font-size: 13px;" />
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                  <div mbsc-form class="mbsc-col-2 mbsc-checkbox-success" style="padding-left:0px;margin:0px;background-color:transparent;">
                    <input id="spO2_unknown" mbsc-checkbox type="checkbox" onclick="checkToDisable()">
                  </div>
                  <div class="mbsc-col-9">
                    <label for="spO2_unknown"><span style="font-size:14px;font-weight:400;"> ไม่ทราบค่า</span></label>
                  </div>
                </div>
              </div>
            </div>

            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:12px;">
              <p style="padding:0px;margin:0px;font-weight:400;font-size:14px;margin-top:12px;">3. ระดับออกซิเจนในเลือดหลังจากออกกำลังกาย (%)<span style="color:red"> *</span></p>
            </div>

            <div style="padding:0px;margin:0px;">
              <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
                <div class="mbsc-row" style="padding:0px;margin:0px;">
                  <div class="mbsc-col-12" style="padding:0px;margin:0px;">
                    <div id="X2O" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                      <div id="input_X2O" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                        <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;">
                          <div id="inputbox_X2O">
                            <label>
                              <input style="border:1 solid gray;" class="mbsc-align-left" mbsc-input id="X2O_input" type="text" inputmode="numeric" name="X2O" placeholder=""
                                oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="10" style="font-size: 13px;" />
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                  <div mbsc-form class="mbsc-col-2 mbsc-checkbox-success" style="padding-left:0px;margin:0px;background-color:transparent;">
                    <input id="X2O_unknown" mbsc-checkbox type="checkbox" onclick="checkToDisable()">
                  </div>
                  <div class="mbsc-col-9">
                    <label for="X2O_unknown"><span style="font-size:14px;font-weight:400;"> ไม่ทราบค่า</span></label>
                  </div>
                </div>
              </div>
            </div>


            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;margin-bottom:12px;">
              <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">3.</span>
              <span style="font-size:14px;font-weight:400;color:#0b9fd5;"> ข้อมูลเพิ่มเติม</span>
              <p style="padding:0px;margin:0px;font-weight:400;font-size:14px;margin-top:12px;">หากท่านมีอาการดังนี้กรุณาระบุ หากไม่มีไม่ต้องระบุ</p>
            </div>

            <!--
            <div mbsc-card style="display:none;margin-top:0px;margin-bottom:0px;border-radius:0px;">
              <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:12px;margin-bottom:12px;">
                <p style="padding:0px;margin:0px;font-weight:400;font-size:14px;margin-top:12px;">ท่านเคยได้รับการ X-Ray และได้รับแจ้งว่ามีอาการปอดอักเสบมาก่อนหรือไม่ <span style="color:red"> *</span></p>
              </div>
              <div class="mbsc-card-content" style="padding-top:0px;margin-top:0px;border-radius:0px;">
                <div style="padding:0px;margin:0px;">
                  <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
                    <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                      <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                        <input id="pneumonia_true" name = "pneumonia" mbsc-checkbox type="radio">
                      </div>
                      <div class="mbsc-col-9">
                        <label for="pneumonia_true"><span style="font-size:14px;font-weight:400;"> เคย และมีอาการปอดอักเสบ</span></label>
                      </div>
                    </div>
                    <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
                      <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                        <input id="pneumonia_false" name = "pneumonia" mbsc-checkbox type="radio">
                      </div>
                      <div class="mbsc-col-9">
                        <label for="pneumonia_false"><span style="font-size:14px;font-weight:400;"> ไม่เคย หรือเคยแต่ไม่มีอาการปอดอักเสบ</span></label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            -->

            <!--
            <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;">

              <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">2.</span>
              <span style="font-size:14px;font-weight:400;color:#0b9fd5;"> ข้อมูลเพิ่มเติม</span>
            </div>
            -->
            <div class="mbsc-row" style="padding:0px;margin:0px;margin-top:5px">
              <div class="mbsc-col-12" style="padding:0px;margin:0px;">
                <div id="input_allergic" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                  <!--<p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">ข้อมูลอื่นๆ</p> -->
                  <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;margin-top:5px;">
                    <div id="inputbox_allergic">
                      <label>
                        <textarea id="allergic" type="text" name="allergic" rows="3" cols="266" class="mbsc-align-left" style="font-size: 13px;"></textarea>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mbsc-row" style="padding:0px;margin:0px;margin-top:5px">
            <div class="mbsc-col-12" style="padding:0px;margin:0px;">
              <div id="input_date" style="border-radius:0px !important;padding:0px;margin-top:10px;">
                <p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">วันที่พบอาการ <span style="color:red"> *</span></p>
                <label style="font-weight:600;font-size:14px; padding:0px 15px 0px 15px;margin:0px;" class="mbsc-align-left" id="date" name="date" placeholder="" maxlength="30" style="font-size: 13px;" value="" readonly></label>
                <!--
                <div class="mbsc-form-group-inset">
                  <div id="inputbox_date">
                    <label>

                    </label>
                  </div>
                </div>
                -->
              </div>
            </div>
          </div>

            <div id="show_btn_save" class="mbsc-align-center mbsc-btn-group-justified">
              <button id="btn_register" mbsc-button type="button" class="mbsc-btn-outline btn_hover" onclick=""
                  style="color:white !important; border:none !important ; border-radius:5px;padding:0px 50px;font-size:16px;font-weight:400;background-color:#206eb8;border-radius:5px;">
                  <div class="mbsc-form-grid">
                    <div class="mbsc-grid">
                      <div class="mbsc-row">
                        <div class="mbsc-col-12">
                          <p style="padding:0px;margin:0px;" id="text_edit_inbtn" onclick="checksymptoms()">บันทึก</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </button>
            </div>
            <br>

        </div>
</div>
</div>

<script>

var patient;

  function refreshpage() {
      //console.log("GLOBALUSER",GLOBALUSER)
      if(GLOBALUSER.status ==1){
          go2View("register");
          return;
      }
      else if (GLOBALUSER.status == 3)
      {
        alert_modal("กรุณาลงทะเบียนให้เรียบร้อยก่อน")
        go2View("initsymptoms")
        return;
      }
        if(Array.isArray(GLOBALUSER.otherpatient) && GLOBALUSER.otherpatient.length > 0 ){
          if(!ACTIVEPATIENT || ACTIVEPATIENT.status !=2){
              check_otherpatient();
              return ;
          }    //already choose ACTIVEPATIENT
            check_and_show(ACTIVEPATIENT._id);
            return;
        }
        check_and_show(GLOBALUSER._id)

  }

function check_and_show(patient_id){
  $.get(MAINURL + "/api-web/line/report_symptoms/init/"+patient_id,(msg) =>{
    console.log(msg)
    if (msg.code == 200)
    {
      patient = msg.patient;
      $('#page_content').show();
      get_geolocation();
    }
    else if (msg.code == 429)
    {
      return alert_modal("คุณเพิ่งทำแบบประเมินไปเมื่อ\n" + moment(msg.inputdate, "X").format("DD/MM/YYYY HH:mm") + "\nคุณสามารถแจ้งได้อีกครั้งภายใน 1 ชั่วโมง")
    }
    else
    {
      return alert_modal("เกิดข้อผิดพลาดในระบบ โปรดลองใหม่อีกครั้ง")
    }
  });
}

  var geo_location;

function get_geolocation()  {
    navigator.geolocation.getCurrentPosition((position) =>
            {
              geo_location = {
                type: "Point",
                coordinates: [position.coords.longitude ,position.coords.latitude]
              }
            })
  }
  $(document).ready(() =>
  {

    // $('#date').mobiscroll().calendar({    //Calendar
    //   dateFormat: 'dd/mm/yyyy',
    //   display: 'center',
    //   touchUi: false,
    //   max: new Date(new Date().setDate(new Date().getDate()))
    // })

        $('#input_nametitle').mobiscroll().select({
            display: 'bubble'
      });
    let datetime = new Date()

      document.getElementById('date').innerHTML = datetime.getDate() + "/"
      + (datetime.getMonth() + 1) + "/" + datetime.getFullYear()

  })
  function check_otherpatient(){
    $('#warn_select_patient').show();
      $.get(MAINURL + "/api-web/otherpatient/list",(msg) =>{
        var name = [GLOBALUSER]
          name = name.concat(msg.obj)
          console.log("Other : ",name)
          select_patient_modal(name,(select_id)=>{
            ACTIVEPATIENT = name[select_id]
              if(ACTIVEPATIENT.status != 2 ){  // Not yet register
                  alert_modal("ผู้ป่วยลงทะเบียนไม่เสร็จ / ไม่สมบูรณ์")
                  return go2View("check_register");
              }
              // if(ACTIVEPATIENT.status == 3 ){  // Not finish
              //   return go2View("initsymptoms");
              // }
              $('#warn_select_patient').hide();

              $('#other_patient_name').html("รายการของ " + ACTIVEPATIENT.firstname + " " + ACTIVEPATIENT.lastname)
              check_and_show(ACTIVEPATIENT._id);

              console.log("ACTIVEPATIENT",ACTIVEPATIENT)
          });
          //select_patient_modal("กรุณาเลือกผู้ป่วยที่ต้องการ")
      })

  }
  function checkToDisable()
    {
        if (document.getElementById("spO2_unknown").checked)
        {
            document.getElementById('spO2_input').disabled = true;
            // hide input
            document.getElementById('spO2_input').style.display = "none";
            document.getElementById('spO2_input').value = "ไม่ทราบค่า";
        }
        else
        {
            document.getElementById('spO2_input').disabled = false;
            // show input
            document.getElementById('spO2_input').style.display = "block";
        }

        if (document.getElementById("X2O_unknown").checked)
        {
            document.getElementById('X2O_input').disabled = true;
            // hide input
            document.getElementById('X2O_input').style.display = "none";
            document.getElementById('X2O_input').value = "ไม่ทราบค่า";
        }
        else
        {
            document.getElementById('X2O_input').disabled = false;
            // show input
            document.getElementById('X2O_input').style.display = "block";
        }
    }


  function checksymptoms(){
      var postData = {
        symptom : $('#input_nametitle').val()
      }
      symptomSubmit(postData)
  }

  function symptomSubmit(symptoms)
  {
    let breathing;
    let spo_room_air = $("#spO2_input").val();
    let exercise_test = $("#X2O_input").val();
    let pneumonia_check;

    //breathing
    if (document.getElementById('normal_breathe').checked)
        {
            breathing = "normal"
        }
        else if (document.getElementById('heavy_breathe').checked)
        {
            breathing = "heavy"
        }
        else if (document.getElementById('hard_breathe').checked)
        {
            breathing = "hard"
        }
        else
        {
            //โยน Error
            return alert_modal("กรุณาเลือกการหายใจ")
        }

        //SpO2
        if (!spo_room_air)
        {
            if (document.getElementById("spO2_unknown").checked)
            {
                spo_room_air = -1;
            }
            else
            {
                //โยน Error
                return alert_modal("กรุณากรอกค่าออกซิเจนในเลือด หรือระบุว่าไม่ทราบค่า")
            }
        }

        if (spo_room_air < 0 || spo_room_air > 100)
        {
          return alert_modal("กรุณากรอกค่าออกซิเจนในเลือดให้ถูกต้อง")
        }

        if (document.getElementById("spO2_unknown").checked)
            {
                spo_room_air = -1;
            }

        //X2O
        if (!exercise_test)
        {
            if (document.getElementById("X2O_unknown").checked)
            {
                exercise_test = -1;
            }
            else
            {
                //โยน Error
                return alert_modal("กรุณากรอกค่าหลังทดสอบภาวะการขาดออกซิเจน หรือระบุว่าไม่ทราบค่า")
            }
        }

        if (exercise_test < 0 || exercise_test > 100)
        {
          return alert_modal("กรุณากรอกค่าหลังทดสอบภาวะการขาดออกซิเจนในเลือดให้ถูกต้อง")
        }

        if (document.getElementById("X2O_unknown").checked)
            {
                exercise_test = -1;
            }


        //pneumonia
        // if (document.getElementById("pneumonia_true").checked)
        // {
        //     pneumonia_check = true;
        // }
        // else if (document.getElementById("pneumonia_false").checked)
        // {
        //     pneumonia_check = false;
        // }
        // else
        // {
        //     //โยน Error
        //     return alert_modal("กรุณาระบุว่าเคยได้รับแจ้งว่ามีอาการปอดอักเสบมาก่อนหรือไม่")
        // }

        // if (!geo_location.coordinates || geo_location.length == 0)
        // {
        //     //โยน Error
        //     return alert_modal("โปรดอนุญาตให้มีการเก็บข้อมูลตำแหน่งที่อยู่")
        // }



    let payload =
    {
      inputdate: Math.floor((new Date()) / 1000),
      patient:patient,
      symptoms : symptoms.symptom,
      breathing: breathing,
      spo_room_air: spo_room_air,
      exercise_test: exercise_test,
      pneumonia_check: pneumonia_check,
      remark: $("#allergic").val(),
      location: geo_location
    }

    console.log("Sending Data")
    var call_url = MAINURL + "/api-web/line/report_symptoms/submit/";
    if(ACTIVEPATIENT){  // ทำรายการแทนกัน
      call_url  += ACTIVEPATIENT._id
    }else{
      call_url  += GLOBALUSER._id
    }

    $.postJSON(call_url,payload,(msg) =>
    {
      if (msg.status == 200)
      {
        alert_modal("บันทึกข้อมูลเรียบร้อย กรุณากดปิดหน้าต่างเพื่อกลับเข้าเมนูหลักใน LINE \"อยู่บ้าน ปอดปลอยภัย\"")
        setTimeout(()=>{
          liff.closeWindow()
        },4000)
        return;// go2View("alreadyregister2")
      }
      else
      {
        return alert_modal("เกิดปัญหาระหว่างลงทะเบียน โปรดลองใหม่อีกครั้ง")
      }
    })
  }

</script>
