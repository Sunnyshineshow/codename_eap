<div class="md-range-event" mbsc-form>
    <div class="md-header" style="padding:8px 0px 14px 0px;margin:0px;background-color:#206eb8;">
      <div class="mbsc-header-txt mbsc-align-center">
        <div class="mbsc-align-center" style="margin-top:8px;">
          <p style="padding:0px 5px;margin:0px;font-weight:400;font-size: 1.5rem;line-height: 2rem;color:white;">โครงการอยู่บ้าน ปอดปลอดภัย</p>
        </div>
      </div>
    </div>
  </div>

  <div mbsc-form>
    <div class="mbsc-align-center" style="margin-top:20px;">
        <p id="title_address" style="margin-top:3px;margin-bottom:8px;"> เมนูเจ้าหน้าที่</p>
      </div>
      <div style="padding:0px 15px 0px 15px;margin: 25px 0px 20px 0px;">
        <hr style="background-color: #58595B;opacity:0.5;">
      </div>
      <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;margin-bottom:12px;">
        <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">1.</span>
        <span style="font-size:14px;font-weight:400;color:#0b9fd5;"> โปรดเลือกฝ่าย</span><span style="color:red"> *</span>
      </div>
      <div class="mbsc-card-content" style="padding-top:0px;margin-top:0px;border-radius:0px;">
        <div style="padding:0px;margin:0px;">
          <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
            <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
              <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                <input id="medicine" name = "treatment_option" mbsc-checkbox type="radio" onchange="show_on_med_check()">
              </div>
              <div class="mbsc-col-9">
                <label for="medicine" >
                <span style="font-size:14px;font-weight:400;">จ่ายยา ให้ผู้ป่วย</span>
                </label>
              </div>
            </div>
            <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
              <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
                <input id="xray" name = "treatment_option" mbsc-checkbox type="radio" onchange="show_on_med_check()">
              </div>
              <div class="mbsc-col-9">
                <label for="xray" >
                <span style="font-size:14px;font-weight:400;">รับคิวผู้ป่วยเข้า X-Ray</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;margin-bottom:12px;">
        <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">2.</span>
        <span style="font-size:14px;font-weight:400;color:#0b9fd5;"> รายละเอียด</span>
      </div>

      <div id="show_on_med_check" style="display: none;">
        <div class="mbsc-row">
          <div class="mbsc-col-sm-12 mbsc-col-md-6">
           <label>
               ยาฟาวิพิราเวียร์
               <select mbsc-dropdown id="medic_favipilavia" data-input-style="box">
                  <option value="0" disabled selected>กรุณาเลือก </option>
                   <option value="60">50 เม็ดสำรับผู้มีน้ำหนัก น้อยกว่า 90 กก</option>
                   <option value="64">64 เม็ดสำรับผู้มีน้ำหนัก มากกว่า 90 กก</option>
               </select>
           </label>
         </div>
       </div>
       <div class="mbsc-row">
         <div class="mbsc-col-sm-12 mbsc-col-md-6">

           <p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">ยาอื่นๆ หากมี <span style="color:red"> *</span></p>
           <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;">
             <div >
               <label>
                 <input class="mbsc-align-left" mbsc-input id="medic_other" type="text" name="medic_other" placeholder="กรุณาระบุ ชื่อ และขนาดการให้ยา " value="" style="font-size: 13px;" />
               </label>
             </div>

         </div>
         </div>
        </div>
      </div>

      <div class="mbsc-row" style="padding:0px;margin:0px;margin-top:5px">
        <div class="mbsc-col-12" style="padding:0px;margin:0px;">
          <div id="input_comment" style="border-radius:0px !important;padding:0px;margin-top:10px;">
            <p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">รายละเอียดเพิ่มเติม</p>
            <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;margin-top:5px;">
              <div id="inputbox_comment">

                  <textarea id="comment" type="text" mbsc-input  name="comment" rows="3" cols="266" class="mbsc-align-left" style="font-size: 13px;"></textarea>

              </div>
            </div>
          </div>
        </div>
      </div>
      <br>

      <div class="mbsc-align-center">
        <p><strong id="waiting"></strong></p>
      </div>

      <div class="mbsc-form-group">
            <div class="mbsc-btn-group-justified">
                <button mbsc-button class="mbsc-btn-success" id = "confirm" onclick="optionConfirmed()">ยืนยัน</button>
                <button mbsc-button class="mbsc-btn-danger" id = "cancel" onclick="optionCancel()">ยกเลิก</button>
            </div>
        </div>
  </div>



<script>

    var patient_id = getParameterByName('patient', window.location.search);
    var appoint_id = getParameterByName('id', window.location.search);

    //Edit here
    var geo_location;

    $(document).ready(() =>
    {
      $('#demo-mobile').mobiscroll().select({
          display: 'bubble'
      });



      navigator.geolocation.getCurrentPosition((position) =>
      {
        geo_location =
        {
          type: "Point",
          coordinates: [position.coords.longitude ,position.coords.latitude]
        }
      })
    })

    function optionConfirmed()
    {
        let option;
        let payload;

        if (document.getElementById('medicine').checked)
        {
          if (!$("#medic_favipilavia").val())
          {
            return alert("กรุณากรอกหน่วยงาน")
          }



            option = "MEDICINE"
            payload =
            {
                _id : appoint_id,
                patient: patient_id,
                treatment: {
                    option: option,
                    comment: $("#comment").val(),
                    location: geo_location
                    },
                medicine: {
                  medic_favipilavia: $("#medic_favipilavia").val(),
                  medic_other:  $("#medic_other").val() | ""
                }
            }
        }
        else if (document.getElementById('xray').checked)
        {
            option = "XRAY"
            payload =
            {
                _id : appoint_id,
                patient: patient_id,
                treatment: {
                    option: option,
                    comment: $("#comment").val(),
                    location: geo_location
                    }
            }
        }
        else
        {
            return alert_modal("กรุณาเลือกฝ่าย")
        }

        //Edit here



        console.log(payload)
        console.log(MAINURL)
        document.getElementById('waiting').innerHTML = "โปรดรอซักครู่"
        document.getElementById('confirm').disabled = true
        document.getElementById('cancel').disabled = true
        $.post(MAINURL + "/api-web/line/confirm",payload,(msg) =>
        {
            if (msg.code == 200)
            {
                alert_modal("ดำเนินการเรียบร้อย")
                go2View("admin_qr")
            }
            else
            {
              return alert_modal("เกิดข้อผิดพลาด โปรดลองใหม่อีกครั้ง")
            }
        })
      }

    function optionCancel()
    {
        go2View("admin_qr")
    }

    function show_on_med_check()
    {
      if (document.getElementById('medicine').checked)
      {
        document.getElementById('show_on_med_check').style.display = "block"
      }
      else
      {
        document.getElementById('show_on_med_check').style.display = "none"
      }
    }

</script>
