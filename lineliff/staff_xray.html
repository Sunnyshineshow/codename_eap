<div class="md-range-event" mbsc-form>
    <div class="md-header" style="padding:8px 0px 14px 0px;margin:0px;background-color:#206eb8;">
      <div class="mbsc-header-txt mbsc-align-center">
        <div class="mbsc-align-center" style="margin-top:8px;">
          <p style="padding:0px 5px;margin:0px;font-weight:400;font-size: 1.5rem;line-height: 2rem;color:white;">โครงการอยู่บ้าน ปอดปลอดภัย</p>
        </div>
      </div>
    </div>
  </div>
  <br> 
  
<div id="ui" style="display: none;">
    <div mbsc-form>
        <div class="mbsc-align-center" style="margin-top:20px;">
            <p id="title_address" style="margin-top:3px;margin-bottom:8px;"> เมนูเจ้าหน้าที่</p>
          </div>

          <div style="padding:0px 15px 0px 15px;margin: 25px 0px 20px 0px;">
            <hr style="background-color: #58595B;opacity:0.5;">
          </div>
          <div class="mbsc-align-center">
              <div class = "mbsc-btn-group-block">
                <button mbsc-button onclick="qrCodeScanner()">สแกน QRCode ของผู้ป่วย</button>
              </div>
          </div>
      </div>

</div>

  <div mbsc-form id="ui_showing">

  </div>
  <div mbsc-form>
    <p>หรือกรอกข้อมูลผู้ป่วยด้านล่าง</p>
    <div class="mbsc-col-3" style="padding:0px;margin:0px;">
      <div id="input_patient" style="border-radius:0px !important;padding:0px;margin-top:10px;">
        <p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">PATIENT ID<span style="color:red"> *</span></p>
        <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;">
          <div id="inputbox_patient">
            <label>
              <input class="mbsc-align-left" id="patient_in" type="number"placeholder="" style="font-size: 13px;" />
            </label>
          </div>
        </div>
      </div>
    </div>

  <div class="mbsc-col-3" style="padding:0px;margin:0px;">
      <div id="input_appointment" style="border-radius:0px !important;padding:0px;margin-top:10px;">
        <p style="padding:0px;margin:0px;margin-left: 18px;font-weight:400;font-size:14px;">APPOINTMENT ID<span style="color:red"> *</span></p>
        <div class="mbsc-form-group-inset" style="padding:0px 15px 0px 15px;margin:0px;">
          <div id="inputbox_patient">
            <label>
              <input class="mbsc-align-left" id="appointment_in" type="number" placeholder="" style="font-size: 13px;" />
            </label>
          </div>
        </div>
      </div>
    </div>


  <button mbsc-button onclick="qrlessConfirm()">ยืนยัน</button>
  </div>
  


<script>

    $(document).ready(() =>
    {
        $("#ui_showing").html($("#ui").html())
    })

    function qrCodeScanner()
    {
        liff.scanCode().then(result => {
            if (result.value == null)
            {
                return alert_modal("ยกเลิกการสแกน")
            }

            let url = new URL(result.value)
            let id = url.searchParams.get("id");
            let patient = url.searchParams.get("patient");

            if (!id || !patient)
            {
                return alert_modal("ข้อมูลไม่ถูกต้อง")
            }
            else
            {
                $.postJSON(MAINURL + "/api-web/line/admin_loadqrdata", {_id:id,patient:patient},(msg)=>
                {
                    alert(id + " " + patient)
                    if (msg.code == 200)
                    {
                        go2View("admin_option?id=" +  id + '&patient=' +  patient);
                    }
                    else if (msg.code == 404)
                    {
                        alert_modal("ไม่พบข้อมูลนัดหมาย โปรดติดต่อเจ้าหน้าที่ฝ่ายพัฒนา")
                    }
                    else if (msg.code == 403)
                    {
                        return alert_modal("นัดหมายนี้ถูกยกเลิก<br><br>หากคิดว่านี่คือข้อผิดพลาด<br>โปรดติดต่อเจ้าหน้าที่ฝ่ายพัฒนา")
                    }
                    else
                    {
                        alert_modal("เกิดข้อผิดพลาดบางอย่าง โปรดลองใหม่อีกครั้ง")
                    }
                })

            }
        });

    }

    function qrlessConfirm()
    {

        if (!$("#patient_in").val())
        {
            return alert_modal("โปรดระบุเลขที่ผู้ป่วย")
        }
        
        if (!$("#appointment_in").val())
        {
            return alert_modal("โปรดระบุเลขที่ผู้ป่วย")
        }

        let id = parseInt($("#appointment_in").val())
        let patient = parseInt($("#patient_in").val())

        $.postJSON(MAINURL + "/api-web/line/admin_loadqrdata", {_id:id,patient:patient},(msg)=>
                {
                    if (msg.code == 200)
                    {
                        go2View("admin_option?id=" +  id + '&patient=' +  patient);
                    }
                    else if (msg.code == 404)
                    {
                        alert_modal("ไม่พบข้อมูลนัดหมาย โปรดติดต่อเจ้าหน้าที่ฝ่ายพัฒนา")
                    }
                    else if (msg.code == 403)
                    {
                        return alert_modal("นัดหมายนี้ถูกยกเลิก<br><br>หากคิดว่านี่คือข้อผิดพลาด<br>โปรดติดต่อเจ้าหน้าที่ฝ่ายพัฒนา")
                    }
                    else
                    {
                        alert_modal("เกิดข้อผิดพลาดบางอย่าง โปรดลองใหม่อีกครั้ง")
                    }
                })


    }
</script>
