<div class="md-range-event" mbsc-form>
  <div class="md-header" style="padding:8px 0px 14px 0px;margin:0px;background-color:#206eb8;">
    <div class="mbsc-header-txt mbsc-align-center">
      <div class="mbsc-align-center" style="margin-top:8px;">
        <p style="padding:0px 5px;margin:0px;font-weight:400;font-size: 1.5rem;line-height: 2rem;color:white;">โครงการอยู่บ้าน ปอดปลอดภัย</p>
        <p style="padding:0px 5px;margin:0px;font-weight:400;font-size:12px;color:white;">Emergency Assistance for Home stay Patients Project ( EAP )</p>
      </div>
    </div>
  </div>
</div>

<div mbsc-form>
  <div class="mbsc-align-center" style="margin-top:20px;">
      <p id="title_address" style="margin-top:3px;margin-bottom:8px;"> เมนูคนขับรถ</p>
    </div>
    <div style="padding:0px 15px 0px 15px;margin: 25px 0px 20px 0px;">
      <hr style="background-color: #58595B;opacity:0.5;">
    </div>
    <div id="title_more" class="mbsc-align-left" style="margin-left: 18px;margin-top:25px;margin-bottom:12px;">
      <span style="padding:5px 11px;margin:0px;font-size:14px;font-weight:400;background-color:#206eb8;border-radius:50px;color:white;">1.</span>
      <span style="font-size:14px;font-weight:400;color:#0b9fd5;">ยืนยันการ รับ / ส่งผู้ป่วย</span><span style="color:red"> *</span>
    </div>
    <div class="mbsc-card-content" style="padding-top:0px;margin-top:0px;border-radius:0px;">
      <div style="padding:0px;margin:0px;">
        <div class="mbsc-grid mbsc-align-left" style="padding:0px;margin:0px;">
          
          <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
            <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
              <input id="GO_option" name = "treatment_option" mbsc-checkbox type="radio">
            </div>
            <div class="mbsc-col-9">
              <span style="font-size:14px;font-weight:400;">รอบเดินทางไป</span>
            </div>
          </div>

          <div class="mbsc-row" style="padding:0px;margin:0px; margin-top:12px;">
            <div mbsc-form class="mbsc-col-2 mbsc-checkbox-primary" style="padding-left:0px;margin:0px;background-color:transparent;">
              <input id="Return_option" name = "treatment_option" mbsc-checkbox type="radio" disabled>
            </div>
            <div class="mbsc-col-9">
              <span style="font-size:14px;font-weight:400;">รอบเดินทางกลับ</span>
            </div>
          </div>
         
        </div>
      </div>
    </div>
    
    <div class="mbsc-form-group">
          <div class="mbsc-btn-group-justified">
              <button mbsc-button class="mbsc-btn-success" id = "confirm" onclick="optionConfirmed()">ยืนยัน</button>
              <button mbsc-button class="mbsc-btn-danger" id = "cancel" onclick="optionCancel()">ยกเลิก</button>
          </div>
      </div>
</div>



<script>

  var patient_id = getParameterByName('patient', window.location.search);
  var appoint_id = getParameterByName('id', window.location.search);
  

  //Edit here
  var geo_location;

  $(document).ready(() =>
  {
    navigator.geolocation.getCurrentPosition((position) =>
    {
      geo_location = 
      {
        type: "Point",
        coordinates: [position.coords.longitude ,position.coords.latitude]
      }
    })        
     var Checker= {
       patient:patient_id,
       appointment:appoint_id
     }
     var Data= ""
     $.postJSON(MAINURL + "/api-web/line/checker_vq",Checker,(msg) =>
      {              
        console.log("Try to reach")
        console.log(msg)
        console.log(msg.patient)

        if(msg.travel_to)
        {
        console.log("Should Lock A")
        $('#GO_option').attr('disabled','disabled');
        }

        if(msg.travel_to && !msg.travel_return )
        {
        console.log("Unlock")
        $('#Return_option').removeAttr('disabled');
        }

        if(msg.travel_return)
        {
          console.log("Should Lock B")
          $('#Return_option').attr('disabled','disabled');
        }
      })              
  })

  function optionConfirmed()
  {
     
      //DRAGON TODO       
      var payload={
        patient: patient_id,
        appointment: appoint_id,
        location:geo_location, 
        
        Driver_lineID:GLOBALUSER.userId   
      }

      console.log(payload)
      console.log(GLOBALUSER)
     

      if((document.getElementById("GO_option").checked === true))
      {
        $.postJSON(MAINURL + "/api-web/line/update_send_vehicle",payload,(msg) =>
        {
        console.log(msg)
          if (msg.code == 200)
          {
              alert_modal("ดำเนินการเรียบร้อย")
              go2View("admin_qr")
          }
          else
          {
            return alert_modal("เกิดข้อผิดพลาด โปรดลองใหม่อีกครั้ง")
          }
        })
      }

      if((document.getElementById("Return_option").checked === true))
      {
        $.postJSON(MAINURL + "/api-web/line/update_return_vehicle",payload,(msg) =>
        {
        console.log(msg)
          if (msg.code == 200)
          {
              alert_modal("ดำเนินการเรียบร้อย")
              go2View("admin_qr")
          }
          else
          {
            return alert_modal("เกิดข้อผิดพลาด โปรดลองใหม่อีกครั้ง")
          }
        })
      }
      
    }

  function optionCancel()
  {
      go2View("admin_qr")
  }

</script>