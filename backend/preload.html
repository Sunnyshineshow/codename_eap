<header id='inc_menu_header'> </header>


<div id='mainpage_body' style="margin-top: 50px !important;" class="pb-5">
  <center>Loading ..</center>
</div>
<footer style="margin-left: 0px !important;" class="fixed-bottom mt-5">
  <div class="container-fluid my-auto">
    <div class="text-center my-auto copyright"><span>© Copyright <!--2021 Advance Web Service PLC, Team Armando.--><br /></span>
    </div>
  </div>


</footer>
<div class="modal" tabindex="-1" id="p_comment">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ใส่หมายเหตุ สำหรับผู้ป่วยรายนี้</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><input class="form-control" id="patient_comment" placeholder="หมายเหตุ"> </p>
        <br>
        <h5>History</h5>
        <div id="p_historycomment">

          </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="finish_patient_comment()" >Save changes</button>
      </div>
    </div>
  </div>
</div>
<div id="image_modal"></div>
<div id="lineLogin"></div>

<script>
    var GLOBAL_USER;
    var ACCESS_TOKEN = localStorage.getItem('eap_access_token');
    var pagestatus = getParameterByName('?');
    var page = window.location.pathname.split('/')[URL_PAGE_POSITION+1];
    var working ={}
    console.log("PAGE = ",page)
    var all_page = [
        'dashboard', 'loginline','main', 'stafflist','notallow','patientlist','monitoring','gmap','appointment','treatment','hospital','hospital_edit',
        'patient','appoint_patient','staff_edit','call_center','call_patient','car_manage','hospital_manage','car_choose','log_report','patient_form', 'car_self',
        'faq_forum','faq_reply','credit','car_worktime','vehicle_list','slotlist','devpage','medical','autoappoint','page1','page2','send_drug',
        'dashboard', 'autoappoint2'
    ];

    for (var x = 0; x < all_page.length; x++) {
        onPageshow(all_page[x], {
            obj: '#mainpage_body',
            url: PREFIX_MAIN_LOCAL + '/' + all_page[x] + '.html'
        });
    }

    function show_module(token) {
        // if (pagestatus) {
        //     starturl = starturl.split('?')[0];
        //     console.log("starturl", starturl)
        // }
        var access = token.scope;
        console.log("TOKEN = ",token)
        $('#inc_menu_header').load(PREFIX_MAIN_LOCAL+'/inc_nav.html');

        $('.sidebar').load(PREFIX_MAIN_LOCAL+'/sidebar.html', function() {
            $('.sidebar').show(function() {
                // console.log(page)
                $('#'+page).addClass('active');
            });
        });

        $('#header').load(PREFIX_MAIN_LOCAL+'/navbar.html', function() {
            $('#header').show();
        });
        $('#footernav').load(PREFIX_MAIN_LOCAL+'/footer.html', function() {
            $('#footernav').show();
        });

        $('#linelogin').hide();

        $('.topmenu').load(PREFIX_MAIN_LOCAL+'/topmenu.html', function() {
            $('.topmenu-right').show(function() {
                // console.log(page)
                $('#'+page).addClass('active');
            });
        });
    }

    if(starturl == '/undefined') {
      starturl = "main"
    }
    console.log("starturl", starturl)
    if (ACCESS_TOKEN) {
        console.log("ACCESS_TOKEN",ACCESS_TOKEN)
        var decode = jwt_decode(ACCESS_TOKEN);
        if(decode.exp < Math.floor(new Date() / 1000)) {
            $('.sidenav').hide();
            $('#header').hide();
            $('#footernav').hide();
            $('.topmenu').hide();
            window.localStorage.clear();
            window.location = PREFIX_URL + '/loginline';
        } else {
            ajax_settoken(ACCESS_TOKEN);
            show_module(decode);
            GLOBAL_USER = decode;
        }
        if(starturl){
            // console.log(starturl)
            go2View(starturl);
        }else{
            go2View("main");  /* main */
        }
    } else {
        if(starturl && starturl.indexOf('/loginline?') ==0){
            // console.log("checking.. from LINE")
            $('#lineLogin').load(PREFIX_MAIN_LOCAL + '/loginline.html');
        }else {
            go2View("loginline");
        }
    }


    $('#image_modal').load(PREFIX_MAIN_LOCAL + '/modal_image_view.html');
        function logout() {
            window.localStorage.clear();
            window.location =  PREFIX_URL
    }

    var working_patient_id;
    var working_patient_comment_cb;
    function update_patient_comment(patient_id,cb){
      working_patient_id = patient_id
      var paitien_obj;
      $('#p_historycomment').html('')
       $('#patient_comment').val('')
      if(Array.isArray(current_patientlist)){
        console.log("GOT ",current_patientlist)
        current_patientlist.map((p)=>{
          if(p._id ==patient_id) paitien_obj = p
        })
      }
      if(paitien_obj && Array.isArray(paitien_obj.commentlog)){
         $('#patient_comment').val(paitien_obj.comment)
        console.log("FOUND COMMENTLOG")
        var p_h = '';
        for(var x=0;x < paitien_obj.commentlog.length;x++){
            p_h += paitien_obj.commentlog[x] + ' ' + paitien_obj.commentby[x] + '<br>'
        }
        $('#p_historycomment').html(p_h)
      }
      $("#p_comment").modal('show')
      working_patient_comment_cb =cb;
      //patient_id
    }
    function finish_patient_comment(){
      $("#p_comment").modal('hide')
      if(! $('#patient_comment').val()) {
        alert("Comment is empty")
        return;
      }
      var data = {
        patient : working_patient_id,
        comment: $('#patient_comment').val()
      }
      $.postJSON(MAINURL + '/api-backend/admin/update_comment',data,(msg)=>{
          if(typeof(working_patient_comment_cb)=='function') working_patient_comment_cb(msg)
      })

    }


</script>
