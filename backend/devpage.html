<style>

  .external-event-calendar {
      border-right: 1px solid #ccc;
  }

  .external-event-task {
      color: #fff;
      padding: 10px;
      margin: 20px;
      border-radius: 8px;
      font-family: -apple-system, Segoe UI, Roboto, sans-serif;
  }

  .demo-external-event-presets.demo-wrapper,
  .demo-external-event-presets .mbsc-grid,
  .demo-external-event-presets .mbsc-row,
  .demo-external-event-presets .external-event-calendar {
      height: 100%;
  }





  .md-work-week-cont {
      position: relative;
      padding-left: 50px;
  }

  .md-work-week-avatar {
      position: absolute;
      max-height: 50px;
      max-width: 50px;
      top: 21px;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      left: 20px;
  }

  .md-work-week-name {
      font-size: 16px;
  }

  .md-work-week-title {
      font-size: 12px;
      margin-top: 5px;
  }

.md-timeline-template .mbsc-schedule-event.mbsc-ltr {
    height: auto !important;
}

.md-timeline-template-event {
    border: 1px solid transparent;
    margin: 2px 0;
}

.md-timeline-template-event-cont {
    background: rgba(255, 255, 255, .8);
    font-size: 15px;
    height: 32px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

.md-timeline-template-event-cont .mbsc-icon {
    padding: 5px;
    box-sizing: content-box;
}

.mbsc-timeline-event-start .md-timeline-template-event,
.mbsc-timeline-event-start .md-timeline-template-event-cont,
.mbsc-timeline-event-start .md-timeline-template-event-cont .mbsc-icon {
    border-top-left-radius: 20px;
    border-bottom-left-radius: 20px;
}

.mbsc-timeline-event-end .md-timeline-template-event,
.mbsc-timeline-event-end .md-timeline-template-event-cont,
.mbsc-timeline-event-end .md-timeline-template-event-cont .mbsc-icon {
    border-top-right-radius: 20px;
    border-bottom-right-radius: 20px;
}

.md-timeline-template-event-cont .mbsc-icon:before {
    color: #fff;
    font-size: 18px;
}

.md-timeline-template-time {
    margin: 0 10px;
}

.md-timeline-template-title {
    color: #666;
}

.md-timeline-template .mbsc-timeline-column,
.md-timeline-template .mbsc-timeline-header-column {
    min-width: 100px;
}

.md-timeline-template .mbsc-timeline-resource,
.md-timeline-template .mbsc-timeline-row {
    min-height: 100px;
}
  </style>
<div class="main_page mb-12" style="margin-top:120px;">

  <div class="mbsc-grid mbsc-no-padding">
      <div class="mbsc-row">
      <div class="mbsc-col-sm-12 external-event-calendar">
        <div id="xray-q" style="height:100%;"></div>

        </div>

      </div>
  </div>

</div>
<div id="external-event-dialog" class="mbsc-cloak" style="display:none">
  <div mbsc-form>
    <div class="mbsc-form-group-inset">
        <label >
            นัดหมาย #  <span id="totalq"> </span>
        </label>
        <br>
        <label >
            เวลาเริ่ม :  <span id="t_begin"> </span>
        </label>
        <br>
        <label >
            เวลาเริ่มสิ้นสุด:  <span id="t_end"> </span>
        </label>
        <br>
        <label >
           <a href="" target="_blank" id="link_detail">  Detail LINK </a>
        </label>
        <br>

    </div>
    </div>
</div>

<script type="text/javascript">

  var searchobj = {};
  var fncsearch;
  var current_appoint;
  var current_hosp;
  var qcalendar;
  var randcolor = ["#7a5886","#9da721","#cd6957","#637e57","#50789d","#6c5d45"]

  function refreshpage(rawdata,clearsearch) {

    if (!clearsearch)
    {
      clearsearch = true
    }

    console.log("GLOBAL_USER",GLOBAL_USER)

    var search_setting = {
      posturl: '/api-backend/admin/HospitalList',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_hospital_list,
      limit: 10,
    }

    fncsearch = ADV_search(search_setting,clearsearch); // Defult always search at first
    return false;
  }
  function load_timeslot(hospital_id){
  let payload = {
    hospital: hospital_id,
    timestart: Math.floor(new Date()/1000 - 3600*24*3),  // last 3 days
    timeend: Math.floor(new Date()/1000 + 3600*24*27)  // next 27 days
  }

  console.log(payload)

    $.postJSON(MAINURL + "/api-backend/admin/hospital/load_timeslot", payload, (msg) => {
        console.log("GOT TIMESLOT",msg)
        if(Array.isArray(msg.detail )){
            msg.detail.map((ev)=>{

                      ev.start = new Date(ev.timestart*1000);
                      ev.end = new Date(ev.timeend*1000);
                      ev.title = ev.queuecount + " นัด";
                      if(ev.queuecount ==0){
                        ev.title =""
                        ev.color = "#eeeeee"
                      }
                      ev.resource =  ev.hospital;
                      delete ev.timeend;
                      delete ev.timestart;
                      delete ev.id;
            })
            current_appoint = msg.detail;
            set_event(current_hosp,msg.detail)
        }else{
          alert("Data Not found ")
        }

    });
  }
  function show_hospital_list(objdata, totalrecord) {
    // console.log('objdata', objdata);

    var allhosp = []

    if (objdata.result && totalrecord > 0) {

      working.patient = objdata.obj;
      objdata.obj.map(item => {
        allhosp.push(item._id);
        item.title = item.name;
        item.id= item._id;
        item.color = randcolor[ item._id % 5]
        // console.log(item)
      });
      current_hosp = objdata.obj;
      load_timeslot(allhosp);
      return;
    }
  }

  function set_event(obj,all_event){
        mobiscroll.setOptions({
        locale: mobiscroll.localeTh,
        theme: 'ios',
        themeVariant: 'light',
    });
    var now  = new Date()
  $(function () {
      var begin = new Date().getDay();
      begin = (begin -1) %7
      console.log("DAY ",new Date().getDate())
      qcalendar = $('#xray-q').mobiscroll().eventcalendar({
        view: {
            timeline: {
                type: 'week',
                startDay: begin,
                endDay: (begin+6) %7,
                timeCellStep: 60  ,
                timeLabelStep: 60
            }
        },invalid: [{
        start: '00:00',
        end: '06:00',
        recurring: {
            repeat: 'daily',
        }
    }, {
        start: '22:00',
        end: '23:59',
        recurring: {
            repeat: 'daily',
        }
    }],
          renderResource: function (resource) {
              return '<div class="md-work-week-cont">' +
                  '<div class="md-work-week-name">'+ resource.title + '</div>' +
        //          '<div class="md-work-week-title">' + resource.title + '</div>' +
                  //'<div class="md-work-week-avatar" ><a href="/admin/vehicle_list?find_id='+resource.id+'" target="_blank">#'+ resource.id +"</a>:</div>" +
                  //  `<div><small>unsave</small></div>`+
                  '</div>';
          },
          // renderScheduleEvent: function (data) {
          // //  console.log("Reding data",data)
          //     var ev = data.original;
          //     var color = data.color;
          //     var html = `<div class="hosp-event mbsc-schedule-event-title mbsc-ios" >${ev.title} </div>
          //         <div class="mbsc-schedule-event-range mbsc-ios">${ev.startchar}</div>`;
          //     // if(ev.status == 1){
          //     //     html+=`<span class="mbsc-icon mbsc-font-icon mbsc-icon-save" style="background:${color}"></span> `
          //     // }
          //     //  html += `<span class="md-timeline-template-title">${ev.title}</span></div></div>`
          //     return html;
          //         //'
          //       //  (ev.unsave || '') +
          //
          // },
          clickToCreate: false,
          dragToCreate: false,
          dragToResize: false,
          dragToMove: false,
          externalDrop: false,

          onEventCreated: function (args) {
              // $(".appoint_id" +args.event._id).hide("slow");
              // var res = getobjbyid(current_car,args.event.resource)
              // args.event.color = res.color;
              // console.log("Created",args)
          },
          onEventClick: function (args) {
                    // editingobj = args.event
                     console.log("click",args.event)
                     fillDialog(args);

                 },
          onEventCreateFailed: function () {
              alert( 'Can\'t create event on this date');
          },
          onEventUpdateFailed: function () {
              alert( 'Can\'t add event on this date');
          },
          data: all_event ,
          resources:obj
      });
    //  qcalendar.setEvents(all_event);
      console.log("finish",all_event)
      var dialog = $('#external-event-dialog').mobiscroll().popup({
          display: 'center',
          width: 400,
          contentPadding: false,
          touchUi: false,
          headerText: 'Assign task',
          buttons: ['close'],
      }).mobiscroll('getInst');

         function fillDialog(args) {
             var res = getobjbyid(current_hosp,args.event.resource)
             var q = args.event;
             $('#t_begin').html(moment(q.start).format("DD-MM-YY HH:mm"));
             $('#t_end').html(moment(q.end).format("DD-MM-YY HH:mm"));
             $('#totalq').html(`${q._id} จำนวน ${q.title}`)
             $('#link_detail').attr('href',"/admin/slotlist?qid="+q._id)
             dialog.open();
         }
  });
  return false;
}
</script>
