


<div>
    <br />
    <br />
    <br />
    <br />
    <!-- PATIENT VIEW -->
    <div class="main_page mb-5">
      <div class="container">
        <!-- <div class="card"> -->
            <div class="card-body" style="width: 85%;">
                <div class="p-2 mr-5 ml-5" id="main_paitient_info">
                    <h3 style="color: #0d6efd;">Staff Information</h3>
                    <!-- profile -->
                    <div id="patient_description" style="display: none;">
                        <br>
                        <div class="card">
                            <div class="card-body" style="text-align: left;">
                              <h4 style="color: #289de9;">รายละเอียด</h4>
                                <div > <img src="##PATIENT-pictureUrl##" alt="Patient Image" width="45%" height="auto" style="border-radius: 15px 50px;"> </div>
                                <br>
                                <strong>ID:</strong> ##PATIENT-id##
                                <br />
                                <strong>ชื่อ:</strong>  ##PATIENT-nametitle####PATIENT-firstname##  ##PATIENT-lastname##
                                <br />
                                <strong>อายุ:</strong> ##PATIENT-age##
                                <br />
                                <strong>วันเกิด:</strong> ##PATIENT-birthday##
                                <br />
                                <strong>เพศ:</strong> ##PATIENT-gender##
                                <br />
                                <br>
                                <strong>ที่อยู่:</strong>
                                <br>##PATIENT-address.address## ##PATIENT-address.lane## ##PATIENT-address.road## ##PATIENT-address.subdistrict## ##PATIENT-address.district## ##PATIENT-address.province## ##PATIENT-address.zipcode##
                                <br />
                                <br>
                                <strong>Email:</strong> ##PATIENT-email##
                                <br>
                                <strong>เบอร์โทร:</strong> ##PATIENT-mobileno##
                                <br>

                                <div class="card">
                                    <div class="card-body" style="text-align: left;">
                                        <div class="form-group">
                                        <strong>ลบออกจากการเป็น Staff: </strong> <label for="txt"> <button type="submit" style="background-color: red;" class="btn btn-primary" onclick="AddStaffDataToDB()" width="10" height="10">Submit</button> </label>
                                        </div>
                                    </div>
                                </div>

                            </div>
                          </div>
                          <br>
                </div>
                <div id="patient_description_showing">
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-body" style="text-align: left;">
                          <h4 style="color: #289de9;">ส่งข้อความเข้าไลน์ของผู้ป่วย</h4>
                            <br>
                            <strong>กรอกข้อความที่นี่</strong><br>
                            <textarea id="lineSender" type="text"></textarea> <br>
                            <input class="btn btn-dark" style="background-color: #1597BB;" type="button" id="line_send_message" value="ส่งข้อความ" onclick = "sendToLine()">
                        </div>
                      </div>
                </div>
            </div>
          </div>
            <!-- </div> -->
          </div>
      </div>
      <style>
        .card {
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
          max-width: 75%;
          margin: auto;
          text-align: center;
          font-family: arial;
        }
      </style>
     <script>
      var template_main_paitient_info = $('#main_paitient_info').html();
      var template_symptomlist = $("#row_symptomlist").html()

      function refreshpage(rawdata) {
          var patientid = getParameterByName('id', window.location.search);
          $.postJSON(MAINURL + '/api-backend/admin/patient',{_id:patientid},(res)=>{

            console.log(res)
            for (let i = 0; i < res.symptoms.length; i++)
            {
                //Date Time
                let datetime = new Date(res.symptoms[i].inputdate)

                res.symptoms[i].inputdate = datetime.getDate() + "/"
                + (datetime.getMonth() + 1) + "/" + datetime.getFullYear()

                //Location href

                if (res.symptoms[i].location)
                {
                    Object.assign(res.symptoms[i].location, {
                    link : "https://www.google.com/maps/search/" +
                            res.symptoms[i].location.coordinates[1] + ","
                            + res.symptoms[i].location.coordinates[0]})
                }
            }

            if (res.color == "RED")
            {
                res.color = '<span style="color: #C70039;">แดง</span>'
            }
            else if (res.color == "YELLOW")
            {
                res.color = '<span style="color: #fcba03;">เหลือง</span>'
            }
            else if (res.color == "GREEN")
            {
                res.color = '<span style="color: green;">เขียว</span>'
            }
            else
            {
                Object.assign(res, {color: "N/A"})
            }

            Object.assign(res, {day_count: date_diff(res.createdate * 1000)})

            //Use to replace data
            /*
            รูปแบบการเรียกใช้
            1.#   hash_replace ( object หลักที่ต้องการให้ไปค้นหา# แล้วเปลี่ยน ,   "PREFIX ของคำแรกที่ต้องการค้นหา ตามด้วยชื่อ field และหรือ . ของ field ย่อยๆ " , Data)
            2.    hash_replace (  HTML STRING ต้องการให้ไปค้นหา# แล้วเปลี่ยน ,   "PREFIX ของคำแรกที่ต้องการค้นหา ตามด้วยชื่อ field และหรือ . ของ field ย่อยๆ " , Data)

            ข้อ 2 จะ return มาเป็น HTML อีกที
            */

            let tmp;
            tmp = hash_replace($('#patient_description'),"PATIENT",res)
            $("#patient_description_showing").html(tmp)

            //แยก Template กับ Display
            tmp = hash_replace(template_symptomlist,"SYMPTOMS",res.symptoms.reverse())
            $("#row_symptomlist_showing").html(tmp)

      })
    }

        function date_diff(date1)
        {
            let dateOnly = new Date()
            console.log(dateOnly)

            let date2 = Date.parse(new Date(dateOnly.getFullYear(), dateOnly.getMonth(), dateOnly.getDate()))
            console.log(new Date(date2))

            return parseInt((date2 - date1) / 86400000)
        }
        function sendToLine()
        {
            var patientid = getParameterByName('id', window.location.search);
            let message = $("#lineSender").val()

            let payload =
            {
                _id : patientid,
                message: message
            }

            $.postJSON(MAINURL + "/api-backend/admin/patient_sendline", payload, (msg) =>
            {
                if (msg.code == 200)
                {
                    console.log(msg);
                    return alert("ส่งข้อความสำเร็จ")
                }
                else
                {
                    console.log(msg);
                    return alert("เกิดปัญหาระหว่างส่งข้อความ")
                }
            })
        }

        function colorFix()
        {
            var patientid = getParameterByName('id', window.location.search);
            let color = $("#color_picker").val();

            if (color == "NA")
            {
                return alert("กรุณาเลือกสี")
            }

            let payload = {
                id : patientid,
                color: color
            }

            $.postJSON(MAINURL + "/api-backend/admin/color_changer", payload, (msg) =>
            {
                console.log(msg)

                if (msg.code == 200)
                {
                    return alert("แก้ไขสีเรียบร้อย")
                }
                else
                {
                    return alert("เกิดปัญหาระหว่างแก้สี โปรดลองใหม่อีกครั้ง")
                }
            })
        }
        </script>
