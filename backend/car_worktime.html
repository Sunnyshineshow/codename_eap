<style>

  .external-event-calendar {
      border-right: 1px solid #ccc;
  }

  .external-event-task {
      color: #fff;
      padding: 10px;
      margin: 20px;
      border-radius: 8px;
      font-family: -apple-system, Segoe UI, Roboto, sans-serif;
  }

  .demo-external-event-presets.demo-wrapper,
  .demo-external-event-presets .mbsc-grid,
  .demo-external-event-presets .mbsc-row,
  .demo-external-event-presets .external-event-calendar {
      height: 100%;
  }





  .md-work-week-cont {
      position: relative;
      padding-left: 50px;
  }

  .md-work-week-avatar {
      position: absolute;
      max-height: 50px;
      max-width: 50px;
      top: 21px;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      left: 20px;
  }

  .md-work-week-name {
      font-size: 16px;
  }

  .md-work-week-title {
      font-size: 12px;
      margin-top: 5px;
  }

.md-timeline-template .mbsc-schedule-event.mbsc-ltr {
    height: auto !important;
}

.md-timeline-template-event {
    border: 1px solid transparent;
    margin: 2px 0;
}

.md-timeline-template-event-cont {
    background: rgba(255, 255, 255, .8);
    font-size: 15px;
    height: 32px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

.md-timeline-template-event-cont .mbsc-icon {
    padding: 5px;
    box-sizing: content-box;
}

.mbsc-timeline-event-start .md-timeline-template-event,
.mbsc-timeline-event-start .md-timeline-template-event-cont,
.mbsc-timeline-event-start .md-timeline-template-event-cont .mbsc-icon {
    border-top-left-radius: 20px;
    border-bottom-left-radius: 20px;
}

.mbsc-timeline-event-end .md-timeline-template-event,
.mbsc-timeline-event-end .md-timeline-template-event-cont,
.mbsc-timeline-event-end .md-timeline-template-event-cont .mbsc-icon {
    border-top-right-radius: 20px;
    border-bottom-right-radius: 20px;
}

.md-timeline-template-event-cont .mbsc-icon:before {
    color: #fff;
    font-size: 18px;
}

.md-timeline-template-time {
    margin: 0 10px;
}

.md-timeline-template-title {
    color: #666;
}

.md-timeline-template .mbsc-timeline-column,
.md-timeline-template .mbsc-timeline-header-column {
    min-width: 100px;
}

.md-timeline-template .mbsc-timeline-resource,
.md-timeline-template .mbsc-timeline-row {
    min-height: 100px;
}
  </style>
<div class="main_page mb-12" style="margin-top:100px;">

        <div class="container">
            <h4 class="p-0 m-0 mb-3"><b>ตารางงานเดินรถ</b></h4>
            <form class="form-row" onsubmit="return pre_search();">
              <div class="row">
                <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
                  <input type="text" class="form-control" id="search_name" placeholder="ค้นหา ชื่อคนขับ หรือ เลขทะเบียน">
                </div>
                <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
                  <input type="text" class="form-control" id="search_tag" placeholder="ค้นหาตาม Tags">
                </div>
                <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
                  <input type="text" class="form-control" id="search_appointid" placeholder="ค้นหา ตาม Appointment ID">
                </div>
                <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                    Search
                  </button>
                </div>
              </div>
            </form>

            <div class="mbsc-row">
              ** ระบบค้นหารถมากที่สุด เพียง 10 คน
              </div>
<div class="mbsc-grid mbsc-no-padding">
    <div class="mbsc-row">
    <div class="mbsc-col-sm-9 external-event-calendar">
            <div id="car-working" style="height:100%;"></div>

          </div>
     <div class="mbsc-col-sm-3">
       <div class="mbsc-form-group-title" >ผู้ป่วยรอคิวรถ</div>
       <div id="patient_waiting" ></div>

        </div>
      </div>
</div>
    </div>


  </div>


  <div id="external-event-dialog" class="mbsc-cloak">
    <div mbsc-form>
      <div class="mbsc-form-group-inset">
          <label >
              นัดหมาย #  <span id="patientname"> </span>
          </label>
          <br>
          <label >
              เวลานัดหมาย:  <span id="pickup_date"> </span>

          </label>
          <br>
          <label >
              เวลาเริ่มต้นเดินรถ:  <span id="pickup_begin"> </span>
          </label>
          <br>
          <label >
              เวลาเริ่มสิ้นสุดเดินรถ:  <span id="pickup_end"> </span>
          </label>
          <br>
          <label >
              รับที่:  <span id="pickup_org"> </span>
          </label>
          <br>
          <label >
              ส่งที่:  <span id="send_org"> </span>
          </label>
          <br>
          <label for="external-event-job">
              ใส่หมายเหตุ
          </label>
          <label for="external-event-details">
              <textarea id="external-event-details" mbsc-textarea data-label="Details" placeholder="หมายเหตุ"></textarea>
          </label>
          <br>
          <font color='red'><span id="warntext" > </span></font>
            <label>
              <button type="button" class="btn btn-primary "onclick="lockevent()" id="btn_lockevent">
                <i class="fas fa-save"></i>
                  Confirm Lock jobs
              </button>
          </label>


      </div>
      </div>
  </div>

<script>

  var carcalendar;
  var editingobj;
  var current_appoint;
  var current_car;
  function pre_search(){
    // clear search url from lastsearch
    getvehicle({
      search_name : $('#search_name').val(),
      search_appointid :$('#search_appointid').val()
    });
    //refreshpage(undefined,true);
    return false;
  }
  var randcolor = ["#7a5886","#9da721","#cd6957","#637e57","#50789d","#6c5d45"]
  function  refreshpage(rawdata,clearsearch) {

    console.log("GLOBAL_USER",GLOBAL_USER)
        if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1 && GLOBAL_USER.role.indexOf("DRIVER") == -1 && GLOBAL_USER.role.indexOf("VOLUNTEER") == -1)){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }
        get_unqueue()
        getvehicle();

  }
  function set_event(obj,all_event){
        mobiscroll.setOptions({
        locale: mobiscroll.localeTh,
        theme: 'ios',
        themeVariant: 'light',
    });

    $(function () {

        carcalendar = $('#car-working').mobiscroll().eventcalendar({
            view: {
                timeline: {
                    type: 'day'
                }
            },
            renderResource: function (resource) {
                return '<div class="md-work-week-cont">' +
                    '<div class="md-work-week-name">'+ resource.title + '</div>' +
          //          '<div class="md-work-week-title">' + resource.title + '</div>' +
                    '<div class="md-work-week-avatar" ><a href="/admin/vehicle_list?find_id='+resource.id+'" target="_blank">#'+ resource.id +"</a>:</div>" +
                    //  `<div><small>unsave</small></div>`+
                    '</div>';
            },
            renderScheduleEvent: function (data) {
                var ev = data.original;
                var color = data.color;

                return '<div class="md-timeline-template-event" style="border-color:' + color + ';background:' + color + '">' +
                    '<div class="md-timeline-template-event-cont">' +
                    //'<span class="mbsc-icon mbsc-font-icon mbsc-icon-' + ev.taskType + '" style="background:' + color + '"></span>' +
                    (ev.unsave || '') +
                    '<span class="md-timeline-template-time" style="color:' + color + ';">' + data.start + '</span>' +
                    '<span class="md-timeline-template-title">' + ev.title + '</span></div></div>';
            },
            extendDefaultEvent: function () {
                return {
                    taskType: 'cogs'
                };
            },
            clickToCreate: false,
            dragToCreate: false,
            dragToResize: true,
            dragToMove: true,
            externalDrop: true,

            onEventCreated: function (args) {
                $(".appoint_id" +args.event._id).hide("slow");
                var res = getobjbyid(current_car,args.event.resource)
                args.event.color = res.color;
                console.log("Created",args)
            //    fillDialog(args);
            },
            onEventClick: function (args) {
                       editingobj = args.event
                       console.log("click",args.event)
                       fillDialog(args);

                   },
            onEventCreateFailed: function () {
                alert( 'Can\'t create event on this date');
            },
            onEventUpdateFailed: function () {
                alert( 'Can\'t add event on this date');
            },
            data: all_event  ,
            resources:obj
        });

        var dialog = $('#external-event-dialog').mobiscroll().popup({
            display: 'center',
            width: 400,
            contentPadding: false,
            touchUi: false,
            headerText: 'Assign task',
            buttons: ['close'],
        }).mobiscroll('getInst');

           function fillDialog(args) {
               console.log("arg",args)
               var res = getobjbyid(current_car,args.event.resource)
               var q = args.event;
               console.log("GOT Res",res)
               var start =new Date(q.start)/1000;
               var end =new Date(q.end)/1000;
               if(q.pickup_date >= start && q.pickup_date <= end){
                  $('#pickup_date').html(moment(q.pickup_date,"X").format("DD-MM-YY HH:mm"));
                  $('#btn_lockevent').attr("disabled",false)
                  $("#warntext").html("")
               }else{
                 $('#btn_lockevent').attr("disabled",true)
                  $('#pickup_date').html("<font color='red'>"+ moment(q.pickup_date,"X").format("DD-MM-YY HH:mm")) + "</font>";
                  $("#warntext").html("เลือกวันที่ให้ตรงกับวันนัดหมาย ก่อนการบันทึก")
               }

               $('#patientname').html(q._id +":"+ q.patient.firstname + " " + q.patient.mobileno);
               $("#external-event-details").val(q.comments || "");
               $('#pickup_begin').html(moment(q.start).format("DD-MM-YY HH:mm"));
               $('#pickup_end').html(moment(q.end).format("DD-MM-YY HH:mm"));
               $('#pickup_org').html("บ้านผู้ป่วย");
               $('#send_org').html("X-ray");
               dialog.open();
           }
    });

    return false;
  }
  function lockevent(){
    console.log(editingobj);
    // update to server
    var res = getobjbyid(current_car,editingobj.resource)
    var postdata = {
      _id:editingobj._id,
      starttime : Math.floor(editingobj.start/1000),
      endtime : Math.floor(editingobj.end/1000),
      vehicle:res._id,
      comments: $("#external-event-details").val()

    };
    console.log("Posting",postdata)

    $.postJSON(MAINURL + "/api-backend/admin/assing_driver_job",postdata  ,(msg) => {
      if(msg.result){
        editingobj.editable = false;
        alert_success("บันทึกคิวแล้ว");
        $('#external-event-dialog').mobiscroll("getInst").close();
      }else{
        alert(msg.detail)
      }
    });


  }
  function getvehicle(dataseaerch){
    if(!dataseaerch) dataseaerch = {};
    $.postJSON(MAINURL + "/api-backend/admin/vehicle_list",dataseaerch  ,(msg) => {
        console.log("v",msg)
        var data_resouse = []
        if(Array.isArray(msg.vehicle)){
          current_car =msg.vehicle;
            current_car.map((car)=>{
              data_resouse.push({
                id: car._id,
                title: car.Fullname,
                name:car.staff.displayName,
                img: car.Picture,
                color: randcolor[ car._id % 5]

              })
            });
        }
        var all_event =[]
        if(Array.isArray(msg.q)){
          msg.q.map((q)=>{
            q.start = new Date(q.starttime*1000);
            q.end = new Date(q.endtime*1000);
            q.title = q.patient.firstname ? q.patient.firstname : "PatientID:" + q.patient ;
            q.resource =  q.vehicle;
            q.editable = false;

          });

        }
        console.log("all_event",msg.q)
        set_event(data_resouse,msg.q)


    });
  }

  function get_unqueue(dataseaerch,cb){
    if(!dataseaerch) dataseaerch = {};
    $.postJSON(MAINURL + "/api-backend/admin/apooint_car_free",dataseaerch  ,(msg) => {
        console.log("q",msg)
        var waiting = []
        var html_queue ='';
        if(Array.isArray(msg)){
            current_appoint= msg;
            msg.map((q)=>{
              q.title = q.patient.firstname ? q.patient.firstname : "PatientID:" + q.patient;
              q.color = randcolor[ q._id % 5];
              q.start =  new Date(q.pickup_date*1000);
              q.end  = new Date( (q.pickup_date + 7200)*1000 );
              html_queue+=`<div class="external-event-task appoint_id${q._id}" style="background: ${q.color};">
                  <div>#${q._id}:${q.title}</div>
                  <div>นัดหมายเวลา: ${moment(q.pickup_date,"X").format("DD-MM-YY HH:mm")}</div>
                  <div>${q.address.address} ${q.address.district} ${q.address.province}</div>`
                    if(q.location){
                        html_queue+=`<div><a href="https://www.google.com/maps/search/${q.location.coordinates[1]},${q.location.coordinates[0]}"   target="_blank">
                            <button type="button" class="btn btn-sm btn-primary"><i class="fas fa-map-marker-alt"></i> Map</button></a></div>
                          `
                    }
                    html_queue+= `</div>`
            })
            $('#patient_waiting').html(html_queue)
            $('.external-event-task').each(function (i, o) {
               $(o).mobiscroll().draggable({ dragData: current_appoint[i] });
           });

        }
    });
  }





</script>
