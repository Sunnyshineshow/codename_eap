<div class="main_page mb-5" style="margin-top:100px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">
      <!--Counter-->
      <div class="position-relative" style="text-align: center;">
        <div class="row">
          <div class="col-md-4 mt-2">
            <div onclick="go2View('patientlist?find_color=YELLOW')" class="card bg-warning border-0" style="box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;">
              <h3>Auto Appointment by fillter <br>(max 100 list)</h3>
            </div>
          </div>
        </div>
      </div>
        <form class="form-row" onsubmit="return pre_search();">
      <div class="row mb-1 d-flex justify-content-start">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
              <div class="row d-flex justify-content-center ">
                <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                  <div class="input-group mb-6">
                  <div class="input-group-text">
                  <input class="form-check-input mt-0" type="checkbox" value="groupbyregister" id="groupbyregister">
                  <label class="" for="groupbyregister">
                    ดึงคนที่ลงทะเบียนร่วมด้วย
                  </label>
                  </div>
                  </div>
                </div>

                  <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                    <div class="input-group mb-6">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="checkbox" value="complete" id="complete" checked>
                          <label  for="complete">
                              ลงทะเบียนสำเร็จเท่านั้น
                              </label>
                    </div>
                    </div>

                  </div>
                  <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-3">
                    <div class="input-group mb-6">
                    <div class="input-group-text">

                      <input class="form-check-input mt-0" type="checkbox" value="newly" id="newly" checked  >
                      <label for="newly" > ไม่มีคิวในระบบ </label>

                    </div>

                    <input type="text" id="newlyday" class="form-control" aria-label="Text input with checkbox" placeholder="" value=0>
                    <span class="input-group-text">วัน </span>
                  </div>
                </div>
                  <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-3">
                    <div class="input-group mb-6">
                    <div class="input-group-text">
                      <input class="form-check-input mt-0" type="checkbox" value="caseconfirm" id="caseconfirm"   >
                      <label for="caseconfirm" >  เคยมานัดหมายเมื่อ </label>

                    </div>

                    <input type="text" id="caseconfirmday" class="form-control" aria-label="Text input with checkbox" placeholder="" value=2>
                    <span class="input-group-text">วัน </span>
                  </div>
                    </div>
                    <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                      <div class="input-group mb-6">
                      <div class="input-group-text">
                        <label for="caseconfirm" >ลงทะเบียนเมื่อ</label>

                      </div>

                      <input type="text" id="registerday" class="form-control" aria-label="Text input with checkbox" placeholder="" value=0>
                      <span class="input-group-text">วันก่อน</span>
                    </div>
                      </div>
                </div>
          </div>
      </div>
      <div class="row mb-1 d-flex justify-content-start">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">

            <div class="row d-flex justify-content-center ">


              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <input type="text" class="form-control" id="search_idno" placeholder="ID">
                </div>
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_name" placeholder="ชื่อ">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_surname" placeholder="นามสกุล">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_subdistrict" placeholder="แขวง/ตำบล">
              </div>

              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_district" placeholder="เขต/อำเภอ">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_zip" placeholder="zipcode">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_comment" placeholder="ค้าหาตามหมายเหตุ">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <select class="form-select" aria-label="search_travel" id="search_travel">
                    <option value=""  selected>เลือกการเดินทาง</option>
                    <option value="รถส่วนตัวได้">รถส่วนตัวได้</option>
                    <option value="รถส่วนตัวได้บางครั้ง">รถส่วนตัวได้บางครั้ง</option>
                    <option value="ต้องการรถจากศูนย์">ต้องการรถจากศูนย์</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_tel" placeholder="หมายเลขโทรศัพท์">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <select class="form-select" aria-label="สีของผู้ป่วย" id="search_color">
                    <option value=""  selected>เลือกสี</option>
                    <option value="NONE">ยังไม่ระบุ</option>
                    <option value="GREEN">เขียว</option>
                    <option value="YELLOW">เหลือง</option>
                    <option value="RED">แดง</option>
                    <option value="WHITE">สิ้นสุด</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <button type="submit" class="btn btn-primary border-0">
                    <i class="fas fa-search"></i>
                    Search
                  </button>
                </div>
              </div>
            </div>

        </div>
      </div>
    </form>
      <!-- แบ่งหน้า -->
      <div class="row mt-4">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div>
      <!-- // แบ่งหน้า -->

      <div class="table-responsive mt-2">
        <table class="table table-bordered table-hover show_startpage font-weight-light" >
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">เลือก</th>

              <th scope="col" class="text-secondary">Display Name</th>
              <th scope="col" class="text-secondary">ชื่อ-นามสกุล /บัตร</th>
              <th scope="col" class="text-secondary">ที่อยู่</th>
              <th scope="col" class="text-secondary">เบอร์โทร/Register</th>
              <th scope="col" class="text-secondary">Day Count</th>
              <th scope="col" class="text-secondary">Color</th>
              <th scope="col" class="text-secondary">Travel</th>
              <th scope="col" class="text-secondary">Register Status</th>
              <th scope="col" class="text-secondary">Action</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
             <td class="text-center table-middle" rowspan=2>
              <div class="form-check">
                <input class="form-check-input autopatient" type="checkbox" value="##patient-id##" id="selectpatient##patient-id##"  checked onclick="recalulate()">
                <label class="form-check-label" for="selectpatient##patient-id##">
                  ###patient-id##
                  <img src="##patient-pictureUrl##" style="max-width:50px;" class="rounded-circle">
                </label>

              </div>
            </td>


              <td class="text-center table-middle"><span id="Admin_color"></span>##patient-AdminColor## ##patient-displayName##
              </td>

              <td class="text-center table-middle" nowrap="nowarp">##patient-firstname## ##patient-lastname## (##patient-age## ปี)
                <br>##patient-idcard##

              </td>

              <td class="text-center table-middle">##patient-address.subdistrict## อ.##patient-address.district## จ.##patient-address.province## ##patient-address.zipcode##</td>
              <td class="text-center table-middle">##patient-mobileno## <br><small>##patient-createDate##</small></td>

              <td class="text-center table-middle">##patient-day_count##</td>
              <td class="text-center table-middle"><span id="patient_color">##patient-color##</span></td>
              <td class="text-center table-middle">##patient-travelprefer##</td>
              <td class="text-center table-middle" rowspan=2>##patient-status##
                <br>
<font color='blue'>##patient-comment##</font>
 ##patient-otherpatient##
              </td>

              <td class="text-center" rowspan=2>
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="view_symptom('##patient-id##')">รายละเอียด</button>
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="update_comment('##patient-id##')">ใส่หมายเหตุ</button>
              </td>
            </tr>
            <tr >
              <td colspan="5">
                <span  nowrap="warp"><small>ลงทะบียน <font color='blue'>##patient-createdate## </font>อาการล่าสุด :   ##patient-lastsymptomdetail## ##patient-init_symptoms.disease##
                  ##patient-init_symptoms.symptoms##  ##patient-init_symptoms.comment##

                </small> </span>
              </td>
              <td colspan=2>
                <small><a href="/admin/appointment?find_patientid=##patient-id##" target="_blank">ดูนัดหมาย</a></small>
              </td>
              </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>
      <!-- // end table -->

      <div class="col-12 col-sm-12 col-md-6 col-lg-6">
        <div class="form-group">
          สถานพยาบาล
          <select class="form-select" aria-label="" id="autohospital">
            <option  disabled>Select ศูนย์ X-ray</option>
            <option value="1">นเรนทร กรุงเทพฯใต้ </option>
            <option value="2">Closed Site </option>
            <option value="3" selected >นเรนทร กรุงธนเหนือ 	</option>
          </select>
          </div>
            </div>
            <br>
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
        <div class="form-group">
          เพิ่มผู้ป่วยเข้าไปในระบบ จำนวน  <span id="totalrecord" class ="badge bg-danger"> </span> คน
          ระบุ วันเวลาเริ่มต้นที่ ให้ค้นหาคิว
          <input type="datetime-local" class="form-control" id="autodatestart">
        </div>
      </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
        <div class="form-group">
          <br>
          <button type="submit" class="btn btn-primary border-0" onclick="submitauto()">
            <i class="fas fa-search"></i>
            Add new Appointment
          </button>
        </div>
      </div>


    </div>
  </div>
</div>
<div class="modal" tabindex="-1" id="p_comment">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ใส่หมายเหตุ สำหรับผู้ป่วยรายนี้</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><input class="form-control" id="patient_comment" placeholder="หมายเหตุ"> </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="finish_comment()" >Save changes</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var template_patient_row = $('#row_patientlist').html();
  var fncsearch;
  // var global_color;

  function pre_search(){

    // clear search url from lastsearch
    var searchdata ={};
    if ($('#search_name').val() !== "") {
      searchdata.findname= $('#search_name').val()
    }

    if ($('#search_surname').val() !== "") {
      searchdata.find_surname = $('#search_surname').val()
    }
    if ($('#registerday').val() > 0) {
      searchdata.find_registerday = $('#registerday').val();
    }

    if ($('#search_idno').val()) {
      searchdata.find_id= $('#search_idno').val()
    }
    if ($('#search_cid').val()) {
      searchdata.find_idcard = $('#search_cid').val()
    }
    if ($('#search_district').val()) {
      searchdata.find_district = $('#search_district').val()
    }
    if ($('#search_subdistrict').val()) {
      searchdata.find_subdistrict= $('#search_subdistrict').val()
    }


    if ($('#search_zip').val()) {
      searchdata.find_zipcode= $('#search_zip').val()
    }
    if ($('#search_comment').val()) {
      searchdata.find_comment= $('#search_comment').val()
    }
    if ($('#search_travel').val()) {
      searchdata.find_travel= $('#search_travel').val()
    }
    if ($('#search_passport').val()) {
      searchdata.find_passport = $('#search_passport').val()
    }

    if ($('#search_tel').val() !== "") {
      searchdata.find_tel= $('#search_tel').val()
    }

    if ($('#search_color').val() != "NONE") {
      searchdata.find_color = $('#search_color').val()
    }
    if($('#groupbyregister').is(":checked")){
        searchdata.find_grouping =  "groupbyregister"
    }
    if($('#newly').is(":checked")){
        searchdata.find_newly= $('#newlyday').val()
    }


    if($('#caseconfirm').is(":checked")){
        searchdata.find_caseconfirm = $("#caseconfirmday").val()
    }

    if($('#complete').is(":checked")){
        searchdata.find_completeregister = "complete"
    }


    fncsearch({  search: searchdata});
    return false;
  }
  function refreshpage(rawdata,clearsearch) {
    console.log("GLOBAL_USER",GLOBAL_USER)

    var search_setting = {
      posturl: '/api-backend/admin/patientlist',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_patient_list,
      limit: 100,
      search: {find_completeregister : "complete",find_newly:"0"}    //default searching
    }

    var pagenumber = getParameterByName('page', window.location.search);
    if (pagenumber > 1) {
      search_setting.page = pagenumber;
    }
    // console.log('SEARCH ', search_setting);
    fncsearch = ADV_search(search_setting,clearsearch); // Defult always search at first
    return false;
  }
  function map_html_to_obj(html,obj){

  }
  var html_obj = {search_comment:"find_comment",
                  search_comment:"search_surname",
                  search_subdistrict:"find_subdistrict",
                  search_district:"find_district",
                  search_travel:"find_travel"
                }
  function map_obj_to_html(obj,html){
    if(typeof(obj)=='object'){
        var keys = Object.keys(obj)
        for(var x=0; x < keys.length;x++){
            if(obj[keys[x]] !==undefined ){
                var test = check_objkeymatch(html,keys[x])
                if(test) {
                    $('#' + test).val(obj[keys[x]])
                }
            }
        }
    }
  }
  function check_objkeymatch(obj,key){
      var keys = Object.keys(obj)
      for(var x=0; x < keys.length;x++){
        if(obj[keys[x]] == key){
            return keys[x];
        }
      }
  }
  function show_patient_list(objdata, totalrecord,filed2show,queryobj) {

    if(queryobj){
      map_obj_to_html(queryobj.search,html_obj)
      console.log("queryobj",queryobj)
    }
    if (objdata.result && totalrecord > 0) {
      $('#totalrecord').html(totalrecord);
      working.patient = objdata.obj;
      //console.log("OBJDATA: " + objdata.obj)
      var STATUSSHOW =["สิ้นสุดกระบวนการ","ยังไม่ได้ลงทะเบียน","ลงทะเบียนแล้ว","ยังลงทะเบียนไม่เสร็จ (2/3)","ยังลงทะเบียนไม่เสร็จ (1/3)"]
      objdata.obj.map(item => {
        // console.log(item)
        // let datetime = new Date(res.symptoms[i].inputdate)
        // res.symptoms[i].inputdate = datetime.getDate() + "/"
        // + (datetime.getMonth() + 1) + "/" + datetime.getFullYear()
        item.init_symptoms ? item.day_count =  moment(item.init_symptoms.checkdate, "X").fromNow(true) : item.day_count = "N/A"

         item.createdate ? item.createdate = moment(item.createdate, "X").fromNow('days') + " ที่แล้ว": "";
         item.status = STATUSSHOW[item.status] || "ไม่มีข้อมูล";
         if (item.color == "RED") {
           item.color = '<span style="color: #C70039;">RED</span>'
         } else if (item.color == "YELLOW") {
           item.color = '<span style="color: #fcba03;">YELLOW</span>'
         } else if (item.color == "GREEN") {
           item.color = '<span style="color: green;">GREEN</span>'
         }else if (item.color == "WHITE") {
            item.color = 'สิ้งสุดกระบวนการ'
          }else{
           item.color = "N/A"
         }
        // item.createDate ? item.createdate = datetime.getDate() + "/" + (datetime.getMonth() + 1) + "/" + datetime.getFullYear() :
        if (item.color_change > 0)
        {
          item.color_change = '<span style="color: #C70039;"> +' + item.color_change +'</span>'
        }
        else if (item.color_change < 0)
        {
          item.color_change = '<span style="color: green;">' + item.color_change +'</span>'
        }
        else if (item.color_change == 0)
        {
          item.color_change == 0
        }
        else
        {
          item.color_change = "-"
        }
          var temp_other='';
          if(Array.isArray(item.otherpatient) &&  item.otherpatient.length > 0 ){
              temp_other = "<br>ลงทะเบียนแทน  "
              item.otherpatient.map((o)=>{
                temp_other +=`<a href="/admin/patientlist?find_id=${o}" target="_blank">#${o} </a> `
              });
              item.otherpatient = temp_other;
          }
          if(item.main_userid){
              item.otherpatient = `<br>ลงทะเบียนแทน <b> โดย Patient# <a href="/admin/patientlist?find_id=${item.main_userid}"> ${item.main_userid} </a> `;
          }

        item.active ? item.active = '<b class="text-success">เปิดใช้งาน</b>' : item.active = '<b class="text-danger">ปิดใช้งาน</b>';
        if(item.lastsymptom){
          item.lastsymptomdetail = "Breathing: "+item.lastsymptom.breathing +" spo_room_air:" +item.lastsymptom.spo_room_air
          item.lastsymptomdetail += "<BR>"
        }
        if(item.init_symptoms){
        //  item.lastsymptomdetail = "Breathing: "+item.lastsymptom.breathing +" spo_room_air:" +item.lastsymptom.spo_room_air
        //  item.lastsymptomdetail += "<BR>"
        }
      })




      var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
      $("#show_patientlist").html(html_row);
      // $('.show_startpage').show('slow');

    } else {
      $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
    }
  }

  function view_symptom(patient_id) {

    go2View("patient?id=" + patient_id)

  }

  var working_patient;
  function update_comment(patient_id){
    working_patient = patient_id
    $("#p_comment").modal('show')
    //patient_id
  }
  function finish_comment(){
    $("#p_comment").modal('hide')
    if(! $('#patient_comment').val()) {
      alert("Comment is empty")
      return;
    }
    var data = {
      patient : working_patient,
      comment: $('#patient_comment').val()
    }
    $.postJSON(MAINURL + '/api-backend/admin/update_comment',data,(msg)=>{
        refreshpage();
    })

  }
  function recalulate(){
    $('#totalrecord').html($('.autopatient:checked').length - 1)
  }
  function submitauto() {
    if(!$('#autohospital').val()){
      alert ("Please Select hospital")
      return;
    }
    if(!$('#autodatestart').val()){
      alert ("Please Select Date ในการเริ่มทำระบบ Auto")
      return;
    }

    if(!confirm("คุณกำลังเลือกคนกลุ่มนี้ให้เข้าคิวในระบบ ?")){
      return;

    }
    // all patientid
    var allpatient = [];
    var obj =$('.autopatient:checked');
    console.log();
    for(var x=0; x < obj.length;x++){
      if($(obj[x]).val() > 0)
      allpatient.push($(obj[x]).val())
    }

    console.log("Datetime",$('#autodatestart').val())
    var postData ={
        hospital:$('#autohospital').val(),
        patient: allpatient,
        appointtime: Math.floor(new Date($('#autodatestart').val())/1000)
    }
    if(Number(postData.appointtime) > 0 ){
      $.postJSON(MAINURL + '/api-backend/admin/appoint/auto',postData,(msg)=>{
          alert_success("นำผู้ป่วยเข้าคิวแล้ว")
          refreshpage();
      })
    }else{
        alert ("คุณไม่ได้เลือกวันที่หรือ กรุณาใช้ Chrome เพื่อใช้งานวันที่")
    }


    console.log(postData);

  }

  function settingpatient(dataid) {
    working.active_patientid = dataid;
    go2View('patient-edit');
  }



</script>
