<div>
    <!-- PATIENT VIEW -->
    <div class="main_page mb-5" style="margin-top:120px;">
      <div class="container">
        <!-- <div class="card"> -->
        <!-- <div class="card-body" style="width: 85%;"> -->
        <div class="p-2 mr-5 ml-5" id="main_paitient_info">
          <h3> <b>Verify</b></h3>
          <!-- profile -->
          <div id="patient_description" style="display: none;">
            <div class="row mt-5">
              <div class="col-md-6">
                <div class="card shadow-none bg-light" style="max-width: 100% !important;">
                  <div class="card-body" style="text-align: left;">
                    <h4 style="color: #289de9;">รายละเอียด</h4>
                    <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
                    <div class="text-center">
                      <img src="##PATIENT-pictureUrl##" alt="Patient Image" width="20%" height="auto" class="rounded-pill text-center max-auto">
                    </div>
                    <p class="m-0 p-0 mt-3"><strong>ID:</strong> ##PATIENT-id##</p>
                    <p class="m-0 p-0 mt-3"><strong>ชื่อ:</strong> ##PATIENT-nametitle####PATIENT-firstname## ##PATIENT-lastname##</p>
                    <p class="m-0 p-0"><strong>อายุ:</strong> ##PATIENT-age##</p>
                    <p class="m-0 p-0"><strong>วันเกิด:</strong> ##PATIENT-birthday##</p>
                    <p class="m-0 p-0"><strong>เพศ:</strong> ##PATIENT-gender##</p>
                    <p class="m-0 p-0 mt-3"><strong>แพ้ยา:</strong> ##PATIENT-allergic##</p>
                    <p class="m-0 p-0 mt-3"><strong>ที่อยู่:</strong></p>
                    <p class="m-0 p-0">##PATIENT-address.address## ##PATIENT-address.lane## ##PATIENT-address.road## ##PATIENT-address.subdistrict## ##PATIENT-address.district## ##PATIENT-address.province## ##PATIENT-address.zipcode##</p>
                    <p class="m-0 p-0 mt-3"><strong>Email:</strong> ##PATIENT-email##</p>
                    <p class="m-0 p-0"><strong>เบอร์โทร:</strong> ##PATIENT-mobileno##</p>
                    <p class="m-0 p-0 mt-3"><strong><span style="color: #C70039;">ข้อมูลติดต่อฉุกเฉิน</span></strong></p>
                  <p class="m-0 p-0"><strong>ชื่อ:</strong> ##PATIENT-emergency.firstname_contact## ##PATIENT-emergency.lastname_contact##</p>
                  <p class="m-0 p-0"><strong>เบอร์โทร:</strong> ##PATIENT-emergency.tel##</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card shadow-none bg-light" style="max-width: 100% !important;">
                  <div class="card-body" style="text-align: left;">
                    <h4 class="card-title" style="color: #289de9;">อาการเมื่อลงทะเบียน </h4>
                    <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
                    <p class="m-0 p-0"><strong>อาการปัจจุบัน:</strong> ##PATIENT-symptoms.symptoms##</p>
                    <p class="m-0 p-0 mt-3"><strong>โรคประจำตัวที่มี<span style="color: #C70039;">ความเสี่ยง</span>:</strong></p>
                    <p class="m-0 p-0"><span style="text-align: justify;">##PATIENT-init_symptoms.disease##</span></p>
                    <p class="m-0 p-0 mt-3"><strong>spO2:</strong>
                      <span style="text-align: justify;">##PATIENT-symptoms.spo_room_air##</span>
                    </p>
                    <p class="m-0 p-0 mt-3"><strong>ระดับออกซิเจนในเลือดหลังออกกำลังกาย:</strong>
                      <span style="text-align: justify;">##PATIENT-symptoms.exercise_test##</span>
                    </p>
                    <p class="m-0 p-0 mt-3"><strong>ข้อมูลเพิ่มเติม:</strong></p>
                    <p class="m-0 p-0"><span style="text-align: justify;">##PATIENT-symptoms.comment##</span></p>
                    <p class="m-0 p-0 mt-3"><strong>สีของผู้ป่วย:</strong> <span id="patient_color" style="text-align: justify;">##PATIENT-color##</span></p>
                    <p class="m-0 p-0 mt-3"><strong>จำนวนวันตั้งแต่ที่มีอาการ:</strong> <span id="patient_color" style="text-align: justify;">##PATIENT-day_count##</span></p>
                    <button type="button" class="btn btn-primary mt-4 mb-3" onclick="clickToAppoint()"> ดูรายละเอียดเพิ่มเติม</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="patient_description_showing">
          </div>
          <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:50px;"></div>
  
          <div class="row">
            <div class="col-12">
              <div class="card shadow-none bg-light" style="max-width: 100% !important;">
                <div class="card-body" style="text-align: left;">
                  <h4 style="color: #289de9;">บันทึก</h4>
                  <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
                  <strong>กรอกข้อความที่นี่</strong><br>
                  <textarea id="callcen_comment" class="form-control" rows="5" type="text"></textarea>
                </div>

                <form class="form-inline">
                
                <h4 style="color: #289de9;">แก้ไขสีของผู้ป่วย</h4>
                <div class="form-group mb-2">
                  <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
                  <select id="color_picker" class="form-select form-select-lg mt-5 mb-0">
                    <option selected value="NA">เลือกสี</option>
                    <option value="GREEN" style="color: green;">เขียว</option>
                    <option value="YELLOW" style="color: #fcba03;">เหลือง</option>
                    <option value="RED" style="color: red;">แดง</option>
                  </select>
                </div>

                  <div class="form-group mx-sm-3 mb-2">
                        <input class="btn btn-dark border-0 mt-3" style="background-color: #1597BB;" type="button" id="data_tosave" value="บันทึก" onclick="save_data()">
                      <br>
                      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:50px;"></div>
                      <p id="isverify_output"></p>
                      <br>
                  </div>
                
            </form>
                </div>
              </div>
              </div>
  
          
          <!-- </div> -->
  
          <!-- details -->
  
          <!-- daily symptom -->

        </div>
      </div>
      <style>
        .card {
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
          max-width: 75%;
          margin: auto;
          text-align: center;
          font-family: arial;
        }
      </style>


<script>
    var template_main_paitient_info = $('#main_paitient_info').html();
    var template_symptomlist = $("#row_symptomlist").html()

    function refreshpage(rawdata) {

      console.log("GLOBAL_USER",GLOBAL_USER)
        if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("SITEADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1 && GLOBAL_USER.role.indexOf("CALLCEN") == -1 && GLOBAL_USER.role.indexOf("VOLUNTEER") == -1 )){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }

      var patientid = getParameterByName('id', window.location.search);
      $.postJSON(MAINURL + '/api-backend/admin/callcen_patient', {
        _id: patientid
      }, (res) => {

        console.log(res)

        Object.assign(res, {
            symptoms: {}
          })

        if (!res.init_symptoms) {
          let init_symptom = {
            spo_room_air: -1,
            exercise_test: -1,
          };

          res.symptoms = init_symptom;
        }

        if (res.symptoms)
        {
          if (res.symptoms.spo_room_air == -1) {
            res.symptoms.spo_room_air = "ไม่ทราบค่า"
          }

          if (res.symptoms.exercise_test == -1) {
            res.symptoms.exercise_test = "ไม่ทราบค่า"
          }
        }
        else
        {
          if (res.init_symptoms.spo_room_air == -1) {
            res.init_symptoms.spo_room_air = "ไม่ทราบค่า"
          }

          if (res.init_symptoms.exercise_test == -1) {
            res.init_symptoms.exercise_test = "ไม่ทราบค่า"
          }
        }

        if (res.symptoms)
        {
          //Date Time
          let datetime = new Date(res.symptoms.inputdate)

          res.symptoms.inputdate = datetime.getDate() + "/" +
            (datetime.getMonth() + 1) + "/" + datetime.getFullYear()

          //Location href

          if (res.symptoms.location) {
            Object.assign(res.symptoms.location, {
              link: "https://www.google.com/maps/search/" +
                res.symptoms.location.coordinates[1] + "," +
                res.symptoms.location.coordinates[0]
            })
          }
        }

        else
        {
          //Date Time
          let datetime = new Date(res.init_symptoms.checkdate)

          res.init_symptoms.checkdate = datetime.getDate() + "/" +
            (datetime.getMonth() + 1) + "/" + datetime.getFullYear()

          //Location href

          if (res.init_symptoms.location) {
            Object.assign(res.init_symptoms.location, {
              link: "https://www.google.com/maps/search/" +
                res.init_symptoms.location.coordinates[1] + "," +
                res.init_symptoms.location.coordinates[0]
            })
          }
        }

        if (res.color == "RED") {
          res.color = '<span style="color: #C70039;">แดง</span>'
        } else if (res.color == "YELLOW") {
          res.color = '<span style="color: #fcba03;">เหลือง</span>'
        } else if (res.color == "GREEN") {
          res.color = '<span style="color: green;">เขียว</span>'
        } else {
          Object.assign(res, {
            color: "N/A"
          })
        }


        if (res.verify)
        {
          document.getElementById('data_tosave').style.display = "none"
          document.getElementById('isverify_output').innerHTML = `<span style="color: #C70039;">คนไข้คนนี้ได้มีการติดตามอาการแล้ว</span>`
        }

        Object.assign(res, {
          day_count: date_diff(res.createdate * 1000)
        })

        //Use to replace data
        /*
        รูปแบบการเรียกใช้
        1.#   hash_replace ( object หลักที่ต้องการให้ไปค้นหา# แล้วเปลี่ยน ,   "PREFIX ของคำแรกที่ต้องการค้นหา ตามด้วยชื่อ field และหรือ . ของ field ย่อยๆ " , Data)
        2.    hash_replace (  HTML STRING ต้องการให้ไปค้นหา# แล้วเปลี่ยน ,   "PREFIX ของคำแรกที่ต้องการค้นหา ตามด้วยชื่อ field และหรือ . ของ field ย่อยๆ " , Data)

        ข้อ 2 จะ return มาเป็น HTML อีกที
        */

        let tmp;
        tmp = hash_replace($('#patient_description'), "PATIENT", res)
        $("#patient_description_showing").html(tmp)

      })

    }

    function date_diff(date1) {
      let dateOnly = new Date()
      console.log(dateOnly)

      let date2 = Date.parse(new Date(dateOnly.getFullYear(), dateOnly.getMonth(), dateOnly.getDate()))
      console.log(new Date(date2))

      return parseInt((date2 - date1) / 86400000)
    }

    function sendToLine() {
      var patientid = getParameterByName('id', window.location.search);
      let message = $("#lineSender").val()

      let payload = {
        _id: patientid,
        message: message
      }

      $.postJSON(MAINURL + "/api-backend/admin/patient_sendline", payload, (msg) => {
        if (msg.code == 200) {
          console.log(msg);
          return alert_success("ส่งข้อความสำเร็จ")
        } else {
          console.log(msg);
          return alert("เกิดปัญหาระหว่างส่งข้อความ")
        }
      })
    }

    function save_data() {
      if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("SITEADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1)){
          return alert("ไม่อนุญาตให้ทำการกระทำดังกล่าว")
        }

      var patientid = getParameterByName('id', window.location.search);
      let color = $("#color_picker").val();
      let comment = $("#callcen_comment").val();

      if (color == "NA") {
        return alert("กรุณาเลือกสี")
      }

      if (!comment)
      {
        comment = "ไม่ระบุ"
      }

      let payload = {
        _id: patientid,
        color: color,
        call_cen_comment: comment
      }

      $.postJSON(MAINURL + "/api-backend/admin/callcen_verify", payload, (msg) => {
        console.log(msg)

        if (msg.code == 200) {
          alert_success("ยืนยันเรียบร้อย")
          return go2View("call_center")
        } else {
          return alert("เกิดปัญหาระหว่างยืนยัน โปรดลองใหม่อีกครั้ง")
        }
      })
    }

    function clickToAppoint() {
      var patientid = getParameterByName('id', window.location.search);
      go2View("patient?id=" + patientid)
    }

  </script>