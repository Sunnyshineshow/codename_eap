<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">
      <h3><b>รายงานอาการประจำวันของผู้ป่วย</b></h3>

      <!-- <div class="row mb-1"> -->
      <form class="form-row" onsubmit="return pre_search();">
        <div class="row d-flex justify-content-start">
          <!--
          <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
            <div class="form-group">
              <input type="text" class="form-control" id="search_name" placeholder="Search Name">
            </div>
          </div>
          -->
          <div class="col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6 mt-2">
            <div class="form-group">
              <input type="text" class="form-control" id="search_bysymptom" placeholder="ค้นหาอาการ">
              <small style="font-size:12px;">* ค้นหาผ่านอาการป่วย (<span style="color:red">หมายเหตุ: ใช้ (",") ในการขั้นโรคเช่น มีไข้ , ตาแดง</span>)</small>
            </div>
          </div>

          <div class="col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6 mt-2">
            <select class="form-select" aria-label="การหายใจของผู้ป่วย" id="search_breathing">
              <option value="NONE">โปรดเลือกการหายใจ</option>
              <option value="normal">หายใจปกติ</option>
              <option value="heavy">เหนื่อยหอบ</option>
              <option value="hard">หายใจลำบาก</option>
            </select>
          </div>

          <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
            <button type="submit" class="btn btn-primary border-0">
              <i class="fas fa-search"></i>
              Search
            </button>
          </div>
        </div>
      </form>

      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 30px;margin-bottom:30px;"></div>

      <div class="row mt-4 mb-2">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div> <!-- // แบ่งหน้า -->
    <!-- </div> -->
            <!-- แบ่งหน้า -->


            <div class="table-responsive">

                <table class="table table-bordered show_startpage font-weight-light">
                    <thead class="text-center">
                        <tr>
                            <th scope="col" class="text-secondary">Profile</th>
                            <th scope="col" class="text-secondary">ID</th>
                            <th scope="col" class="text-secondary">Display Name</th>
                            <th scope="col" class="text-secondary">วันที่ประเมิน</th>
                            <th scope="col" class="text-secondary">สี</th>
                            <th scope="col" class="text-secondary">อาการ</th>
                            <th scope="col" class="text-secondary">การหายใจ</th>
                            <th scope="col" class="text-secondary">SpO2 Room Air (%)</th>
                            <th scope="col" class="text-secondary">ระดับออกซิเจนในเลือดหลังออกกำลังกาย</th>
                            <th scope="col" class="text-secondary">ปอดอักเสบ</th>
                            <th scope="col" class="text-secondary">อาการเพิ่มเติม</th>
                            <th scope="col" class="text-secondary">ตำแหน่ง</th>
                            <th scope="col" class="text-secondary">Action</th>
                        </tr>
                    </thead>
                    <tbody id="row_patientlist" style="display:none;">
                        <tr>
                            <td class="text-center table-middle">
                                <img src="##patient-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
                            </td>
                            <td class="text-center table-middle"># ##patient-id##</td>
                            <td class="text-center table-middle">##patient-patient.displayName##
                              <br>
                              ##patient-patient.firstname## ##patient-patient.lastname##
                            </td>
                            <td class="text-center table-middle">##patient-inputdate##</td>
                            <td class="text-center table-middle"><span id="patient_color">##patient-patient.color##</span></td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-symptoms##</td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-breathing##</td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-spo_room_air##</td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-exercise_test##</td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-pneumonia_check##</td>
                            <td class="text-center table-middle" id = "symptoms_td">##patient-remark##</td>
                            <!--<td class="text-center table-middle"><a href="##patient-location.link##" target="_blank">##patient-location.coordinates##</a></td>-->
                            <td class="text-center table-middle">
                              <!--<button class="btn btn-primary mt-4 mb-3" type="button" onclick="toGoogleMap()"><i class="fas fa-map-marker-alt"></i> Google Map</button>-->
                              <a href="##patient-location.link##" target="_blank"><button type="button" class="btn btn-primary border-0" style="background-color: #1597BB;" ><i class="fas fa-map-marker-alt"></i> Map</button></a>
                            </td>
                            <td class="text-center table-middle">
                                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="appointment('##patient-patient.id##')">นัดหมาย</button>
                                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="view_symptom('##patient-patient.id##')">รายละเอียด</button>
                            </td>
                        </tr>
                    </tbody>
                    <tbody id="show_patientlist">
                        <tr>

                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- // end table -->




    </div>
  </div>
</div>
<script type="text/javascript">
  var template_patient_row = $('#row_patientlist').html();
  var searchobj = {};
  var fncsearch;

  function pre_search(){
    // clear search url from lastsearch

    refreshpage(undefined,true);
    return false;
  }

  function refreshpage(rawdata,clearsearch) {

    var search_setting = {
      posturl: '/api-backend/admin/symptoms',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_patient_list,
      limit: 10,
      search: {}
    }

    // if ($('#search_name').val() !== "") {
    //   Object.assign(search_setting.search,{findname: $('#search_name').val()})
    // }

    if ($('#search_bysymptom').val() !== "") {
      Object.assign(search_setting.search,{findsymptom: $('#search_bysymptom').val().split(",")})
    }

    if ($('#search_breathing').val() != "NONE") {
      Object.assign(search_setting.search,{find_breathing: $('#search_breathing').val()})
    }
    console.log("Searching..",search_setting)

    var pagenumber = getParameterByName('page', window.location.search);
    if (pagenumber > 1) {
      search_setting.page = pagenumber;
    }
    // console.log('SEARCH ', search_setting);
    fncsearch = ADV_search(search_setting,clearsearch); // Defult always search at first
    return false;
  }

  function show_patient_list(objdata, totalrecord) {
    // console.log('objdata', objdata);
    if (objdata.result && totalrecord > 0) {
      working.patient = objdata.obj;
      objdata.obj.map(item => {
        // console.log(item)
        item.inputdate? item.inputdate = moment(item.inputdate, "X").format('DD/MM/YYYY HH:mm') : "";
        item.location ? item.location = { link: "https://www.google.com/maps/search/" + item.location.coordinates[1] + "," + item.location.coordinates[0]} : item.location;
        item.active ? item.active = '<b class="text-success">เปิดใช้งาน</b>' : item.active = '<b class="text-danger">ปิดใช้งาน</b>';

        typeof(item.patient) == "number" ? item.location = { link: ""} : item.location;
        typeof(item.patient) == "number" ? item.patient = {displayName: "--INACTIVE USER--"} : "";

        item.pneumonia_check ? item.pneumonia_check = "เคย" : item.pneumonia_check = "ไม่เคย";

        if (item.patient.color == "RED") {
           item.patient.color = '<span style="color: #C70039;">RED</span>'
         } else if (item.patient.color == "YELLOW") {
           item.patient.color = '<span style="color: #fcba03;">YELLOW</span>'
         } else if (item.patient.color == "GREEN") {
           item.patient.color = '<span style="color: green;">GREEN</span>'
         }else{
           item.patient.color = "N/A"
         }

         if (item.breathing == "normal")
         {
          item.breathing = "หายใจปกติ"
         }

         else if (item.breathing == "heavy")
         {
          item.breathing = "เหนื่อยหอบ"
         }
         else if (item.breathing == "hard")
         {
          item.breathing = "หายใจลำบาก"
         }
         if( Number(item.spo_room_air ) < 0 ){
           item.spo_room_air ='';
         }
         if( Number(item.exercise_test ) < 0 ){
           item.exercise_test ='';
         }

      })



      var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
      $("#show_patientlist").html(html_row);
      // $('.show_startpage').show('slow');
    } else {
      $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
    }
  }

  /*function toGoogleMap()
  {
    coor = patient-location.coordinates;
    let lat = coor[1]
    let lng = coor[0]

    window.open("https://www.google.com/maps/search/" + lat + ","+ lng, '_blank')
  }*/

  function settingpatient(dataid) {
    working.active_patientid = dataid;
    go2View('patient-edit');
  }

  function view_symptom(patient_id) {

    go2View("patient?id=" + patient_id)

  }

  function appointment(patient_id) {

    go2View("appoint_patient?id=" + patient_id)

  }
</script>
