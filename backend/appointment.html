<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">
      <h3><b>Appointment</b></h3>
      <!-- <div class="row mb-1">
                <div class="col-6 col-xs-12 col-sm-12 col-md-12 col-lg-6"> -->
      <form class="form-row" style="width: 100%;" onsubmit="return pre_search();">
        <div class="form-group">
          <!-- <div class="row d-flex justify-content-center"> -->
          <div class="row d-flex justify-start">
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <div class="form-group">
                <label for="ID No">Patient ID:</label>
                <input type="text" class="form-control" id="search_id" placeholder="Patient ID No">
              </div>

            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <div class="form-group">
                <label for="ID No">Appointment ID:</label>
                <input type="text" class="form-control" id="search_idno" placeholder="Appoint ID No">
              </div>

            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <label for="search_status">สถานะ</label>
              <div class="form-group">
                <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_status">
                  <option value="-2">โปรดเลือก</option>
                  <option value="-1">ยกเลิก</option>
                  <option value="0">รอคิว</option>
                  <option value="1">ได้คิว</option>
                  <option value="2">ตามเวลานัด</option>
                  <option value="4">พลาดคิว</option>
                  <option value="5">ขาดนัด</option>
                </select>
              </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <label for="search_status">เรียงข้อมูลตาม</label>
              <div class="form-group">
                <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_sort">
                  <option value="" >โปรดเลือก</option>
                  <option value="_id">Appointment ID</option>
                  <option value="dayfirst">วันนัดเก่า มาก่อน</option>
                  <option value="daylater">วันนัดใหม่ มาก่อน</option>
                </select>
              </div>
            </div>
  <!--
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <label for="SearchDate_Start">วันที่</label>
              <input type="date" class="form-control" id="search_date" placeholder="ช่วงเวลา">
            </div>

        -->

            <div class="row d-flex justify-start">
              <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
                <strong style="text-align: left;" ><br>ค้นหาด้วยชื่อสถานพยาบาล: </strong> <br>
                <div id="hospital_select" style="display: none;">
                  <div class="col-md-12">
                          <div class="form-check">
                              <input type="checkbox" class="form-check-input" id="hospital_##HOSPITAL-id##" name="hospital_select" value="##HOSPITAL-id##">
                              <label class="form-check-label" for="hospital_##HOSPITAL-id##">##HOSPITAL-name##</label>
                          </div>
                  </div>
                </div>
                <div id="hospital_select_showing"></div>
              </div>
            </div>


            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2"></div>
            <!--<div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="CheckOpenSearchBox" onclick="OpenSearchBox()">
                <label class="form-check-label" for="exampleCheck1">ค้นหาด้วยชื่อโรงพยาบาล</label>
              </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <select class="form-select" aria-label="Default select example" id="SearchHospitalList" style="display: none;">
                <option value="##hospital-id##">##hospital-name##</option>
              </select>
              <select class="form-select" aria-label="Default select example" id="SearchHospitalList_showing" style="display: none;">
              </select>
            </div>-->

          <!--<div class="row d-flex justify-start">
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <strong style="text-align: left;" >ค้นหาด้วยช่วงเวลา: </strong>
            </div>
            <div class="form-group">
              <div class="row">
                  <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                    <div class="form-group">
                      <label>ตั้งแต่ </label>
                  <label><input type="datetime-local" class="form-control" id="SearchDate_Start" placeholder="ช่วงเวลาเริ่มต้น"></label>
                    </div>
                  </div>

                </div>
                <div></div>
                <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                  <label><input type="datetime-local" class="form-control" id="SearchDate_End" placeholder="ช่วงเวลาสิ้นสุด"></label>
                </div>
              </div>
            </div>
          </div>-->

        </div>
      </form>
      <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i>
          Search
        </button>
      </div>
    </div>
      <!--
      <div class="row d-flex justify-start">
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label id="HospitalName">##hospital-name##</label>
        </div>
      </div>


      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 30px;margin-bottom:30px;"></div>
      <h3 class="p-0 m-0 mb-3"><b id="datetime_there">Date will be shown here</b></h3>
      <div class="btn-group" style="text-align: left;">
        <button class="btn btn-outline-primary" onclick="changeDate(-1)">&#171; Previous Day</button>
        <button class="btn btn-outline-primary" onclick="changeDate(1)">Next Day &#187;</button>
      </div>
  -->
      <div class="row mt-4 mb-2">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered show_startpage font-weight-light">
          <thead class="text-center">
            <tr>
            <th scope="col" class="text-secondary">Appoint ID</th>
              <th scope="col" class="text-secondary">Patient</th>
              <th scope="col" class="text-secondary">Display Name</th>


              <th scope="col" class="text-secondary">วันเวลาที่นัดหมาย</th>
              <th scope="col" class="text-secondary">สถานที่นัดหมาย</th>
              <th scope="col" class="text-secondary">รายละเอียด</th>
              <th scope="col" class="text-secondary">สถานะ</th>
              <th scope="col" class="text-secondary">การยืนยัน</th>
              <th scope="col" class="text-secondary">Action</th>
              <th scope="col" class="text-secondary">สร้างโดย</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
            <td class="text-center table-middle">###patient-id##</td>
              <td class="text-center table-middle">
                ###patient-patient.id##<BR><img src="##patient-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
              </td>

              <td class="text-center table-middle" nowrap>##patient-patient.displayName##
                <br>
                ##patient-patient.firstname## ##patient-patient.lastname##
              </td>

              <td class="text-center table-middle">##patient-appointtime##</td>
              <td class="text-center table-middle">##patient-hospital.name##</td>
              <td class="text-center table-middle">##patient-comment##</td>
              <td class="text-center table-middle">##patient-status## <br>##patient-confirmed##</td>

              <td class="text-center table-middle" nowrap="nowrap">##patient-travel## <Br> ##patient-selfcar##</td>

              <td class="text-center table-middle">
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="appointment('##patient-patient.id##')">จัดการนัดหมาย</button>
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="view_symptom('##patient-patient.id##')">รายละเอียด</button>

                  <button type="button"  style="display:none" class="btn btn-sm btn-outline-warning dropdown-toggle button_moveslot" data-movefrom="##patient-id##" data-movepatient="##patient-patient.id##" data-bs-toggle="dropdown" aria-expanded="false" >ย้ายไปเวลาอื่น </button>

                    <ul class="dropdown-menu all_timelist" aria-labelledby="Moveit">
                      <li><a class="dropdown-item" href="#" onclick="return moveslotto(this,'##slot-id##');" >##slot-startshow## - ##slot-endshow##</a></li>

                    </ul>

              </td>
              <td class="text-center table-middle"># ##patient-staff##</td>
            </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    var template_patient_row = $('#row_patientlist').html();
    var template_dropdown = $('#SearchHospitalList').html();
    var fncsearch;
    var template_hospital_name = $('#HospitalName').html();
    var date = new Date()
    var current_date = Math.floor(new Date(date.getFullYear(),date.getMonth(),date.getDate()) / 1000)
    var shown_date = new Date(current_date * 1000)

    var html_row_2;
    var hospitalname

    $(document).ready(() =>
    {
      $.getJSON(MAINURL + "/api-backend/admin/hospital/get", (msg) => {
          console.log(msg)
          hospitalname = hash_replace($("#hospital_select").html(), 'HOSPITAL', msg)
          $("#hospital_select_showing").html(hospitalname);
        })
    })

  function pre_search(){
    let hospital = []
    let hospital_element = document.getElementsByName('hospital_select')

    for (let i = 0; i < hospital_element.length; i++)
    {
      if (hospital_element[i].checked)
      {
        hospital.push(parseInt(hospital_element[i].value))
      }
    }


    console.log(hospital)
    searchdata={}
      if (hospital.length > 0) {
        searchdata.find_hospital =  hospital;
      }
      if ($('#search_idno').val() !== "") {
        searchdata.find_id = $('#search_idno').val();
      }
      if ($('#search_id').val() !== "") {
        searchdata.find_patientid = $('#search_id').val();
      }
      if($('#search_sort').val()){
        searchdata.search_sort =$('#search_sort').val()
      }
      if ($('#search_status').val() !== "-2") {
          searchdata.find_status = $('#search_status').val()
      }
    fncsearch({
      search: searchdata
    })
    return false;
  }

    function refreshpage(rawdata) {



      console.log("GLOBAL_USER",GLOBAL_USER)


      var search_setting = {
        posturl: '/api-backend/admin/appointlist',
        paginationDIV: $('.pagination_bar'),
        pagesize: 10,
        showfunction: show_patient_list,
        limit: 20,
        search:{}
      }




      /*if (document.getElementById('CheckOpenSearchBox').checked) {
        if ($('#SearchHospitalList_showing').val() !== "") {
          Object.assign(search_setting.search,{find_hospital: $('#SearchHospitalList_showing').val()})
        }
      }*/
      //getSelectedname();

      var pagenumber = getParameterByName('page', window.location.search);
      if (pagenumber > 1) {
        search_setting.page = pagenumber;
      }

      // console.log('SEARCH ', search_setting);
      fncsearch = ADV_search(search_setting); // Defult always search at first
      return false;
    }

    function show_patient_list(objdata, totalrecord) {
      console.log('objdata', objdata);
      if (objdata.result && totalrecord > 0) {
        working.patient = objdata.obj;
        console.log("OBJDATA: " + objdata.obj)

        var ITEMSTATUS = [`<span style="color: #FFD033;">รอคิว</span>`,`<span style="color: #47CF55;">ได้คิว</span>`,`<span style="color: green;">ตามเวลานัด</span>`,`<span style="color: #9139B6;">นัดอัตโนมัติ</span>`,`<span style="color: red;">พลาดคิว</span>`,`<span style="color: black;">ขาดนัด</span>`]

        objdata.obj.map(item => {
          console.log(item)
          if(item.status == 1){
            if(item.confirmed){
              item.confirmed=`<span class="badge rounded-pill bg-success">Confirm</span>`
            }else{
              item.confirmed=`<span class="badge rounded-pill bg-secondary">not confirm</span>`
            }
          }else{
              item.confirmed=""
          }
          item.appointtime ? item.appointtime = moment(item.appointtime, "X").format('DD/MM/YYYY HH:mm') : "";
          item.status == -1 ? item.status = `<span style="color: #C70039;">ยกเลิก</span>`: item.status = ITEMSTATUS[item.status];
          (typeof(item.patient) == "number" || !item.patient) ? item.patient = {displayName : "-- INACTIVE USER --"} : item.patient;



        })


        var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
        $("#show_patientlist").html(html_row);
        if(totalrecord==1){   // only 1 record
          $('.button_moveslot').show();
            console.log($('#change_appoint'))
            getdaylist(objdata.obj[0].hospital._id,objdata.obj[0]._id)
        }else{
          $('.button_moveslot').hide();
          //$('#change_appoint').hide();
        }

        // $('.show_startpage').show('slow');
      } else {
        $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
      }
    }

    function view_symptom(patient_id) {

      go2View("patient?id=" + patient_id)

    }

    function appointment(patient_id) {

      go2View("appoint_patient?id=" + patient_id)

    }

    function settingpatient(dataid) {
      working.active_patientid = dataid;
      go2View('patient-edit');
    }

    function OpenSearchBox() {
      var x = document.getElementById("SearchHospitalList_showing");
      if (x.style.display === "none")
        x.style.display = "block";
      else
        x.style.display = "none";
    }

    function SearchbyDate(Start,End)
    {
      console.log("SerachingDate Test")
      console.log(Start)
      console.log(End)

      var Half = Start.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var StartTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      var Half = End.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var EndTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      console.log(StartTime)
      console.log(EndTime)

      var payload ={
        starttime : StartTime,
        endtime : EndTime
      }

      console.log(payload)
      $.postJSON(MAINURL + "/api-backend/admin/appoint/searching_date",payload,(msg) => {
        console.log("TestOutput")
        console.log(msg)
      })
    }

    function changeDate(quantity) {
      current_date += 24 * 3600 * (quantity)
      shown_date = new Date(current_date * 1000)
      pre_search()
    }





        var template_timelist = $('.all_timelist').html();
        var workingslot ;
        function getdaylist(hospitalid,main_id){
            console.log("CHECK",hospitalid,main_id)

            $.postJSON(MAINURL + "/api-backend/admin/appoint/get7daysslot", {hospitalid:hospitalid}, (msg) => {
              console.log(msg)
                var found ;
                msg.map((l)=>{
                    l.startshow = moment(l.timestart,'X').format("D/MM HH:SS")
                    l.endshow = moment(l.timeend,'X').format("HH:SS")
                        if(Array.isArray(l.queue)){
                            for(var x=0; x < l.queue.length;x++ ){
                              if(l.queue[x].appointment == main_id){
                                l.startshow="<font color='red'>ปัจจุบัน"
                                l.endshow =" เวลานี้ </font>"
                                found=true;
                                workingslot = l._id;
                              }
                            }
                        }


                })

                var html = hash_replace(template_timelist,"slot",msg);
            //  if(found){
                $('.all_timelist').html(html);
            //  }

              console.log("7day,",msg)
            });
        }

        function moveslotto(obj,slotid){
          console.log(obj,slotid)
        //  confirm("ยืนยันการย้าย ?")
          var testobj = $(obj).parents('td').find('.button_moveslot')
          console.log('html',testobj.html())
          var movefrom = testobj.data('movefrom')
          var movepatient =testobj.data('movepatient')
          var postData = {
                patient:movepatient,
                appointment:movefrom,
                from:workingslot,
                to:slotid
            }
            if(postData.from == postData.to){
              alert("Same TIME")
              return;
            }
            console.log(postData)
            return;
          $.postJSON(MAINURL + "/api-backend/admin/appoint/move_appoint_slot",postData,(result)=>{
            $('#external-event-dialog').modal("hide")
            if(result.result){
              refreshpage();
            }else{
              alert(result.detail)
            }
          });
          console.log("moveslotto",slotid,movefrom,movepatient)
        }
  </script>
