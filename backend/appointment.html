<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">
      <h3><b>Appointment</b></h3>
      <!-- <div class="row mb-1">
                <div class="col-6 col-xs-12 col-sm-12 col-md-12 col-lg-6"> -->
      <form class="form-row" style="width: 100%;" onsubmit="return pre_search();">
        <div class="form-group">
          <!-- <div class="row d-flex justify-content-center"> -->
          <div class="row d-flex justify-start">
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <div class="form-group">
                <input type="text" class="form-control" id="search_idno" placeholder="ID No">
              </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <div class="form-group">
                <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_status">
                  <option value="-2">โปรดเลือก</option>
                  <option value="-1">ยกเลิก</option>
                  <option value="0">รอคิว</option>
                  <option value="1">ได้คิว</option>
                  <option value="2">ตามเวลานัด</option>
                </select>
              </div>
            </div>

            <div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
              <strong style="text-align: left;" >ค้นหาด้วยชื่อโรงพยาบาล: </strong> <br><br>
              <div id="hospital_select" style="display: none;">
                <div class="col-md-12">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="hospital_##HOSPITAL-id##" name="hospital_select" value="##HOSPITAL-id##">
                            <label class="form-check-label" for="exampleCheck1">##HOSPITAL-name##</label>
                        </div>
                </div>
              </div>
              <div id="hospital_select_showing"></div>
            </div>

            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2"></div>
            <!--<div class="col-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 mt-2">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="CheckOpenSearchBox" onclick="OpenSearchBox()">
                <label class="form-check-label" for="exampleCheck1">ค้นหาด้วยชื่อโรงพยาบาล</label>
              </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <select class="form-select" aria-label="Default select example" id="SearchHospitalList" style="display: none;">
                <option value="##hospital-id##">##hospital-name##</option>
              </select>
              <select class="form-select" aria-label="Default select example" id="SearchHospitalList_showing" style="display: none;">
              </select>
            </div>-->
            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Search
              </button>
            </div>

            <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                ค้นหาด้วยช่วงเวลา
            </div>
            <div class="form-group">
              <div class="row d-flex justify-start">
                <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                  <label><input type="datetime-local" class="form-control" id="SearchDate_Start" placeholder="ช่วงเวลาเริ่มต้น"></label>
                </div>
                <div></div>
                <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                  <label><input type="datetime-local" class="form-control" id="SearchDate_End" placeholder="ช่วงเวลาสิ้นสุด"></label>
                </div>
              </div>
            </div>

          </div>
        </div>
      </form>
      <!--
      <div class="row d-flex justify-start">
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label id="HospitalName">##hospital-name##</label>
        </div>
      </div>
      -->
      
      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 30px;margin-bottom:30px;"></div>

      <div class="row mt-4 mb-2">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered show_startpage font-weight-light">
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">Profile</th>
              <th scope="col" class="text-secondary">เลขที่นัดหมาย</th>
              <th scope="col" class="text-secondary">Display Name</th>
              <th scope="col" class="text-secondary">วันเวลาที่นัดหมาย</th>
              <th scope="col" class="text-secondary">สถานที่นัดหมาย</th>
              <th scope="col" class="text-secondary">รายละเอียด</th>
              <th scope="col" class="text-secondary">สถานะ</th>
              <th scope="col" class="text-secondary">Action</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
              <td class="text-center table-middle">
                <img src="##patient-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
              </td>
              <td class="text-center table-middle"># ##patient-id##</td>
              <td class="text-center table-middle">##patient-patient.displayName##
                <br>
                ##patient-patient.firstname## ##patient-patient.lastname##
              </td>
              <td class="text-center table-middle">##patient-appointtime##</td>
              <td class="text-center table-middle">##patient-hospital.name##</td>
              <td class="text-center table-middle">##patient-comment##</td>
              <td class="text-center table-middle">##patient-status##</td>
              <td class="text-center table-middle">
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="appointment('##patient-patient.id##')">จัดการนัดหมาย</button>
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="view_symptom('##patient-patient.id##')">รายละเอียด</button>
              </td>
            </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    var template_patient_row = $('#row_patientlist').html();
    var template_dropdown = $('#SearchHospitalList').html();
    var searchobj = {};
    var fncsearch;
    var template_hospital_name = $('#HospitalName').html();

    var html_row_2;
    var hospitalname

    $(document).ready(() =>
    {
      $.getJSON(MAINURL + "/api-backend/admin/hospital/get", (msg) => {
          console.log(msg)

          //html_row_2 = hash_replace(template_dropdown, 'hospital', msg)
          //$("#SearchHospitalList_showing").html(html_row_2);

          hospitalname = hash_replace($("#hospital_select").html(), 'HOSPITAL', msg)
          $("#hospital_select_showing").html(hospitalname);
        })
    })

    function pre_search(){
    // clear search url from lastsearch

    refreshpage(undefined,true);
    return false;
  }

    function refreshpage(rawdata,clearsearch) {

      console.log("GLOBAL_USER",GLOBAL_USER)
        if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1)){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }

      var search_setting = {
        posturl: '/api-backend/admin/appointlist',
        paginationDIV: $('.pagination_bar'),
        pagesize: 10,
        showfunction: show_patient_list,
        limit: 10,
        search: {}
      }

      let hospital = []
      let hospital_element = document.getElementsByName('hospital_select')

      for (let i = 0; i < hospital_element.length; i++)
      {
        if (hospital_element[i].checked)
        {
          hospital.push(hospital_element[i].value)
        }
      }

      console.log(hospital)

      if ($('#search_idno').val() !== "") {
        Object.assign(search_setting.search,{find_id: $('#search_idno').val()})
      }

      if ($('#SearchDate_Start').val() !== ""  && $('#SearchDate_End').val() !== "") {

        let starttime = Math.floor(new Date($('#SearchDate_Start').val()) / 1000)
        let endtime = Math.floor(new Date($('#SearchDate_End').val()) / 1000)
        let timepayload = 
        {
          starttime: starttime,
          endtime: endtime
        }

        Object.assign(search_setting.search,{find_time: timepayload})
      }

      console.log("Search: " + $('#search_status').val())
      if ($('#search_status').val() !== "-2") {
          Object.assign(search_setting.search,{find_status: $('#search_status').val()})
      }

      /*if (document.getElementById('CheckOpenSearchBox').checked) {
        if ($('#SearchHospitalList_showing').val() !== "") {
          Object.assign(search_setting.search,{find_hospital: $('#SearchHospitalList_showing').val()})
        }
      }*/
      //getSelectedname();

      var pagenumber = getParameterByName('page', window.location.search);
      if (pagenumber > 1) {
        search_setting.page = pagenumber;
      }
      
      // console.log('SEARCH ', search_setting);
      fncsearch = ADV_search(search_setting,clearsearch); // Defult always search at first
      return false;
    }

    function show_patient_list(objdata, totalrecord) {
      console.log('objdata', objdata);
      if (objdata.result && totalrecord > 0) {
        working.patient = objdata.obj;
        console.log("OBJDATA: " + objdata.obj)
        
        var ITEMSTATUS = [`<span style="color: #FFD033;">รอคิว</span>`,`<span style="color: #47CF55;">ได้คิว</span>`,`<span style="color: green;">ตามเวลานัด</span>`,`<span style="color: #9139B6;">นัดอัตโนมัติ</span>`]
        objdata.obj.map(item => {
          // console.log(item)
          item.appointtime ? item.appointtime = moment(item.appointtime, "X").format('DD/MM/YYYY') : "";
          item.status == -1 ? item.status = `<span style="color: #C70039;">ยกเลิก</span>`: item.status = ITEMSTATUS[item.status];
          typeof(item.patient) == "number" ? item.patient = {displayName : "-- INACTIVE USER --"} : item.patient;

        })


        var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
        $("#show_patientlist").html(html_row);

        // $('.show_startpage').show('slow');
      } else {
        $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
      }
    }

    function view_symptom(patient_id) {

      go2View("patient?id=" + patient_id)

    }

    function appointment(patient_id) {

      go2View("appoint_patient?id=" + patient_id)

    }

    function settingpatient(dataid) {
      working.active_patientid = dataid;
      go2View('patient-edit');
    }

    function OpenSearchBox() {
      var x = document.getElementById("SearchHospitalList_showing");
      if (x.style.display === "none")
        x.style.display = "block";
      else
        x.style.display = "none";
    }

    function SearchbyDate(Start,End)
    {
      console.log("SerachingDate Test")
      console.log(Start)
      console.log(End)

      var Half = Start.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var StartTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      var Half = End.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var EndTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      console.log(StartTime)
      console.log(EndTime)

      var payload ={
        starttime : StartTime,
        endtime : EndTime
      }

      console.log(payload)
      $.postJSON(MAINURL + "/api-backend/admin/appoint/searching_date",payload,(msg) => {
        console.log("TestOutput")
        console.log(msg)    
      })
    }
  </script>
