<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">

      <h3 class="p-0 m-0 mb-3"><b>X-Ray Result</b></h3>

      <div class="row mb-1 d-flex justify-content-start">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <form class="form-row" onsubmit="return pre_search();">
            <div class="row ">
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <input type="text" class="form-control" id="search_idno" placeholder="HN PatientID">
                </div>
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_name" placeholder="ชื่อ">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_cid" placeholder="เลขบัตรประชาชน">
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="text" class="form-control" id="search_resultx" placeholder="ผลของ X-ray">
              </div> 
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <input type="date" class="form-control" id="search_date" >
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <button type="button" class="btn btn-primary border-0" onclick="waitingResultXray()">
                  <i class="fas fa-x-ray"></i>
                  ผู้ที่รอผล x-ray
                </button>
              </div>
              <div class="col-sm-12 col-md-6 col-lg-12 col-xl-12 mt-2">
                <label for="search_status">ค้นหาโดยศูนย์ X-ray</label>
                <select class="form-control form-control-sm tag-select" id="search_hospital" name="hospital[]"
                  multiple="multiple">
                </select>
                <small id="search_hospital_help"
                  class="form-text text-muted">**สามารถเลือกศูนย์ X-ray ได้มากกว่าหนึ่งแห่ง</small>
                <!-- <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_hospital">
                    <option value="" >โปรดเลือก</option>
  
                  </select> -->
              </div>
              <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2">
                <div class="form-group">
                  <button type="submit" class="btn btn-primary border-0 mt-2">
                    <i class="fas fa-search"></i>
                    Search
                  </button>
                </div>
              </div>

              <!--<div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <select class="form-select" aria-label="สีของผู้ป่วย" id="search_color">
                    <option value="NONE">โปรดเลือกสี</option>
                    <option value="GREEN">เขียว</option>
                    <option value="YELLOW">เหลือง</option>
                    <option value="RED">แดง</option>
                    <option value="WHITE">สิ้นสุด</option>
                  </select>
                </div>
              </div> -->
              <!--<div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
                <div class="form-group">
                  <select class="form-select" aria-label="สีของผู้ป่วย" id="search_color">
                    <option value="NONE">โปรดเลือกการเปลี่ยนแปลง</option>
                    <option value="-1">ดีขึ้น</option>
                    <option value="0">ปกติ</option>
                    <option value="1">แย่ลง</option>
                  </select>
                </div>
              </div> -->
            </div>
          </form>
        </div>
      </div>

      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 30px;margin-bottom:30px;"></div>

      <!-- แบ่งหน้า -->
      <div class="row mt-4">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div>
      <!-- // แบ่งหน้า -->

      <div class="table-responsive mt-2">
        <table class="table table-bordered table-hover show_startpage font-weight-light" >
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">Patient</th>
              <th scope="col" class="text-secondary">Appointment ID</th>
              <th scope="col" class="text-secondary">X-ray Center Name</th>
              <th scope="col" class="text-secondary">Name</th>
              <th scope="col" class="text-secondary">Date</th>
              <th scope="col" class="text-secondary">ID/Accession</th>
              <th scope="col" class="text-secondary">Category</th>
              <th scope="col" class="text-secondary">Other</th>
              <th scope="col" class="text-secondary">ผู้ตรวจ</th>
              <th scope="col" class="text-secondary">อื่นๆ</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
              <td class="text-center table-middle">
                ###XRAY-patient.id##<br><img src="##XRAY-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
              </td>
              <td class="text-center table-middle"># ##XRAY-appointment.id##</td>
              <td style="white-space: nowrap;" class="text-center table-middle"># ##XRAY-hospital.name##</td>
              <td class="text-center table-middle">##XRAY-patient.displayName##
                <br>
                ##XRAY-patient.firstname## ##XRAY-patient.lastname##
              </td>

              <td class="text-center table-middle">##XRAY-createdate##</td>
              <td class="text-center table-middle">##XRAY-patient.idcard##<br>##XRAY-accession##</td>
              <td class="text-center table-middle">##XRAY-data.FindingName##</td>
              <td class="text-left table-middle"><small><small>##XRAY-data.ResultText## </small></small></td>
              <td class="text-center table-middle">
                ##XRAY-data.RadiologistName##

              </td>
            </td><td class="text-center">
              <button type="button" name="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="view_symptom('##XRAY-patient.id##')">รายละเอียดผู้ป่วย</button>
              <button type="button" name="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="view_detail_x_ray('##XRAY-patient.id##')">รายละเอียด x-ray</button>
            </td>
            </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>
      <!-- // end table -->

    </div>
  </div>
</div>

<!-- Scrollable modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">X-Ray Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover show_startpage font-weight-light">
            <thead class="text-center">
              <tr>
                <th scope="col" class="text-secondary">X_RAY ID</th>
                <th scope="col" class="text-secondary">Appointment ID</th>
                <th scope="col" class="text-secondary">Accession</th>
                <th scope="col" class="text-secondary">ACK Code</th>
                <th scope="col" class="text-secondary">Create Date</th>
              </tr>
            </thead>
            <tbody id="row_x_ray" style="display:none;">
              <td class="text-center table-middle">##detail-id##</td>
              <td class="text-center table-middle">##detail-appointment##</td>
              <td class="text-center table-middle">##detail-accession##</td>
              <td class="text-center table-middle">##detail-ack_code##</td>
              <td class="text-center table-middle">##detail-createdate##</td>
            </tbody>
            <tbody id="show_x_ray">
              <tr>
  
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>
  </div>
</div>


  <script type="text/javascript">
  var template_patient_row = $('#row_patientlist').html();
  var template_x_ray_row = $('#row_x_ray').html();
  var fncsearch;
  var html_obj = {
    search_name:"findname",
    search_idno:"find_id",
    search_cid:"find_cid",
    search_resultx:"search_resultx",
    search_date:"search_date",
  }
  
  $('#search_hospital').adv_select({
    url: '/api-backend/admin/hospital/get',
    name: 'name',
    val: {},
    template: "#{{_id}}: {{name}}",
    id: '_id',
    maxshow: 10
  }, null, true);

  function pre_search(){
    // clear search url from lastsearch
    // console.log($('#search_hospital').val().map(numStr => parseInt(numStr)))
    var searchdata ={};
    if($('#search_hospital').val().length > 0) {
      searchdata.hospital = $('#search_hospital').val().map(numStr => parseInt(numStr));
    }
    map_html_to_obj(html_obj,searchdata)
    fncsearch ({search:searchdata})
    return false;
  }

  function refreshpage(rawdata) {
    console.log("GLOBAL_USER",GLOBAL_USER)
    // $('#search_hospital').val(GLOBAL_USER.affiliation).trigger('change');
    var search_setting = {
      posturl: '/api-backend/admin/treatment_xraylist',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_search_list,
      limit: 20,
      search: {}
    }
    var pagenumber = getParameterByName('page', window.location.search);
    if (pagenumber > 1) {
      search_setting.page = pagenumber;
    }
    
    // console.log('SEARCH ', search_setting);
    fncsearch = ADV_search(search_setting); // Defult always search at first
    return false;
  }

  function waitingResultXray() {
    var searchdata = {}
    searchdata.waiting_result = true;
    fncsearch({
      search: searchdata
    })
    return false
  }

  function show_search_list(objdata, totalrecord,filed2show,queryobj) {
      if(queryobj){
        map_obj_to_html(queryobj.search,html_obj)
      }
    if (objdata.result && totalrecord > 0) {
      working.patient = objdata.obj;

      objdata.obj.map(item => {


        item.createdate ? item.createdate = moment(item.createdate, "X").format("DD/MM/YYYY HH:mm") : "";


      })
      console.log("Set result")
      var html_row = hash_replace(template_patient_row, 'XRAY', objdata.obj)
      $("#show_patientlist").html(html_row);
      // $('.show_startpage').show('slow');

    } else {
      $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
    }
  }

  function view_symptom(patient_id) {
    go2View("patient?id=" + patient_id)
  }

  function view_detail_x_ray(patient_id) {
    // go2View("patient?id=" + patient_id)
    $.postJSON(`/api-backend/admin/treatment/x-ray/detail`, {patient:Number(patient_id)}, (res) => {
      console.log(res)
      if(res && res.result) {
        res.data.map(item => {
          item.createdate ? item.createdate = moment(item.createdate, 'X').format('DD/MM/YYYY HH:mm') : item.createdate = "";
        });
        var html_row = hash_replace(template_x_ray_row, 'detail', res.data)
        $("#show_x_ray").html(html_row);
        $('#exampleModal').modal('show');
      } else {
        $("#show_x_ray").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
      }
    })
    // detail_x_ray();
  }

  function detail_x_ray() {
    // $('#exampleModal').show();
    $('#exampleModal').modal('show')
  }

</script>
