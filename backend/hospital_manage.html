<style>

  .external-event-calendar {
      border-right: 1px solid #ccc;
  }

  .external-event-task {
      color: #fff;
      padding: 10px;
      margin: 20px;
      border-radius: 8px;
      font-family: -apple-system, Segoe UI, Roboto, sans-serif;
  }

  .demo-external-event-presets.demo-wrapper,
  .demo-external-event-presets .mbsc-grid,
  .demo-external-event-presets .mbsc-row,
  .demo-external-event-presets .external-event-calendar {
      height: 100%;
  }





  .md-work-week-cont {
      position: relative;
      padding-left: 50px;
  }

  .md-work-week-avatar {
      position: absolute;
      max-height: 50px;
      max-width: 50px;
      top: 21px;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      left: 20px;
  }

  .md-work-week-name {
      font-size: 16px;
  }

  .md-work-week-title {
      font-size: 12px;
      margin-top: 5px;
  }

.md-timeline-template .mbsc-schedule-event.mbsc-ltr {
    height: auto !important;
}

.md-timeline-template-event {
    border: 1px solid transparent;
    margin: 2px 0;
}

.md-timeline-template-event-cont {
    background: rgba(255, 255, 255, .8);
    font-size: 15px;
    height: 32px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

.md-timeline-template-event-cont .mbsc-icon {
    padding: 5px;
    box-sizing: content-box;
}

.mbsc-timeline-event-start .md-timeline-template-event,
.mbsc-timeline-event-start .md-timeline-template-event-cont,
.mbsc-timeline-event-start .md-timeline-template-event-cont .mbsc-icon {
    border-top-left-radius: 20px;
    border-bottom-left-radius: 20px;
}

.mbsc-timeline-event-end .md-timeline-template-event,
.mbsc-timeline-event-end .md-timeline-template-event-cont,
.mbsc-timeline-event-end .md-timeline-template-event-cont .mbsc-icon {
    border-top-right-radius: 20px;
    border-bottom-right-radius: 20px;
}

.md-timeline-template-event-cont .mbsc-icon:before {
    color: #fff;
    font-size: 18px;
}

.md-timeline-template-time {
    margin: 0 10px;
}

.md-timeline-template-title {
    color: #666;
}

.md-timeline-template .mbsc-timeline-column,
.md-timeline-template .mbsc-timeline-header-column {
    min-width: 100px;
}

.md-timeline-template .mbsc-timeline-resource,
.md-timeline-template .mbsc-timeline-row {
    min-height: 100px;
}
  </style>
<div class="main_page mb-12" style="margin-top:120px;">

  <div class="mbsc-grid mbsc-no-padding">
      <div class="mbsc-row">
      <div class="mbsc-col-sm-12 external-event-calendar">
        <div id="xray-q" style="height:100%;"></div>

        </div>

      </div>
  </div>

</div>


<!-- Modal -->
<div class="modal fade" id="external-event-dialog" tabindex="-1" aria-labelledby="modal_title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal_title">นัดหมาย <font color='green'>(กด Esc เพื่อปิดหน้านี้ได้)</font></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" >
        <label >
            นัดหมาย Slot#   <span id="qid"> </span>
        </label>
        <br>
        <label >
            เวลาเริ่ม :  <span id="t_begin"> </span>
        </label>
        <br>
        <label >
            เวลาเริ่มสิ้นสุด:  <span id="t_end"> </span>
        </label>
        <hr>
          รายการผู้ป่วย
        <div >
          <table class="table table-striped">
            <tbody id="mobdal_body">
              <tr>
                <th> ##q-patient.showid##</th>
                <th scope="row"><img src="##q-patient.pictureUrl##" class="rounded-circle staffimage" style="max-width : 50px;padding:0px;margin:0px;" >               </th>
                <td> ##q-patient.displayName##</td>
                <td> ##q-patient.firstname## ##q-patient.lastname##</td>
                <td>##q-patient.mobileno##</td>
                <td nowrap="nowarp"> ##q-patient.address.address##
<br> <small> <span  style="color:blue">##q-patient.comment##</span> </small><span  class="badge rounded-pill  bg-light text-dark" onclick="update_comment('##q-patient.id##')" style="cursor: pointer;">comment...</span>
                  </td>
                  <td>##q-patient.address.subdistrict##</td>
                  <td>##q-patient.address.district##</td>
                <td>  ##q-patient.mobileno## (##q-patient.travelprefer## ##q-travel## ##q-selfcar##)</td>
                <td><a href="/admin/patient?id=##q-patient.id##" target="_blank"> <button type="button" class="btn btn-sm btn-secondary" >Detail </button> </a></td>
                <td nowrap="nowrap"> ##q-confirmed## <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle button_moveslot" data-movefrom="##q-id##" data-movepatient="##q-patient.id##" data-bs-toggle="dropdown" aria-expanded="false" >ย้าย/ลบ/confirm </button>

                  <ul class="dropdown-menu all_timelist" aria-labelledby="Moveit">
                    <li><a class="dropdown-item" href="#" onclick="return moveslotto(this,'##slot-id##');" >##slot-startshow## - ##slot-endshow##</a></li>

                  </ul>

                </td>


              </tr>
              </tbody>
            </table>

        </div>
        <br>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

  var searchobj = {};
  var fncsearch;
  var current_appoint;
  var current_hosp;
  var qcalendar;
  var randcolor = ["#7a5886","#9da721","#cd6957","#637e57","#50789d","#6c5d45"]
  var template_modalbody = $('#mobdal_body').html();
  var template_all_timelist = $('.all_timelist').html();
  var workingslot;


  function refreshpage(rawdata) {

    console.log("GLOBAL_USER",GLOBAL_USER)

    var search_setting = {
      posturl: '/api-backend/admin/HospitalList',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_hospital_list,
      limit: 10,
    }

    fncsearch = ADV_search(search_setting); // Defult always search at first
    return false;
  }
  function load_timeslot(hospital_id){
  let payload = {
    hospital: hospital_id,
    timestart: Math.floor(new Date()/1000 - 3600*24*3),  // last 3 days
    timeend: Math.floor(new Date()/1000 + 3600*24*27)  // next 27 days
  }

  console.log(payload)

    $.postJSON(MAINURL + "/api-backend/admin/hospital/load_timeslot", payload, (msg) => {
        console.log("GOT TIMESLOT",msg)
        if(Array.isArray(msg.detail )){
            msg.detail.map((ev)=>{

                      ev.start = new Date(ev.timestart*1000);
                      ev.end = new Date(ev.timeend*1000);
                      ev.title = ev.queuecount + " นัด";
                      if(ev.queuecount ==0){
                        ev.title =""
                        ev.color = "#eeeeee"
                      }
                      ev.resource =  ev.hospital;
                      delete ev.timeend;
                      delete ev.timestart;
                      delete ev.id;
            })
            current_appoint = msg.detail;
            set_event(current_hosp,msg.detail)
        }else{
          alert("Data Not found ")
        }

    });
  }
  function show_hospital_list(objdata, totalrecord) {
    // console.log('objdata', objdata);

    var allhosp = []

    if (objdata.result && totalrecord > 0) {

      working.patient = objdata.obj;
      objdata.obj.map(item => {
        allhosp.push(item._id);
        item.title = item.name;
        item.id= item._id;
        item.color = randcolor[ item._id % 5]
        // console.log(item)
      });
      current_hosp = objdata.obj;
      load_timeslot(allhosp);
      return;
    }
  }

  function set_event(obj,all_event){
        mobiscroll.setOptions({
        locale: mobiscroll.localeTh,
        theme: 'ios',
        themeVariant: 'light',
    });
    var now  = new Date()
  $(function () {
      var begin = new Date().getDay();
      begin = (begin -1) %7
      console.log("DAY ",new Date().getDate())
      qcalendar = $('#xray-q').mobiscroll().eventcalendar({
        view: {
            timeline: {
                type: 'week',
                startDay: begin,
                endDay: (begin+6) %7,
                timeCellStep: 60  ,
                timeLabelStep: 60
            }
        },invalid: [{
        start: '00:00',
        end: '06:00',
        recurring: {
            repeat: 'daily',
        }
    }, {
        start: '22:00',
        end: '23:59',
        recurring: {
            repeat: 'daily',
        }
    }],
          renderResource: function (resource) {
              return '<div class="md-work-week-cont">' +
                  '<div class="md-work-week-name">'+ resource.title + '</div>' +
        //          '<div class="md-work-week-title">' + resource.title + '</div>' +
                  //'<div class="md-work-week-avatar" ><a href="/admin/vehicle_list?find_id='+resource.id+'" target="_blank">#'+ resource.id +"</a>:</div>" +
                  //  `<div><small>unsave</small></div>`+
                  '</div>';
          },
          // renderScheduleEvent: function (data) {
          // //  console.log("Reding data",data)
          //     var ev = data.original;
          //     var color = data.color;
          //     var html = `<div class="hosp-event mbsc-schedule-event-title mbsc-ios" >${ev.title} </div>
          //         <div class="mbsc-schedule-event-range mbsc-ios">${ev.startchar}</div>`;
          //     // if(ev.status == 1){
          //     //     html+=`<span class="mbsc-icon mbsc-font-icon mbsc-icon-save" style="background:${color}"></span> `
          //     // }
          //     //  html += `<span class="md-timeline-template-title">${ev.title}</span></div></div>`
          //     return html;
          //         //'
          //       //  (ev.unsave || '') +
          //
          // },
          clickToCreate: false,
          dragToCreate: false,
          dragToResize: false,
          dragToMove: false,
          externalDrop: false,

          onEventCreated: function (args) {
              // $(".appoint_id" +args.event._id).hide("slow");
              // var res = getobjbyid(current_car,args.event.resource)
              // args.event.color = res.color;
              // console.log("Created",args)
          },
          onEventClick: function (args) {
                    // editingobj = args.event
                     console.log("click",args.event)
                     fillDialog(args);

                 },
          onEventCreateFailed: function () {
              alert( 'Can\'t create event on this date');
          },
          onEventUpdateFailed: function () {
              alert( 'Can\'t add event on this date');
          },
          data: all_event ,
          resources:obj
      });
    //  qcalendar.setEvents(all_event);
      console.log("finish",all_event)


  });
  return false;
}

function fillDialog(args) {
    var res = getobjbyid(current_hosp,args.event.resource)
    var q = args.event;
    workingslot = q;
    $('#qid').html(q._id);
    $('#t_begin').html(moment(q.start).format("DD-MM-YY HH:mm"));
    $('#t_end').html(moment(q.end).format("DD-MM-YY HH:mm"));
    $('#totalq').html(`${q._id} จำนวน ${q.title}`)
    $('#link_detail').attr('href',"/admin/slotlist?qid="+q._id)
    var postdata = {
      search:{qid:q._id}
    }
    $.postJSON(MAINURL + "/api-backend/admin/appoin_slot_tlist", postdata, (msg) => {
        console.log("gotBack",msg)
        msg.obj.obj.map((o)=>{
          if(o.confirmed){
            o.confirmed=`<span class="badge rounded-pill bg-success">Confirm</span>`
          }else{
            o.confirmed=`<span class="badge rounded-pill bg-secondary">not confirm</span>`
          }
          o.patient.showid = o.patient._id
          if(o.patient.color=="RED"){
            o.patient.showid = `<span class="badge bg-danger">${o.patient._id}</span>`
          }
          if(o.patient.color=="GREEN"){
            o.patient.showid = `<span class="badge bg-success">${o.patient._id}</span>`
          }
          if(o.patient.color=="YELLOW"){
            o.patient.showid = `<span class="badge bg-warning">${o.patient._id}</span>`
          }

        });

        var html = hash_replace(template_modalbody,"q",msg.obj.obj);
          $('#mobdal_body').html(html)
          getdaylist(q.hospital,q._id);
          $('#external-event-dialog').modal("show")
    });

   // dialog.open();
}

function getdaylist(hospitalid,main_id){
    console.log("CHECK",hospitalid)

    $.postJSON(MAINURL + "/api-backend/admin/appoint/get7daysslot", {hospitalid:hospitalid}, (msg) => {
        msg.map((l)=>{
            l.startshow = moment(l.timestart,'X').format("D/MM HH:mm")
            l.endshow = moment(l.timeend,'X').format("HH:mm")
            if(l._id == main_id){
                l.startshow="<font color='red'>ปัจจุบัน"
                l.endshow =" เวลานี้ </font>"
            }
        })

        var html = hash_replace(template_all_timelist,"slot",msg);
      var confirmhtml=`<li><a class="dropdown-item" href="#" onclick="return makeconfirm(this);" ><font color='green'>Confirm การเดินทาง </font></a></li>`
      var cancelhtml = `<li><a class="dropdown-item" href="#" onclick="return makecancle(this);" ><font color='red'>ยกเลิกการเดินทาง</font></a></li>`
      $('.all_timelist').html(confirmhtml+cancelhtml+html);
      console.log("7day,",msg)
    });
}
function update_comment(patient_id){
  update_patient_comment(patient_id,()=>{
      alert_success("แก้ไขแล้ว กรุณา refresh เพื่อ update การแสดงผล")
  })  // predefine in preload
}
function makeconfirm(obj,slotid){
    confirm("ยืนยันการเดินทาง?")
    var testobj = $(obj).parents('td').find('.button_moveslot')
    console.log('html',testobj.html())
    var movefrom = testobj.data('movefrom')
    var postData = {
          _id:movefrom,
      }
      $.postJSON(MAINURL + "/api-backend/admin/appoint/confirmed_for_patient",postData,(result)=>{
        $('#external-event-dialog').modal("hide")
        if(result.code==200){
          refreshpage();
        }else{
          alert(result.detail)
        }
      });

    console.log("Confirm ",postData)
    return;
}
function makecancle(obj,slotid){
    confirm("ยืนยันการ 'ลบ' นัดหมาย?")
    var testobj = $(obj).parents('td').find('.button_moveslot')
    console.log('html',testobj.html())
    var movefrom = testobj.data('movefrom')
    var movepatient =testobj.data('movepatient')
    var postData = {
          patient:movepatient,
          appointment:movefrom,
      }
      var postData = {
            _id:movefrom,
        }
        $.postJSON(MAINURL + "/api-backend/admin/appoint/cancel_appoint",postData,(result)=>{
          $('#external-event-dialog').modal("hide")
          if(result.code==200){
            refreshpage();
          }else{
            alert(result.detail)
          }
        });

    return;
}
function moveslotto(obj,slotid){
  confirm("ยืนยันการย้าย ?")
  var testobj = $(obj).parents('td').find('.button_moveslot')
  console.log('html',testobj.html())
  var movefrom = testobj.data('movefrom')
  var movepatient =testobj.data('movepatient')
  var postData = {
        patient:movepatient,
        appointment:movefrom,
        from:workingslot._id,
        to:slotid
    }
    if(postData.from == postData.to){
      alert("Same TIME")
      return;
    }
  $.postJSON(MAINURL + "/api-backend/admin/appoint/move_appoint_slot",postData,(result)=>{
    $('#external-event-dialog').modal("hide")
    if(result.result){
      refreshpage();
    }else{
      alert(result.detail)
    }
  });
  console.log("moveslotto",slotid,movefrom,movepatient)
}
</script>
