<style>

  .external-event-calendar {
      border-right: 1px solid #ccc;
  }

  .external-event-task {
      color: #fff;
      padding: 10px;
      margin: 20px;
      border-radius: 8px;
      font-family: -apple-system, Segoe UI, Roboto, sans-serif;
  }

  .demo-external-event-presets.demo-wrapper,
  .demo-external-event-presets .mbsc-grid,
  .demo-external-event-presets .mbsc-row,
  .demo-external-event-presets .external-event-calendar {
      height: 100%;
  }





  .md-work-week-cont {
      position: relative;
      padding-left: 50px;
  }

  .md-work-week-avatar {
      position: absolute;
      max-height: 50px;
      max-width: 50px;
      top: 21px;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      left: 20px;
  }

  .md-work-week-name {
      font-size: 16px;
  }

  .md-work-week-title {
      font-size: 12px;
      margin-top: 5px;
  }

.md-timeline-template .mbsc-schedule-event.mbsc-ltr {
    height: auto !important;
}

.md-timeline-template-event {
    border: 1px solid transparent;
    margin: 2px 0;
}

.md-timeline-template-event-cont {
    background: rgba(255, 255, 255, .8);
    font-size: 15px;
    height: 32px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

.md-timeline-template-event-cont .mbsc-icon {
    padding: 5px;
    box-sizing: content-box;
}

.mbsc-timeline-event-start .md-timeline-template-event,
.mbsc-timeline-event-start .md-timeline-template-event-cont,
.mbsc-timeline-event-start .md-timeline-template-event-cont .mbsc-icon {
    border-top-left-radius: 20px;
    border-bottom-left-radius: 20px;
}

.mbsc-timeline-event-end .md-timeline-template-event,
.mbsc-timeline-event-end .md-timeline-template-event-cont,
.mbsc-timeline-event-end .md-timeline-template-event-cont .mbsc-icon {
    border-top-right-radius: 20px;
    border-bottom-right-radius: 20px;
}

.md-timeline-template-event-cont .mbsc-icon:before {
    color: #fff;
    font-size: 18px;
}

.md-timeline-template-time {
    margin: 0 10px;
}

.md-timeline-template-title {
    color: #666;
}

.md-timeline-template .mbsc-timeline-column,
.md-timeline-template .mbsc-timeline-header-column {
    min-width: 100px;
}

.md-timeline-template .mbsc-timeline-resource,
.md-timeline-template .mbsc-timeline-row {
    min-height: 100px;
}
  </style>
<div class="main_page mb-12" style="margin-top:120px;">

  <div class="mbsc-grid mbsc-no-padding">
      <div class="mbsc-row">
      <div class="mbsc-col-sm-12 external-event-calendar">
        <div id="xray-q" style="height:100%;"></div>

        </div>

      </div>
  </div>

</div>

<div class="container">

  <!-- <div class="row mb-1">
            <div class="col-6 col-xs-12 col-sm-12 col-md-12 col-lg-6"> -->
  <form class="form-row" style="width: 100%;" onsubmit="return pre_search();">
    <div class="form-group">
      <!-- <div class="row d-flex justify-content-center"> -->

      <div class="row d-flex justify-start">
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">

          <div class="form-group">

            <label for="ID No">Patient ID:</label>
            <input type="text" class="form-control" id="search_id" placeholder="Patient ID No">
          </div>

        </div>
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <div class="form-group">
            <label for="ID No">Appointment ID:</label>
            <input type="text" class="form-control" id="search_idno" placeholder="Appoint ID No">
          </div>

        </div>
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label for="search_status">สถานะ</label>
          <div class="form-group">
            <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_status">
              <option value="">โปรดเลือก</option>
              <option value="-1">ยกเลิก</option>
              <option value="0">รอคิว</option>
              <option value="1" selected>ได้คิว</option>
              <option value="2">ตามเวลานัด</option>
              <option value="4">พลาดคิว</option>
              <option value="5">ขาดนัด</option>
            </select>
          </div>
        </div>
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label for="search_status">เรียงข้อมูลตาม</label>
          <div class="form-group">
            <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_sort">
              <option value="" >โปรดเลือก</option>
              <option value="_id">Appointment ID</option>
              <option value="dayfirst">วันนัดเก่า มาก่อน</option>
              <option value="daylater" selected>วันนัดใหม่ มาก่อน</option>
            </select>
          </div>
        </div>
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label for="search_status">ค้นหาโดยวันที่</label>
          <input type="date" class="form-control" id="search_date" >
        </div>

        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label for="search_status">ค้นหาโดยโรงพยาบาล</label>
          <select class="form-select" aria-label="สถานะผู้ป่วย" id="search_hospital">
            <option value="" >โปรดเลือก</option>

          </select>
        </div>

        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <div class="form-group">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i>
            Search
          </button>
          </div>
        </div>


    </div>
  </form>

</div>


<!-- Modal -->
<div class="modal fade" id="external-event-dialog" tabindex="-1" aria-labelledby="modal_title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal_title">นัดหมาย <font color='green'>(กด Esc เพื่อปิดหน้านี้ได้)</font></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" >
        <label  >
            นัดหมาย Slot#   <span id="qid" > </span>
        </label>

        <label >
            เวลาเริ่ม :  <span id="t_begin" style="color:green"> </span>
        </label>

        <label >
            เวลาเริ่มสิ้นสุด:  <span id="t_end" style="color:red"> </span>
        </label>
        <span> หมายเหตุ :</span> <span id="q_comment_text"  style="color:blue"> </span> <span  class="badge rounded-pill  bg-light text-dark" onclick="update_queue_comment()" style="cursor: pointer;">comment...</span> <span id="bystaffname"></span>
        <hr>
          รายการผู้ป่วย
        <div >
          <table class="table table-striped">
            <tbody id="mobdal_body">
              <tr>
                <th> ##q-patient.showid##</th>
                <th scope="row"><img src="##q-patient.pictureUrl##" class="rounded-circle staffimage" style="max-width : 50px;padding:0px;margin:0px;" >               </th>
                <td> ##q-patient.displayName## </td>
                <td> ##q-patient.firstname## ##q-patient.lastname##</td>
                <td>##q-patient.mobileno##</td>
                <td nowrap="nowarp"> ##q-patient.address.address##
<br> <small> <span  style="color:blue">##q-patient.comment##</span> </small><span  class="badge rounded-pill  bg-light text-dark" onclick="update_comment('##q-patient.id##')" style="cursor: pointer;">comment...</span>
                  </td>
                  <td>##q-patient.address.subdistrict##</td>
                  <td>##q-patient.address.district##</td>
                <td>  ##q-patient.mobileno## (##q-patient.travelprefer## ##q-travel## ##q-selfcar##)</td>
                <td><a href="/admin/patient?id=##q-patient.id##" target="_blank"> <button type="button" class="btn btn-sm btn-secondary" >Detail </button> </a></td>
                <td nowrap="nowrap"> ##q-confirmed##
                  <button type="button" id="btn_##q-id##"  class="btn btn-sm btn-outline-warning dropdown-toggle button_moveslot" data-movefrom="##q-id##" data-movepatient="##q-patient.id##" data-bs-toggle="dropdown" aria-expanded="false" >ย้าย/ลบ/confirm </button>

                  <ul class="dropdown-menu all_timelist" aria-labelledby="Moveit">
                    <li><a class="dropdown-item" href="#" onclick="return moveslotto(this,'##slot-id##');" >##slot-startshow## - ##slot-endshow##</a></li>

                  </ul>

                </td>


              </tr>
              </tbody>
            </table>

        </div>
        <br>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4 mb-2">
  <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="pagination_bar pb-3"></div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-bordered show_startpage font-weight-light">
    <thead class="text-center">
      <tr>
        <th scope="col" class="text-secondary">Patient</th>
      <th scope="col" class="text-secondary">Appoint ID</th>

        <th scope="col" class="text-secondary">Display Name</th>
        <th scope="col" class="text-secondary">วันเวลาที่นัดหมาย</th>
        <th scope="col" class="text-secondary">สถานที่นัดหมาย</th>
        <th scope="col" class="text-secondary">รายละเอียด</th>
        <th scope="col" class="text-secondary">สถานะ</th>
        <th scope="col" class="text-secondary">การยืนยัน</th>
        <th scope="col" class="text-secondary">action</th>
        <th scope="col" class="text-secondary">สร้างโดย</th>
      </tr>
    </thead>
    <tbody id="row_appointlist" style="display:none;">
      <tr>
        <small><small>
          <td class="text-center table-middle">
            ###patient-patient.id##<BR><img src="##patient-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
          </td>
      <td class="text-center table-middle">###patient-id##</td>


        <td class="text-center table-middle" nowrap>##patient-patient.displayName##
          <br>
          ##patient-patient.firstname## ##patient-patient.lastname##
        </td>

        <td class="text-center table-middle"><span class="badge bg-primary" onclick="hilight('##patient-id##')" style="cursor: pointer;">##patient-appointtime## </span></td>
        <td class="text-center table-middle">##patient-hospital.name##</td>
        <td class="text-center table-middle" style="color:blue;">##patient-patient.comment##</td>
        <td class="text-center table-middle">##patient-status## <br>##patient-confirmed##</td>

        <td class="text-center table-middle" nowrap="nowrap">##patient-travel## <Br> ##patient-selfcar##</td>

          <td class="text-center table-middle">
            <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="go2View('appoint_patient?id=##patient-patient.id##')">จัดการนัดหมาย</button>
            <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="go2View('patient?id=##patient-patient.id##')">รายละเอียด</button>

          </td>
        <td class="text-center table-middle"># ##patient-staff##</td>
        </small></small>
      </tr>
    </tbody>
    <tbody id="show_appointlist">
      <tr>

      </tr>
    </tbody>
  </table>
</div>


<div class="modal" tabindex="-1" id="queue_comment">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ใส่หมายเหตุ สำหรับช่วงเวลานัดหมายนี้ </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><input class="form-control" id="q_comment" placeholder="หมายเหตุสำหรับ slot นี้"> </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="finish_queue_comment()" >Save changes</button>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">

  var fncsearch;
  var current_appoint;
  var current_hosp;
  var qcalendar;
  var randcolor = ["#7a5886","#9da721","#cd6957","#637e57","#50789d","#6c5d45"]
  var template_modalbody = $('#mobdal_body').html();
  var template_all_timelist = $('.all_timelist').html();
  var template_appoint_row = $('#row_appointlist').html();
  var workingslot;
  var current_patientlist;
  var ITEMSTATUS = [`<span style="color: #FFD033;">รอคิว</span>`,`<span style="color: #47CF55;">ได้คิว</span>`,`<span style="color: green;">ตามเวลานัด</span>`,`<span style="color: #9139B6;">นัดอัตโนมัติ</span>`,`<span style="color: red;">พลาดคิว</span>`,`<span style="color: black;">ขาดนัด</span>`]
  var html_obj = {search_idno:"find_id",
                  search_id:"find_patientid",
                  search_sort:"search_sort",
                  search_status:"find_status",
                  search_date: "find_date",
                  search_hospital: "search_hospital"
                }
  $(document).ready(() =>{
      // for search list
      var search_setting = {
        posturl: '/api-backend/admin/appointlist',
        paginationDIV: $('.pagination_bar'),
        pagesize: 10,
        showfunction: show_appoint_list,
        limit: 20,
        search:{}
      }
      fncsearch = ADV_search(search_setting); // Defult always search at first
      selectKiosk();
      return false;
  });

  function selectKiosk() {
    $('#search_hospital').adv_select({
      url: '/api-backend/admin/hospital/get',
      name: 'name',
      val: {},
      template: "#{{_id}}: {{name}}",
      id: '_id',
      maxshow: 10
    }, null, false);
  }


  function pre_search(){
    var searchdata ={};
    map_html_to_obj(html_obj,searchdata)
    fncsearch({  search: searchdata});
    console.log("searchdata =====================>", searchdata)
    return false;
  }
  function show_appoint_list(objdata, totalrecord,filed2show,queryobj) {
      map_obj_to_html(queryobj.search,html_obj)
      if (objdata.result && totalrecord > 0) {
        working.patient = objdata.obj;
        //console.log("OBJDATA: " + objdata.obj)



        objdata.obj.map(item => {
          // console.log(item)
          if(item.status == 1){
            if(item.confirmed){
              item.confirmed=`<span class="badge rounded-pill bg-success">Confirm</span>`
            }else{
              item.confirmed=`<span class="badge rounded-pill bg-secondary">not confirm</span>`
            }
          }else{
              item.confirmed=""
          }
          item.appointtime ? item.appointtime = moment(item.appointtime, "X").format('DD/MM/YYYY HH:mm') : "";
          item.status == -1 ? item.status = `<span style="color: #C70039;">ยกเลิก</span>`: item.status = ITEMSTATUS[item.status];
          (typeof(item.patient) == "number" || !item.patient) ? item.patient = {displayName : "-- INACTIVE USER --"} : item.patient;



        })


        var html_row = hash_replace(template_appoint_row, 'patient', objdata.obj)
        $("#show_appointlist").html(html_row);
        if(totalrecord==1){   // only 1 record
          $('.button_moveslot').show();
            console.log($('#change_appoint'))
            getdaylist(objdata.obj[0].hospital._id,objdata.obj[0]._id)
        }else{
          $('.button_moveslot').hide();
          //$('#change_appoint').hide();
        }

        // $('.show_startpage').show('slow');
      } else {
        alert("ไม่พบรายการ")
        $("#show_appointlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
      }
  }
  function refreshpage(rawdata) {
    show_hospital_list();

  }
  function load_timeslot(hospital_id){
  let payload = {
    hospital: hospital_id,
    timestart: Math.floor(new Date()/1000 - 3600*24*3),  // last 3 days
    timeend: Math.floor(new Date()/1000 + 3600*24*27)  // next 27 days
  }

  console.log(payload)

    $.postJSON(MAINURL + "/api-backend/admin/hospital/load_timeslot", payload, (msg) => {
        console.log("GOT TIMESLOT",msg)
        if(Array.isArray(msg.detail )){
            console.log("  msg.detail",  msg.detail);
            msg.detail.map((ev)=>{

                      ev.start = new Date(ev.timestart*1000);
                      ev.end = new Date(ev.timeend*1000);
                      ev.title = ev.queuecount ;
                      if(ev.queuecount ==0){
                        ev.title ="-"
                        ev.color = "#eeeeee"
                      }
                      ev.resource =  ev.hospital;
                      delete ev.timeend;
                      delete ev.timestart;
                      delete ev.id;
            })
            current_appoint = msg.detail;
            set_event(current_hosp,msg.detail)
        }else{
          alert("Data Not found ")
        }

    });
  }
  function show_hospital_list() {

     $.postJSON(MAINURL + "/api-backend/admin/HospitalList",{page:1,limit:100},(msg )=>{
       var allhosp = []
       if(!msg.obj){
         alert("Server Busy");
         return;
       }
       objdata = msg.obj;
       totalrecord = msg.totalrecord
       if (objdata.result && totalrecord > 0) {

         working.patient = objdata.obj;
         objdata.obj.map(item => {
           allhosp.push(item._id);
           item.title = item.name;
           item.id= item._id;
           item.color = randcolor[ item._id % 5]
           // console.log(item)
         });
         current_hosp = objdata.obj;
         load_timeslot(allhosp);
         return;
       }
     })

  }

  function set_event(obj,all_event){
        mobiscroll.setOptions({
        locale: mobiscroll.localeTh,
        theme: 'ios',
        themeVariant: 'light',
    });
    var now  = new Date()
  $(function () {
      var begin = new Date().getDay();
      begin = (begin -1) %7
      console.log("DAY ",new Date().getDate())
      qcalendar = $('#xray-q').mobiscroll().eventcalendar({
        view: {
            timeline: {
                type: 'week',
                startDay: begin,
                endDay: (begin+6) %7,
                timeCellStep: 60  ,
                timeLabelStep: 60
            }
        },invalid: [{
            start: '00:00',
            end: '06:00',
            recurring: {
                repeat: 'daily',
            }
        }, {
            start: '22:00',
            end: '23:59',
            recurring: {
                repeat: 'daily',
            }
        }],
//         responsive: {
//     xsmall: {
//         view: {
//             calendar: {
//                 type: 'week'
//             },
//             agenda: {
//                 type: 'day'
//             }
//         }
//     },
//     custom: { // Custom breakpoint
//         breakpoint: 600,
//         view: {
//             calendar: {
//                 labels: true
//             }
//         }
//     }
// },
          renderResource: function (resource) {
              return '<div class="md-work-week-cont">' +
                  '<div class="md-work-week-name" align="center">'+ resource.title + '</div>' +
        //          '<div class="md-work-week-title">' + resource.title + '</div>' +
                  //'<div class="md-work-week-avatar" ><a href="/admin/vehicle_list?find_id='+resource.id+'" target="_blank">#'+ resource.id +"</a>:</div>" +
                  //  `<div><small>unsave</small></div>`+
                  '</div>';
          },

          clickToCreate: false,
          dragToCreate: false,
          dragToResize: false,
          dragToMove: false,
          externalDrop: false,

          onEventCreated: function (args) {
              // $(".appoint_id" +args.event._id).hide("slow");
              // var res = getobjbyid(current_car,args.event.resource)
              // args.event.color = res.color;
              // console.log("Created",args)
          },
          onEventClick: function (args) {
                    // editingobj = args.event
                     console.log("click",args.event)
                     fillDialog(args);

                 },
          onEventCreateFailed: function () {
              alert( 'Can\'t create event on this date');
          },
          onEventUpdateFailed: function () {
              alert( 'Can\'t add event on this date');
          },
          data: all_event ,
          resources:obj
      });
    //  qcalendar.setEvents(all_event);
    //  console.log("finish",all_event)


  });
  return false;
}

function fillDialog(args) {
  var res = getobjbyid(current_hosp,args.event.resource)

  var q = args.event;
  workingslot = q;
  $.postJSON(MAINURL + "/api-backend/admin/appoint/loadslot", {_id:q._id}, (msg) => {
        if(msg){
          if(msg.bystaffname) $('#bystaffname').html(`${msg.bystaffname}`)
          else $('#bystaffname').html(``)
          if(msg.comment) $('#q_comment_text').html(`${msg.comment}`)
          else $('#q_comment_text').html(``)
        }
  });

  var postdata = {
    search:{qid:q._id}
  }
  $.postJSON(MAINURL + "/api-backend/admin/appoin_slot_tlist", postdata, (msg) => {
      console.log("gotBack",msg)
      current_patientlist =[]
      console.log("current_patientlist",current_patientlist)
      msg.obj.obj.map((o)=>{
        if(o.confirmed){
          if(o.confirmed == "staff"){
              o.confirmed=`<span class="badge rounded-pill bg-primary">Staff Confirm</span>`
          }else{
              o.confirmed=`<span class="badge rounded-pill bg-success">Confirm</span>`
          }

        }else{
          o.confirmed=`<span class="badge rounded-pill bg-secondary">not confirm</span>`
        }
        o.patient.showid = o.patient._id
        current_patientlist.push(o.patient)
        if(o.patient.color=="RED"){
          o.patient.showid = `<span class="badge bg-danger">${o.patient._id}</span>`
        }
        if(o.patient.color=="GREEN"){
          o.patient.showid = `<span class="badge bg-success">${o.patient._id}</span>`
        }
        if(o.patient.color=="YELLOW"){
          o.patient.showid = `<span class="badge bg-warning">${o.patient._id}</span>`
        }

      });

      var html = hash_replace(template_modalbody,"q",msg.obj.obj);
        $('#mobdal_body').html(html)

        $('#qid').html(q._id);
        $('#t_begin').html(moment(q.start).format("DD-MM-YY HH:mm"));
        $('#t_end').html(moment(q.end).format("DD-MM-YY HH:mm"));
        $('#totalq').html(`${q._id} จำนวน ${q.title}`)
        console.log("Beforemodal",q)
        msg.obj.obj.map(item => {
          console.log(item.status == 2)
          if(item.status == 2) {
            $('#btn_'+item._id).hide();
            $('#btn_'+item._id).replaceWith($('<span class="pr-2 text-primary"><i class="fas fa-check-circle"></i> มาตามนัดแล้ว</span>'));
          }else if(item.status == 4 || item.status == 5){
            $('#btn_'+item._id).hide();
            $('#btn_'+item._id).replaceWith($(ITEMSTATUS[item.status]))
          }
        })

        getdaylist(q.hospital,q._id);
        working_queue_id = q._id;

        $('#external-event-dialog').modal("show")
  });
   // dialog.open();
}

function getdaylist(hospitalid,main_id){
    console.log("CHECK",hospitalid)

    $.postJSON(MAINURL + "/api-backend/admin/appoint/get7daysslot", {hospitalid:hospitalid}, (msg) => {
        msg.map((l)=>{
            l.startshow = moment(l.timestart,'X').format("D/MM HH:mm")
            l.endshow = moment(l.timeend,'X').format("HH:mm")
            if(l._id == main_id){
                l.startshow="<font color='red'>ปัจจุบัน"
                l.endshow =" เวลานี้ </font>"
            }
        })

        var html = hash_replace(template_all_timelist,"slot",msg);
      var confirmhtml=`<li><a class="dropdown-item" href="#" onclick="return makeconfirm(this);" ><font color='green'>Confirm การเดินทาง </font></a></li>`
      var cancelhtml = `<li><a class="dropdown-item" href="#" onclick="return makecancle(this);" ><font color='red'>ยกเลิกการเดินทาง</font></a></li>`
      $('.all_timelist').html(confirmhtml+cancelhtml+html);
      console.log("7day,",msg)
    });
}
function update_comment(patient_id){
  update_patient_comment(patient_id,()=>{
      alert_success("แก้ไขแล้ว กรุณา refresh เพื่อ update การแสดงผล")
  })  // predefine in preload
}
function makeconfirm(obj,slotid){
    confirm("ยืนยันการเดินทาง?")
    var testobj = $(obj).parents('td').find('.button_moveslot')
    console.log('html',testobj.html())
    var movefrom = testobj.data('movefrom')
    var postData = {
          _id:movefrom,
      }
      $.postJSON(MAINURL + "/api-backend/admin/appoint/confirmed_for_patient",postData,(result)=>{
        $('#external-event-dialog').modal("hide")
        if(result.code==200){
          refreshpage();
        }else{
          alert(result.detail)
        }
      });

    console.log("Confirm ",postData)
    return;
}
function makecancle(obj,slotid){
    confirm("ยืนยันการ 'ลบ' นัดหมาย?")
    var testobj = $(obj).parents('td').find('.button_moveslot')
    console.log('html',testobj.html())
    var movefrom = testobj.data('movefrom')
    var movepatient =testobj.data('movepatient')
    var postData = {
          patient:movepatient,
          appointment:movefrom,
      }
      var postData = {
            _id:movefrom,
        }
        $.postJSON(MAINURL + "/api-backend/admin/appoint/cancel_appoint",postData,(result)=>{
          $('#external-event-dialog').modal("hide")
          if(result.code==200){
            refreshpage();
          }else{
            alert(result.detail)
          }
        });

    return;
}
function moveslotto(obj,slotid){
  confirm("ยืนยันการย้าย ?")
  var testobj = $(obj).parents('td').find('.button_moveslot')
  console.log('html',testobj.html())
  var movefrom = testobj.data('movefrom')
  var movepatient =testobj.data('movepatient')
  var postData = {
        patient:movepatient,
        appointment:movefrom,
        from:workingslot._id,
        to:slotid
    }
    if(postData.from == postData.to){
      alert("Same TIME")
      return;
    }
  $.postJSON(MAINURL + "/api-backend/admin/appoint/move_appoint_slot",postData,(result)=>{
    $('#external-event-dialog').modal("hide")
    if(result.result){
      refreshpage();
    }else{
      alert(result.detail)
    }
  });
  console.log("moveslotto",slotid,movefrom,movepatient)
}
function hilight(id){
  //alert("ID"+id)
  for(var x=0; x < current_appoint.length;x++){
    for(var y=0; y < current_appoint[x].queue.length; y++){
      //  console.log("checking",current_appoint[x].queue[y].appointment , id);
        if(current_appoint[x].queue[y] && current_appoint[x].queue[y].appointment == id){
            console.log("FOUND",current_appoint[x].queue[y])
            // With selector
            $('#xray-q').mobiscroll('navigate', new Date(current_appoint[x].timestart*1000));
            var args = {
                event:current_appoint[x]
            }
            fillDialog(args)
            return ;
        }
    }
  }
  alert("ไม่พบในปฏิทิน")
}
var working_queue_id;
function update_queue_comment(){
  $("#queue_comment").modal('show')
  $('#q_comment').val($('#q_comment_text').html() || "")
}
function finish_queue_comment(){
  $("#queue_comment").modal('hide')
  var q = $('#q_comment').val() || "";
  var data = {
    queue_id : working_queue_id,
    comment: q
  }
  console.log("SENGING",data)
  $.postJSON(MAINURL + '/api-backend/admin/update_q_comment',data,(msg)=>{
      // update Qcomment

        $('#q_comment_text').html(q)
  })

}
</script>
