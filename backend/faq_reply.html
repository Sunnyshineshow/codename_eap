<div class="main_page mb-5" style="margin-top:120px;">
    <div class="p-2 mr-5 ml-5">
      <div class="container">

        <div class="row mt-5">
            <div class="col-md-6">

            </div>
            <h3 class="p-0 m-0 mb-3"><b>Thread</b></h3>

        <div class="card shadow-none bg-light" style="max-width: 100% !important;">
            <div class="card-body" style="text-align: left;">
            <div id="topic_data" style="display: none;">
                <h4>##FAQ-topic##</h4>
              <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
              <div class="card-body">
                <p>##FAQ-showimage##</p>
                <p>##FAQ-content##</p>
            </div>
            <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
            <img src="##FAQ-by.pictureUrl##" alt="User Image" width="2%" height="auto" class="rounded-pill text-center max-auto"> <label>##FAQ-by.displayName##   </label>

            <label> (##FAQ-createdate##)</label>
            </div>

            <div id="topic_data_showing">

            </div>

            </div>
          </div>
        </div>
        <br>
        <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
        <br>

        <div id="reply_data" style="display: none;">
          <div class="card shadow-none bg-light" style="max-width: 100% !important;">
            <div class="card-body" style="text-align: left;">
              <div class="card-body">
                <p>##REPLY-showimage##</p>
                <p>##REPLY-message##</p>
            </div>
            <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
            <img src="##REPLY-by.pictureUrl##" alt="User Image" width="2%" height="auto" class="rounded-pill text-center max-auto"> <label>##REPLY-by.displayName##   </label>
            <label> (##REPLY-replytime##)</label>
            </div>
          </div>
          <br><br>
        </div>

        <div id="reply_showing">

        </div>

        <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
        <br>
        <div class="card shadow-none bg-light" style="max-width: 100% !important;">
            <div class="card-body" style="text-align: left;">

                <h4>ตอบกลับ</h4>
              <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
              <div class="card-body">
                  <div class="form-group col-md-6">
                    <textarea class="form-control" type="text" id="reply_box" row="4" cols="50" style="font-size: 13px;"></textarea>
                  </div>
            </div>
            <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 10px;margin-bottom:20px;"></div>
            <div class="col-5 mr-auto ml-auto" id="imageuoload">

              </div>
            <button type="button" name="button" class="btn btn-sm btn-outline-secondary mt-2 position-relative" onclick="click_to_reply()">
                <i class="fas fa-paper-plane"></i> ตอบกลับ </button>

            </div>
          </div>
      </div>
    </div>
</div>

<script>

  function refreshpage()
  {
    $('#imageuoload').loadcached('/backend/uploadimage.html', function() {
      console.log("Load image cached")
    });
    var id = getParameterByName('id', window.location.search);
    var template_topic = $('#topic_data').html()
    var template_reply = $('#reply_data').html()

    $.postJSON(MAINURL + "/api-backend/admin/faq/list_individual", {_id: id}, (msg) =>
    {
            msg.detail.createdate =moment(msg.detail.createdate, "X").fromNow()
            if(msg.detail.image_topic){
              msg.detail.showimage = `<img src='/cdn/image/${msg.detail.image_topic}' >`
            }

        let tmp;

        tmp = hash_replace(template_topic, "FAQ", msg.detail)
          $("#topic_data_showing").html(tmp)

          if(Array.isArray(msg.detail.reply)){
              msg.detail.reply.map((r)=>{
                r.replytime = moment(r.replytime, "X").fromNow()
                if(r.replyimage){
                  r.showimage = `<img src='/cdn/image/${r.replyimage}' >`
                }

              });

              tmp = hash_replace(template_reply, "REPLY", msg.detail.reply)
              $("#reply_showing").html(tmp)
          }
    })

  }


    function click_to_reply()
    {

      if (!$("#reply_box").val())
      {
        alert("กรุณากรอกข้อความ")
        return null;
      }

      console.log($("#reply_box").val())

      var id = getParameterByName('id', window.location.search);
      let reply = $("#reply_box").val().replace(/\r\n|\r|\n/g,"<br />")

      var postdata = {topicid: id,reply: reply};
      if(!blobdata_v2){
        return post_without_image(postdata);
      }
      doUploadImage_v2(blobdata_v2, '/api-backend/admin/faq/reply', postdata, function(res) {
        if (res.result)
        {
          alert_success("บันทึกแล้ว")
          document.getElementById("reply_box").value = ""
          return refreshpage()
        }
        else
        {
          return alert("เกิดข้อผิดพลาดในระบบ โปรดลองใหม่อีกครั้ง")
        }
      })

    }
    function post_without_image(postdata){
      $.postJSON(MAINURL + "/api-backend/admin/faq/reply",postdata,(msg) =>
      {
        if (msg.result)
        {
          alert_success("บันทึกแล้ว")
          return refreshpage()
        }
        else
        {
          return alert("เกิดข้อผิดพลาดในระบบ โปรดลองใหม่อีกครั้ง")
        }
      })
    }
</script>
