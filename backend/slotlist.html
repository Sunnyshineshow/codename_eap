<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">
      <h3><b>Appointment by Time Slot</b></h3>
    </div>
      <!--
      <div class="row d-flex justify-start">
        <div class="col-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 mt-2">
          <label id="HospitalName">##hospital-name##</label>
        </div>
      </div>
      -->

      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 30px;margin-bottom:30px;"></div>



      <div class="table-responsive">
        <table class="table table-bordered show_startpage font-weight-light">
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">Profile</th>
              <th scope="col" class="text-secondary">เลขที่นัดหมาย</th>
              <th scope="col" class="text-secondary">Display Name</th>
              <th scope="col" class="text-secondary">วันเวลาที่นัดหมาย</th>
              <th scope="col" class="text-secondary">สถานที่นัดหมาย</th>
              <th scope="col" class="text-secondary">รายละเอียด</th>
              <th scope="col" class="text-secondary">สถานะ</th>
              <th scope="col" class="text-secondary">การยืนยัน</th>
              <th scope="col" class="text-secondary">Action</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
              <td class="text-center table-middle">
                <img src="##patient-patient.pictureUrl##" style="max-width:50px;" class="rounded-circle">
              </td>
              <td class="text-center table-middle"># ##patient-id##</td>
              <td class="text-center table-middle">##patient-patient.displayName##
                <br>
                ##patient-patient.firstname## ##patient-patient.lastname##
              </td>
              <td class="text-center table-middle">##patient-appointtime##</td>
              <td class="text-center table-middle">##patient-hospital.name##</td>
              <td class="text-center table-middle">##patient-comment##</td>
              <td class="text-center table-middle">##patient-status##</td>
              <td class="text-center table-middle">##patient-confirmed##</td>
              <td class="text-center table-middle">
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="appointment('##patient-patient.id##')">จัดการนัดหมาย</button>
                <button type="button" name="button" class="btn btn-sm btn-outline-secondary" onclick="view_symptom('##patient-patient.id##')">รายละเอียด</button>
              </td>
            </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
  <script type="text/javascript">
    var template_patient_row = $('#row_patientlist').html();
    var template_dropdown = $('#SearchHospitalList').html();
    var searchobj = {};
    var fncsearch;
    var template_hospital_name = $('#HospitalName').html();
    var date = new Date()
    var current_date = Math.floor(new Date(date.getFullYear(),date.getMonth(),date.getDate()) / 1000)
    var shown_date = new Date(current_date * 1000)

    var html_row_2;
    var hospitalname

    function refreshpage(rawdata,clearsearch) {

      console.log("GLOBAL_USER",GLOBAL_USER)
      console.log("searching /api-backend/admin/appoin_slot_tlist")

      var search_setting = {
        posturl: '/api-backend/admin/appoin_slot_tlist',
        paginationDIV: $('.pagination_bar'),
        pagesize: 10,
        showfunction: show_patient_list,
        limit: 100,
        search: {}
      }
        var qid = getParameterByName('qid', window.location.search);
        search_setting.search.qid = qid;

      var pagenumber = getParameterByName('page', window.location.search);
      if (pagenumber > 1) {
        search_setting.page = pagenumber;
      }

      // console.log('SEARCH ', search_setting);
      fncsearch = ADV_search(search_setting,clearsearch); // Defult always search at first
      return false;
    }

    function show_patient_list(objdata, totalrecord) {
      console.log('objdata', objdata);
      if (objdata.result && totalrecord > 0) {
        working.patient = objdata.obj;
        console.log("OBJDATA: " + objdata.obj)

        var ITEMSTATUS = [`<span style="color: #FFD033;">รอคิว</span>`,`<span style="color: #47CF55;">ได้คิว</span>`,`<span style="color: green;">ตามเวลานัด</span>`,`<span style="color: #9139B6;">นัดอัตโนมัติ</span>`,`<span style="color: red;">พลาดคิว</span>`,`<span style="color: black;">ขาดนัด</span>`]

        objdata.obj.map(item => {
          console.log(item)
          item.appointtime ? item.appointtime = moment(item.appointtime, "X").format('DD/MM/YYYY HH:mm') : "";
          item.status == -1 ? item.status = `<span style="color: #C70039;">ยกเลิก</span>`: item.status = ITEMSTATUS[item.status];
          (typeof(item.patient) == "number" || !item.patient) ? item.patient = {displayName : "-- INACTIVE USER --"} : item.patient;

        })


        var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
        $("#show_patientlist").html(html_row);

        // $('.show_startpage').show('slow');
      } else {
        $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
      }
    }

    function view_symptom(patient_id) {

      go2View("patient?id=" + patient_id)

    }

    function appointment(patient_id) {

      go2View("appoint_patient?id=" + patient_id)

    }

    function settingpatient(dataid) {
      working.active_patientid = dataid;
      go2View('patient-edit');
    }

    function OpenSearchBox() {
      var x = document.getElementById("SearchHospitalList_showing");
      if (x.style.display === "none")
        x.style.display = "block";
      else
        x.style.display = "none";
    }

    function SearchbyDate(Start,End)
    {
      console.log("SerachingDate Test")
      console.log(Start)
      console.log(End)

      var Half = Start.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var StartTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      var Half = End.split("T")
      var SplitDate = Half[0].split("-")
      var SplitTime = Half[1].split(":")
      var EndTime = Math.floor(new Date(SplitDate[0],SplitDate[1]-1,SplitDate[2],SplitTime[0],SplitTime[1]) /1000)

      console.log(StartTime)
      console.log(EndTime)

      var payload ={
        starttime : StartTime,
        endtime : EndTime
      }

      console.log(payload)
      $.postJSON(MAINURL + "/api-backend/admin/appoint/searching_date",payload,(msg) => {
        console.log("TestOutput")
        console.log(msg)
      })
    }

    function changeDate(quantity) {
      current_date += 24 * 3600 * (quantity)
      shown_date = new Date(current_date * 1000)
      pre_search()
    }
  </script>
