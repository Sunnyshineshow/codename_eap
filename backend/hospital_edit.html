<div class="main_page mb-5" style="margin-top:120px;">
  <div class="container">

    <h3 style="color: #0d6efd;"><b>Affiliation Information</b></h3>
    <div class="card bg-light">
      <div class="card-body">
        <div id="hospital_information">
          <p class="p-0 m-0"><strong>ID:</strong> ##HOSPITAL-id##</p>
          <p class="p-0 m-0"><strong>ชื่อ:</strong> ##HOSPITAL-name##</p>
          <p class="p-0 m-0"><strong>ที่อยู่:</strong> ##HOSPITAL-address##</p>
          <p class="p-0 m-0"><strong>เบอร์โทรฉุกเฉิน:</strong> ##HOSPITAL-hotline##</p>
        </div>
      </div>
    </div>

    <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:30px;"></div>

    <div class="row">
        <h3 style="color: #0d6efd;"><b>Affiliation Worktime Information</b></h3>
        <div class="card">
          <div class="card-body">
            <div id="hospital_worktime">
              <strong>Freetime Slot :</strong>
              <!-- <p><span style="color:red " font-size=15px></span></p> -->
                <input  class="form-control" type="input" id="Freetime_Slot" value=60 oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                <p class="p-0 m-0"><small style="color:red">* กรุณากรอกเป็นหน่วยนาที (Default 60)</small></p>
              <br />
              <strong>Start Date: </strong>
                <input class="form-control" type="date" id="OnDate" name="appt">
              <br />
              <strong>Starttime :</strong>
                <input class="form-control" type="time" id="Startime" name="appt">

              <br />
              <strong>Endtime :</strong>
                <input class="form-control" type="time" id="Endtime" name="appt">
              <br />
              <strong>Multiple Day : (จำนวนวันที่ให้บริการ นับจาก Start Date)</strong>
                <input class="form-control" type="number" id="multiple_day" name="appt" placeholder= "นัดหลายวันยังไม่พร้อมใช้งาน" value=1 >
              <br />
              <button type="submit" class="btn btn-primary" text-align="center" onclick="Submittime()" width="10" height="10">Submit</button>
            </div>
          </div>
        </div>
    </div>

    <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:30px;"></div>

    <div class="row">
      <h3 style="color: #0d6efd;"><b>Edit Affiliation</b></h3>

        <div id="AddData">
          <div class="card mt-5 bg-light">
            <div class="card-body">
              <form class="form-group">
                <div class="form-group col-md-6">
                  <label for="txt">ชื่อสถานพยาบาล</label>
                  <input class="form-control" id="edit_Hospitalname" type="text" placeholder="" value=""
                    style="font-size: 13px;" />
                </div>
                <div class="form-group col-md-6">
                  <label for="exampleInputPassword1">ที่อยู่</label>
                  <input class="form-control" id="edit_Address" type="text" placeholder="" value="" maxlength="60" style="font-size: 13px;" />
                </div>
                <div class="form-group col-md-6">
                  <label for="exampleInputPassword1">สายด่วน</label>
                  <input class="form-control" mbsc-input id="edit_Tel" type="text" placeholder="" value="" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="10" style="font-size: 13px;" />
                </div>
                <div class="form-group col-md-6">
                  <label for="exampleInputPassword1">ความจุผู้ป่วย</label>
                  <input class="form-control" mbsc-input id="edit_capacity" type="text" placeholder="" value="" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="10" style="font-size: 13px;" />
                </div>

                <div class="form-group col-md-6">
                  <label for="exampleInputPassword1">พิกัดสถานพยาบาล</label>
                  <div class="row">
                    <div class="form-group col-md-6 mt-2">
                      <input class="form-control" mbsc-input id="edit_latitude" type="text" placeholder="เส้นรุ้ง / latitude" value="" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="20"
                        style="font-size: 13px;" />
                    </div>
                    <div class="form-group col-md-6 mt-2">
                      <input class="form-control" mbsc-input id="edit_longtitude" type="text" placeholder="เส้นแวง / longtitude" value="" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" maxlength="20"
                        style="font-size: 13px;" />
                    </div>
                  </div>
                </div>

                <br>

                <input type="button" value="แก้ไข"  class="btn btn-primary" onclick="edit_hospital()">
      </div>
  </div>
        </div>

    </div>
  </div>
</div>

    <!-- table here -->
    <!--
    <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:30px;"></div>

    <div>
      <b>
        <h3 style="color: #0d6efd;" id="showing_current_date">Current Date will be display here</h3>
      </b>
      <br>
      <div class="btn-group" style="text-align: left;">
        <button class="btn btn-outline-primary" onclick="changeDate(-1)">&#171; Previous Day</button>
        <button class="btn btn-outline-primary" onclick="changeDate(1)">Next Day &#187;</button>
      </div>
      <br>
      <br>
      <div class="table-responsive">

        <table class="table table-bordered show_startpage font-weight-light">
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">Timeslot No.</th>
              <th scope="col" class="text-secondary">Interval</th>
              <th scope="col" class="text-secondary">Current Queue</th>
            </tr>
          </thead>
          <tbody id="row_timeslot" style="display:none;">
            <tr>
              <td class="text-center table-middle">##TIMESLOT-id##</td>
              <td class="text-center table-middle">##TIMESLOT-timestart## - ##TIMESLOT-timeend##</td>
              <td class="text-center table-middle">##TIMESLOT-queuecount##</td>
            </tr>
          </tbody>
          <tbody id="show_timeslot">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>

    </div> -->
  </div>
  <div class="container">

  </div>

</div>


<script>
  var template_row_timeslot = $('#row_timeslot').html();
  var HospitalData
  var hospital_id = getParameterByName('id', window.location.search);
  var date = new Date()
  var current_date = Math.floor(new Date(date.getFullYear(), date.getMonth(), date.getDate()) / 1000)

  function refreshpage() {

    console.log("GLOBAL_USER",GLOBAL_USER)
        if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1)){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }

    //Object for table
    $.postJSON(MAINURL + "/api-backend/admin/hospital_edit/get", {
      _id: hospital_id
    }, (ObjectData) => {
      console.log(ObjectData);
      if (ObjectData != null) {
        console.log("Pass!")
        HospitalData = ObjectData
        var hospitalhtml_row = hash_replace($("#hospital_information").html(), 'HOSPITAL', ObjectData)
        $("#hospital_information").html(hospitalhtml_row);
      } else {
        $("#hospital_information").html("Data not found");
      }
    })
  }


  //กัน Commit
  function Submittime() {

    if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("SITEADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1 && GLOBAL_USER.role.indexOf("XRAY") == -1 && GLOBAL_USER.role.indexOf("VOLUNTEER") == -1 )){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }

    console.log("OK!")
    console.log($('#OnDate').val())

    //Change to date()

    console.log()
    var DateSpliter = $('#OnDate').val().split("-")
    var TimeStartSpliter =  $('#Startime').val().split(":")
    var TimeEndSpliter =  $('#Endtime').val().split(":")
    var multiple_day = $("#multiple_day").val()
    var current_date = Math.floor(new Date(date.getFullYear(), date.getMonth(), date.getDate()))

    console.log(DateSpliter)
    console.log(TimeStartSpliter)
    console.log(TimeEndSpliter)

    if (!DateSpliter)
    {
      return alert("กรุณากรอกวันที่")
    }

    console.log(Math.floor(new Date(DateSpliter) / 1000) + " vs. " + current_date)

    if (Math.floor(new Date(DateSpliter)) <= current_date)
    {
      return alert("กรุณากรอกวันที่เริ่มให้ถูกต้อง")
    }

    if (!TimeStartSpliter)
    {
      return alert("กรุณากรอกเวลาเริ่ม")
    }

    if (!TimeEndSpliter)
    {
      return alert("กรุณากรอกเวลาสิ้นสุด")
    }

    var Start = Math.floor(new Date(DateSpliter[0],DateSpliter[1]-1,DateSpliter[2],TimeStartSpliter[0],TimeStartSpliter[1]) /1000)
    var End = Math.floor(new Date(DateSpliter[0],DateSpliter[1]-1,DateSpliter[2],TimeEndSpliter[0],TimeEndSpliter[1]) /1000)

    console.log($('#Startime').val() + " + " + $('#Endtime').val())
    //console.log(Math.floor(new Date(DateSpliter[0].getFullYear,DateSpliter[1].getMonth,DateSpliter[2].getDate,TimeStartSpliter[0].getHours,TimeStartSpliter[1].getMinutes)) / 1000 )
    console.log(End)

    if (Start >= End)
    {
      return alert("โปรดกรอกเวลาที่ถูกต้อง")
    }
    else if(!($('#Freetime_Slot').val())|| !($('#OnDate').val()) || !($('#Startime').val()) || !($('#Endtime').val()) )
    {
      return alert("กรุณากรอกข้อมูลเวลาให้ครบก่อน")
    }
    else if (TimeStartSpliter[0] > TimeEndSpliter[0])
    {
      return alert("ไม่สามารถกรอกเวลาข้ามวันได้")
    }

    var new_timeslot = {
      timeslot: parseInt($('#Freetime_Slot').val()),
      hospital: HospitalData._id, // Hospital ID (ดึงจากหน้าเว็บ)
      queuemax: HospitalData.xraycapacity, // xraycapacity (ดึงจากหน้าเว็บ)
      begindate :Math.floor(new Date(DateSpliter) / 1000),
      startdate: Start,
      enddate: End,
      totaldays:Number(multiple_day)
    }
    console.log(new_timeslot)
    console.log(new Date(new_timeslot.startdate * 1000))
    console.log(new Date(new_timeslot.enddate * 1000))

    // alert("ขออภัย ปิดปรับปรุงชั่วคราว")
    alert("กำลังอัปเดตค่าเข้าระบบ โปรดตรวจสอบข้อมูลที่หน้าจัดคิวสถานพยาบาล")
    $.postJSON(MAINURL + "/api-backend/admin/hospital/new_timeslot", new_timeslot, (ObjectData) => {
      console.log("Sending: " + new_timeslot);
      console.log(ObjectData);
      if (ObjectData != null) {
        alert_success("อัปเดตตารางเวลาเรียบร้อยแล้ว")
      }
      })
    }

  function edit_hospital()
  {
    if(!Array.isArray(GLOBAL_USER.role) || (GLOBAL_USER.role.indexOf("SUPERADMIN") == -1 && GLOBAL_USER.role.indexOf("DEVELOPER") == -1)){
          return alert("คุณไม่ได้รับสิทธิให้เข้าดูในส่วนนี้ หากคิดว่านี่คือข้อผิดพลาด โปรดติดต่อทีมพัฒนา")
        }
        
    var hospital_id = getParameterByName('id', window.location.search);
    let updates = {}

    if ($('#edit_Hospitalname').val())
    {
      Object.assign(updates,{name:$('#edit_Hospitalname').val()})
    }

    if ($('#edit_Address').val())
    {
      Object.assign(updates,{address:$('#edit_Address').val()})
    }

    if ($('#edit_Tel').val())
    {
      Object.assign(updates,{hotline:$('#edit_Tel').val()})
    }

    if ($('#edit_capacity').val())
    {
      Object.assign(updates,{xraycapacity:$('#edit_capacity').val()})
    }

    if($('#edit_latitude').val() == "" && $('#edit_longtitude').val() != "")
    {
      return alert("โปรดกรอกทั้งเส้นรุ้งและเส้นแวง")
    }

    if($('#edit_latitude').val() != "" && $('#edit_longtitude').val() == "")
    {
      return alert("โปรดกรอกทั้งเส้นรุ้งและเส้นแวง")
    }

    if($('#edit_latitude').val() != "" && $('#edit_longtitude').val() != "")
    {
      Object.assign(updates,{location:
        {
          type: "Point",
          coordinates: [parseFloat($('#edit_longtitude').val()), parseFloat($('#edit_latitude').val())]
        }})
    }

    console.log(Object.keys(updates).length)
    if (Object.keys(updates).length == 0)
    {
      return alert("ไม่มีค่าใดๆ ที่แก้ไข")
    }

    let payload =
    {
      _id: hospital_id,
      updates: updates
    }

    $.postJSON(MAINURL + "/api-backend/admin/hospital/hospital_edit",payload,(msg) =>
    {
      if (msg.code == 200)
      {
        alert_success("ทำการแก้ไขแล้ว")
        return refreshpage()
      }
      else
      {
        return alert("เกิดข้อผิดพลาดในระบบ โปรดลองอีกครั้ง")
      }
    })

  }
</script>
