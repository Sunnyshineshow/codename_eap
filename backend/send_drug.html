<div class="main_page mb-5" style="margin-top:120px;">
  <div class="p-2 mr-5 ml-5">
    <div class="container">

      <h3 class="p-0 m-0 mb-3"><b>Send drug</b></h3>
      <br>


      <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
        <div class="row">
          <div class="col-md-4">
            <label for="search_status">ค้นหาโดยวันที่</label>
            <input type="date" class="form-control" id="search_date">
          </div>
          <div class="col-md-4">
            <label for="search_status">ค้นหาโดยศูนย์ X-ray</label>
            <select class="form-control form-control-sm tag-select" id="search_hospital" name="hospital[]"
              multiple="multiple">
            </select>

          </div>
          <div class="col-md-2">
            <div class="form-group">
              <button type="button" class="btn btn-primary border-0 mt-4" onclick="filterSendDrug()">
                <i class="fas fa-search"></i>
                Search
              </button>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <button type="button" class="btn btn-success border-0 mt-4" onclick="exportExcel()">
                <i class="far fa-file-excel"></i>
                Export Excel
              </button>
            </div>
          </div>
        </div>
      </div>
      <div style="width: 100%;height: 1px;border-bottom: 1px dashed #ddd;margin-top: 50px;margin-bottom:30px;"></div>
      <br>
      <!-- แบ่งหน้า -->
      <div class="row">
        <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="pagination_bar pb-3"></div>
        </div>
      </div>
      <!-- // แบ่งหน้า -->

      <div class="table-responsive mt-2">
        <table class="table table-bordered table-hover show_startpage font-weight-light">
          <thead class="text-center">
            <tr>
              <th scope="col" class="text-secondary">No</th>
              <th scope="col" class="text-secondary">Date</th>
              <th scope="col" class="text-secondary">Display Name</th>
              <th scope="col" class="text-secondary">Citizen ID</th>
              <th scope="col" class="text-secondary">Tel</th>
              <th scope="col" class="text-secondary">O2,pulse</th>
              <th scope="col" class="text-secondary">favipilavia Dose</th>
              <th scope="col" class="text-secondary">Site</th>
              <th scope="col" class="text-secondary">จำนวน xray</th>
              <th scope="col" class="text-secondary">รหัสผู้ปฎิบัติ</th>
            </tr>
          </thead>
          <tbody id="row_patientlist" style="display:none;">
            <tr>
              <td class="text-center table-middle"># ##patient-id##</td>
              <td class="text-center table-middle">##patient-createdate##</td>
              <td class="text-center table-middle">##patient-patient.firstname## ##patient-patient.lastname## </td>
              <td class="text-center table-middle">##patient-patient.idcard##</td>
              <td class="text-center table-middle">##patient-patient.mobileno##</td>
              <td class="text-center table-middle">##patient-patient.init_symptoms.spo_room_air##</td>
              <td class="text-center table-middle">##patient-medicine.medic_favipilavia##</td>
              <td class="text-center table-middle">##patient-hospital.name##</td>
              <td class="text-center table-middle">##patient-countxray##</td>
              <td class="text-center table-middle">##patient-bystaff##</td>
            </tr>
          </tbody>
          <tbody id="show_patientlist">
            <tr>

            </tr>
          </tbody>
        </table>
      </div>
      <!-- // end table -->
    </div>
  </div>
</div>
<script type="text/javascript">
  var template_patient_row = $('#row_patientlist').html();
  var fncsearch;
  $('#search_hospital').adv_select({
    url: '/api-backend/admin/hospital/get',
    name: 'name',
    val: {},
    template: "#{{_id}}: {{name}}",
    id: '_id',
    maxshow: 10
  }, null, true);

  function pre_search() {
    var searchdata = {}

    var searchdata = {};
    fncsearch({ search: searchdata });
    return false;
  }

  function refreshpage(rawdata) {
    console.log("GLOBAL_USER", GLOBAL_USER)

    var search_setting = {
      posturl: '/api-backend/admin/treatment_medic_form',
      paginationDIV: $('.pagination_bar'),
      pagesize: 10,
      showfunction: show_patient_list,
      limit: 20,
      search: { date: Math.floor(new Date() / 1000) }
    }

    var pagenumber = getParameterByName('page', window.location.search);
    if (pagenumber > 1) {
      search_setting.page = pagenumber;
    }
    // console.log('SEARCH ', search_setting);
    fncsearch = ADV_search(search_setting); // Defult always search at first
    return false;
  }

  function show_patient_list(objdata, totalrecord) {
    console.log("Check!")
    console.log(objdata.obj)
    if (objdata.result && totalrecord > 0) {
      working.patient = objdata.obj;

      console.log("Object Income here!")
      // console.log(objdata.obj)

      objdata.obj.map(item => {
        item.createdate ? item.createdate = moment(item.createdate, "X").format("DD/MM/YYYY") : "";

        if (item.medicine.medic_favipilavia == 64) {
          item.medicine.medic_favipilavia = '<span style="color: #ff0000;">' + "น้อยกว่า 90 kg กรัม" + '</span>'
        }
        else if (item.medicine.medic_favipilavia == 50) {
          item.medicine.medic_favipilavia = '<span style="color: #15cf30;">' + "มากกว่า 90 kg กรัม" + '</span>'
        }

        if (item.patient.init_symptoms && item.patient.init_symptoms.spo_room_air == -1) {
          item.patient.init_symptoms.spo_room_air = '<span style="color: #ff0000;">' + "ไม่ทราบ" + '</span>'
        }

      })

      var html_row = hash_replace(template_patient_row, 'patient', objdata.obj)
      $("#show_patientlist").html(html_row);
      // $('.show_startpage').show('slow');

    } else {
      $("#show_patientlist").html('<tr><td colspan="100%" class="text-center"><span class="text-sub">Data not found</span></td></tr>');
    }
  }


  function date_diff(date1) {
    let dateOnly = new Date()
    console.log(dateOnly)

    let date2 = Date.parse(new Date(dateOnly.getFullYear(), dateOnly.getMonth(), dateOnly.getDate()))
    console.log(new Date(date2))

    return parseInt((date2 - date1) / 86400000)
  }

  function OpenSearchBox(id) {
    if (document.getElementById(id).style.display == "none") {
      document.getElementById(id).style.display = "block"
    }
    else {
      document.getElementById(id).style.display = "none"
    }

  }

  function filterSendDrug() {
    var searchdata = {};
    var getDate = $('#search_date').val();

    if(getDate) {
      searchdata.date = moment(getDate).unix();
    } else {
      searchdata.date = Math.floor(new Date() / 1000);
    }
    if($('#search_hospital').val().length > 0) {
      searchdata.hospital = $('#search_hospital').val().map(numStr => parseInt(numStr));
    }
    // console.log(searchdata)
    fncsearch({
      search: searchdata
    })
    return false;
  }
  var allhospitalsearch=[]
  function getHospitalname(id){
    allhospitalsearch.map((h)=>{
      if(h._id == id){
        return h.name;
      }
    })
  }
  function exportExcel() {
    var postData = {};
    var getDate = $('#search_date').val();
    if(getDate) {
      postData.date = moment(getDate).unix();
    } else {
      postData.date = Math.floor(new Date() / 1000);
    }
    if($('#search_hospital').val().length > 0) {
      postData.hospital = $('#search_hospital').val().map(numStr => parseInt(numStr));
    }

    $.postJSON('/api-backend/admin/export/send_drug/excel', postData, async(res) => {
       console.log("Excel",res)
      if(res.result && res.data.length > 0) {
        var detail = {
          hospitalName: "",
          size50: 0,
          size64: 0
        }
        // if(res.hospital.length > 0) {
        //   allhospitalsearch= res.hospital;
        //   for(let i = 0; i < res.hospital.length; i++) {
        //     if(res.hospital[i].name) {
        //       if(i > 0) {
        //         if(res.hospital[i+1] !== undefined) {
        //           detail.hospitalName += res.hospital[i].name + ", ";
        //         } else {
        //           detail.hospitalName += res.hospital[i].name;
        //         }
        //       }
        //       detail.hospitalName += res.hospital[i].name;
        //     }
        //   }
        // } else {
        //   detail.hospitalName = "ทุกจุด x-ray";
        // }
        res.data.map(item => {
          if(item.medicine) {
            if(item.medicine.medic_favipilavia == "50A" || item.medicine.medic_favipilavia == 50) {
              detail.size50 += 1;
            }
            if(item.medicine.medic_favipilavia == 64) {
              detail.size64 += 1;
            }
          }
        })

        var content = await createExportHeaderDetail(detail);
        content += await createExportHeader();
        content += await createExportRows(res.data);
        var nowdate = new Date();
        var day_ex = nowdate.getDate();
        var month_ex = nowdate.getMonth() + 1;
        var year_ex = nowdate.getFullYear();
        var a = document.createElement('a');
        a.href = 'data:application/octet-stream;charset=utf-8,' + encodeURIComponent(content);
        a.download = 'เบิกยา Favi ' + day_ex + '-' + month_ex + '-' + year_ex + '.xls';
        document.body.append(a);
        a.click();
        a.remove();
      } else {
        alert('ไม่พบข้อมูล');
      }
    })

  }

  function createExportHeaderDetail(detail) {
    // console.log(detail)
    var headerRow = "",
    headerRow = `<html xmlns:o="urn:schemas-microsoft-com:office:office'
    xmlns:x="urn:schemas-microsoft-com:office:excel"
    xmlns="http://www.w3.org/TR/REC-html40">
    <head>
    <meta http-equiv=Content-Type content="text/xls; charset=UTF-8">
    <meta name=ProgId content=Excel.Sheet>
    <table border="1" class="table table-bordered">
    <thead class="text-center">
      <tr>
        <th class="text-secondary" colspan="3">จำนวนยอดยาที่ยกมา</th>
        <th class="text-secondary" colspan="2">ถุง</th>
        <th class="text-secondary">จุด</th>
        <th class="text-secondary" colspan="9"> </th>
      </tr>
      <tr>
        <th class="text-secondary">ขนาด</th>
        <th class="text-secondary">50 เม็ด</th>
        <th class="text-secondary">${detail.size50}</th>
        <th class="text-secondary" colspan="2">ถุง</th>
        <th class="text-secondary" colspan="10">รายละเอียดของผู้ป่วยที่เข้าเกณฑ์ได้รับยา Favipiravir</th>
      </tr>
      <tr>
        <th class="text-secondary">ขนาด</th>
        <th class="text-secondary">64 เม็ด</th>
        <th class="text-secondary">${detail.size64}</th>
        <th class="text-secondary" colspan="2">ถุง</th>
        <th class="text-secondary" colspan="10"></th>
      </tr>
    </thead>`;
    return headerRow;
  }

  function createExportHeader() {
    var headerRow = "",
    newLine = "\t";
    headerRow = `<thead class="text-center">
      <tr>
        <th rowspan="3" class="text-secondary">No</th>
        <th rowspan="3" class="text-secondary">วันที่</th>
        <th rowspan="3" class="text-secondary">ชื่อ - นามสกุล</th>
        <th rowspan="3" class="text-secondary">เลขบัตรประชาชน</th>
        <th rowspan="3" class="text-secondary">เบอร์โทร</th>
        <th rowspan="3" class="text-secondary">O2,pulse</th>
        <th rowspan="1" colspan="3" class="text-secondary">จำนวนยา</th>
        <th rowspan="1" colspan="3" class="text-secondary">ไม่ได้รับยา</th>
        <th rowspan="1" colspan="2" class="text-secondary">X-ray</th>
        <th rowspan="3" class="text-secondary">สถานที่</th>
      </tr>
      <tr>
        <th class="text-secondary">${"<"} 90 kg.</th>
        <th class="text-secondary">>90 kg.</th>
        <th rowspan="2" class="text-secondary">ยาเพิ่ม(เม็ด)</th>
        <th rowspan="2" class="text-secondary">เคยได้แล้ว</th>
        <th rowspan="2" class="text-secondary">ตั้งครรภ์</th>
        <th rowspan="2" class="text-secondary">มีโรคตับ</th>
        <th rowspan="2" class="text-secondary">ครั้งที่</th>
        <th rowspan="2" class="text-secondary">นัดครั้งเดียว</th>
      </tr>
      <tr>
        <th class="text-secondary">50 เม็ด</th>
        <th class="text-secondary">64 เม็ด</th>
      </tr>
    </thead>`;
    return headerRow;
  }

  function createExportRows(dataSource) {
    // console.log("Body",dataSource)
    var content = '<tbody class="text-dark text-center">';
    // console.log(dataSource);
    for (var i = 0; i < dataSource.length; i++) {
      let index = i+1;
      let kg = {
        over90: "",
        less90: "",
        adding:""
      }
      if(dataSource[i].medicine) {
        if(dataSource[i].medicine.medic_favipilavia == "50A" || dataSource[i].medicine.medic_favipilavia == 50) {
          kg.less90 = "50";
        }else  if(dataSource[i].medicine.medic_favipilavia == 64) {
          kg.over90 = "64";
        }else{
          kg.adding = dataSource[i].medicine.medic_favipilavia
        }
      }
      if(dataSource[i].patient && dataSource[i].patient.init_symptoms && dataSource[i].patient.init_symptoms.spo_room_air == -1) {
        dataSource[i].patient.init_symptoms.spo_room_air = "-"
      }
      content += `<tbody>
      <tr>
        <td class="text-center">${index}</td>
        <td class="text-center">${moment(dataSource[i].createdate, 'X').format('DD/MM/YYYY')}</td>
        <td class="text-center">${dataSource[i].patient.firstname || ""} ${dataSource[i].patient.lastname || ""}</td>
        <td class="text-center" datatype="string"  dtype="string">${dataSource[i].patient.idcard || ""}</td>
        <td class="text-center">${dataSource[i].patient.mobileno.toString() || ""}</td>
        <td class="text-center">${dataSource[i].patient.init_symptoms.spo_room_air || ""}</td>
        <td class="text-center">${kg.less90}</td>
        <td class="text-center">${kg.over90}</td>
        <td class="text-center">${kg.adding}</td>
        <td class="text-center"></td>
        <td class="text-center"></td>
        <td class="text-center"></td>
        <td class="text-center">${dataSource[i].countxray || ""}</td>
        <td class="text-center"></td>
        <td class="text-center">${dataSource[i].hospital.name}</td>
      </tr>`;
    }
    content += `</tbody>
    </table>
    </html>`;
    return content;
  }

</script>
